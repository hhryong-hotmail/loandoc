# 고객별 수신 데이터 관리 업무 처리 흐름도

## 1. 개인정보 조회 프로세스

```mermaid
flowchart TD
    A[사용자: workerInfo.html 접속] --> B[페이지 초기화<br/>initializePage]
    B --> C[localStorage에서<br/>login-id 조회]
    C --> D{login-id 존재?}
    D -->|없음| E[로그인 페이지로 리다이렉트]
    D -->|있음| F[login-id를 userId 필드에 설정]
    
    F --> G[GET /server/api/foreign_worker_master<br/>?login-id={loginId}<br/>ForeignWorkerMasterServlet.doGet]
    G --> H[서버: userId 추출<br/>세션 → 쿼리 파라미터]
    
    H --> I[DB 조회<br/>SELECT FROM foreign_worker_master<br/>WHERE user_id = ?]
    I --> J{데이터 존재?}
    
    J -->|있음| K[200 OK<br/>ok: true, found: true<br/>data: 개인정보 객체]
    J -->|없음| L[200 OK<br/>ok: true, found: false]
    
    K --> M[클라이언트: applyUserProfile<br/>폼 필드에 데이터 채움]
    L --> N[빈 폼 표시<br/>신규 사용자]
    
    M --> O[약관 리스트 로드<br/>loadTermsList]
    N --> O
    
    O --> P[GET /server/api/documents<br/>?group_name=론닥 서비스 이용약관]
    P --> Q{약관 로드 성공?}
    Q -->|실패| R[오류 메시지 표시]
    Q -->|성공| S[개인정보 관련 약관 필터링]
    
    S --> T[약관 리스트 표시<br/>[필수] prefix 포함]
    T --> U[전체 동의 체크박스 설정]
    U --> V[화면 표시 완료]
```

## 2. 개인정보 저장/수정 프로세스

```mermaid
flowchart TD
    A[사용자: 저장 버튼 클릭] --> B[userId 확인]
    B --> C{userId 존재?}
    C -->|없음| D[오류 메시지:<br/>로그인된 사용자 정보가 없습니다]
    C -->|있음| E[폼 검증<br/>validateForm]
    
    E --> F{검증 통과?}
    F -->|실패| G[오류 메시지 표시:<br/>- 이름 필수<br/>- 여권번호 필수<br/>- 전화번호 필수<br/>- 주소 필수<br/>- 현재 회사 필수<br/>- 생년월일 형식 YYYY-MM-DD<br/>- 입국일자 형식 YYYY-MM-DD]
    F -->|성공| H[전체 약관 동의 확인]
    
    H --> I{전체 동의 체크?}
    I -->|아니오| J[경고: 약관 전체 동의가 필요합니다<br/>약관 섹션으로 스크롤]
    I -->|예| K[폼 데이터 수집]
    
    K --> L[payload 구성:<br/>- user_id<br/>- name<br/>- nationality<br/>- passport_number<br/>- birth_date<br/>- entry_date<br/>- phone_number<br/>- current_company<br/>- email]
    
    L --> M[POST /server/api/foreign_worker_master<br/>ForeignWorkerMasterServlet.doPost]
    M --> N[서버: userId 추출<br/>세션 → 쿼리 파라미터 → request body]
    
    N --> O{req-yn = yes?}
    O -->|예| P[대출 신청 처리<br/>UPDATE foreign_worker_master<br/>SET req_date = CURRENT_TIMESTAMP<br/>WHERE user_id = ?]
    P --> Q[200 OK<br/>대출 신청이 완료되었습니다]
    
    O -->|아니오| R[DB 조회<br/>SELECT COUNT FROM foreign_worker_master<br/>WHERE user_id = ?]
    R --> S{기존 데이터 존재?}
    
    S -->|예| T[UPDATE 실행<br/>UPDATE foreign_worker_master SET<br/>name, nationality, passport_number,<br/>birth_date, entry_date, phone_number,<br/>current_company, email<br/>WHERE user_id = ?]
    S -->|아니오| U[INSERT 실행<br/>INSERT INTO foreign_worker_master<br/>VALUES ...]
    
    T --> V{UPDATE 성공?}
    U --> W{INSERT 성공?}
    
    V -->|성공| X[200 OK<br/>action: update<br/>message: 정보가 성공적으로 업데이트되었습니다<br/>data: 저장된 데이터]
    V -->|실패| Y{SQL 오류 타입?}
    W -->|성공| Z[200 OK<br/>action: insert<br/>message: 정보가 성공적으로 저장되었습니다<br/>data: 저장된 데이터]
    W -->|실패| Y
    
    Y --> AA{SQL State 23505<br/>중복 키?}
    AA -->|예| AB{여권번호 중복?}
    AB -->|예| AC[409 Conflict<br/>오류: 중복된 여권번호입니다]
    AB -->|아니오| AD[409 Conflict<br/>오류: 중복된 사용자 ID입니다]
    
    AA -->|아니오| AE{SQL State 23502<br/>NOT NULL 위반?}
    AE -->|예| AF[400 Bad Request<br/>오류: 필수 입력 항목이 누락되었습니다]
    AE -->|아니오| AG[500 Internal Server Error<br/>데이터베이스 오류]
    
    X --> AH[클라이언트: 성공 메시지 표시<br/>저장된 데이터를 폼에 반영]
    Z --> AH
    AC --> AI[클라이언트: 오류 메시지 표시<br/>여권번호 필드에 포커스]
    AD --> AJ[클라이언트: 오류 메시지 표시]
    AF --> AJ
    AG --> AJ
```

## 3. 폼 검증 상세 프로세스

```mermaid
flowchart TD
    A[validateForm 시작] --> B[이름 필드 검증]
    B --> C{이름 입력됨?}
    C -->|아니오| D[오류: 이름을 입력하세요]
    C -->|예| E[여권번호 필드 검증]
    
    E --> F{여권번호 입력됨?}
    F -->|아니오| G[오류: 여권번호를 입력하세요]
    F -->|예| H[필수 필드 검증<br/>phone, address,<br/>home_address, current_company]
    
    H --> I{모든 필수 필드 입력?}
    I -->|아니오| J[오류: 해당 항목은 필수입니다]
    I -->|예| K[날짜 필드 검증<br/>birth, entry]
    
    K --> L{생년월일 입력?}
    L -->|아니오| M[오류: 생년월일 항목은 필수입니다]
    L -->|예| N{YYYY-MM-DD 형식?}
    
    N -->|아니오| O[오류: 날짜 형식이 올바르지 않습니다]
    N -->|예| P{유효한 날짜?}
    P -->|아니오| Q[오류: 유효한 날짜가 아닙니다]
    P -->|예| R[입국일자 검증]
    
    R --> S{입국일자 입력?}
    S -->|아니오| T[오류: 입국일자 항목은 필수입니다]
    S -->|예| U{YYYY-MM-DD 형식?}
    
    U -->|아니오| V[오류: 날짜 형식이 올바르지 않습니다]
    U -->|예| W{유효한 날짜?}
    W -->|아니오| X[오류: 유효한 날짜가 아닙니다]
    W -->|예| Y[검증 통과<br/>ok: true]
    
    D --> Z[검증 실패<br/>ok: false]
    G --> Z
    J --> Z
    M --> Z
    O --> Z
    Q --> Z
    T --> Z
    V --> Z
    X --> Z
```

## 4. 약관 동의 관리 프로세스

```mermaid
flowchart TD
    A[약관 리스트 로드<br/>loadTermsList] --> B[GET /server/api/documents<br/>?group_name=론닥 서비스 이용약관]
    B --> C{약관 로드 성공?}
    C -->|실패| D[오류 메시지 표시]
    C -->|성공| E[개인정보 관련 약관 필터링<br/>title에 '개인정보' 포함]
    
    E --> F{개인정보 약관 존재?}
    F -->|없음| G[메시지: 개인정보 관련 약관이 없습니다]
    F -->|있음| H[약관 리스트 생성<br/>체크박스 + 약관 제목]
    
    H --> I[약관 제목 클릭 이벤트<br/>showTermsDetail]
    I --> J[GET /server/api/documents/content<br/>?title={약관제목}]
    J --> K{약관 내용 조회 성공?}
    K -->|실패| L[오류: 약관 내용 조회 실패]
    K -->|성공| M[약관 모달 표시<br/>약관 내용 표시]
    
    M --> N[약관 확인 버튼 클릭]
    N --> O[해당 약관 체크박스 체크]
    O --> P[전체 동의 상태 업데이트<br/>checkIndividualTermChange]
    
    P --> Q{모든 약관 체크?}
    Q -->|예| R[전체 동의 체크박스 자동 체크]
    Q -->|아니오| S[전체 동의 체크박스 해제]
    
    R --> T[전체 동의 체크박스 클릭]
    S --> T
    T --> U{전체 동의 체크?}
    U -->|예| V[모든 개별 약관 체크박스 체크]
    U -->|아니오| W[모든 개별 약관 체크박스 해제]
    
    V --> X[저장 시 전체 동의 확인]
    W --> X
```

## 5. 데이터 저장 결정 로직

```mermaid
flowchart TD
    A[서버: POST 요청 수신] --> B[req-yn 파라미터 확인]
    B --> C{req-yn = yes?}
    C -->|예| D[대출 신청 처리<br/>req_date 업데이트]
    C -->|아니오| E[userId 추출<br/>세션 → 쿼리 → body]
    
    E --> F{userId 존재?}
    F -->|없음| G[400 Bad Request<br/>user_id is required]
    F -->|있음| H[DB 조회<br/>SELECT COUNT FROM foreign_worker_master<br/>WHERE user_id = ?]
    
    H --> I{기존 데이터 존재?}
    I -->|예| J[UPDATE 실행<br/>기존 레코드 업데이트]
    I -->|아니오| K[INSERT 실행<br/>신규 레코드 생성]
    
    J --> L{UPDATE 성공?}
    K --> M{INSERT 성공?}
    
    L -->|성공| N[action: update<br/>200 OK]
    L -->|실패| O[SQL 오류 처리]
    M -->|성공| P[action: insert<br/>200 OK]
    M -->|실패| O
    
    O --> Q{SQL State 확인}
    Q -->|23505| R[409 Conflict<br/>중복 키 오류]
    Q -->|23502| S[400 Bad Request<br/>NOT NULL 위반]
    Q -->|기타| T[500 Internal Server Error<br/>데이터베이스 오류]
    
    N --> U[저장된 데이터 반환]
    P --> U
    R --> V[오류 메시지 반환]
    S --> V
    T --> V
```

## 6. 전체 데이터 흐름

```mermaid
flowchart TD
    A[사용자 접속] --> B[workerInfo.html]
    B --> C[localStorage login-id 조회]
    C --> D[개인정보 조회<br/>GET /api/foreign_worker_master]
    D --> E[약관 리스트 조회<br/>GET /api/documents]
    
    E --> F[사용자 정보 입력/수정]
    F --> G[약관 동의]
    G --> H[저장 버튼 클릭]
    
    H --> I[폼 검증]
    I --> J{검증 통과?}
    J -->|실패| K[오류 메시지]
    J -->|성공| L[약관 동의 확인]
    
    L --> M{전체 동의?}
    M -->|아니오| N[경고 메시지]
    M -->|예| O[POST /api/foreign_worker_master]
    
    O --> P[DB 저장/수정]
    P --> Q{저장 성공?}
    Q -->|실패| R[오류 처리]
    Q -->|성공| S[성공 메시지<br/>데이터 반영]
    
    S --> T[화면 업데이트]
    R --> U[오류 메시지 표시]
```

## 7. 주요 컴포넌트 및 역할

### 7.1 클라이언트 측 (HTML/JavaScript)

| 파일 | 역할 |
|------|------|
| `workerInfo.html` | 개인정보 입력/수정 폼, 약관 동의, 데이터 검증, 서버 통신 |

### 7.2 서버 측 (Java Servlet)

| 서블릿 | 엔드포인트 | 역할 |
|--------|-----------|------|
| `ForeignWorkerMasterServlet` | `GET /server/api/foreign_worker_master` | 개인정보 조회 |
| `ForeignWorkerMasterServlet` | `POST /server/api/foreign_worker_master` | 개인정보 저장/수정, 대출 신청 처리 |
| `GroupDetailsServlet` | `GET /server/api/documents/groups/{group_name}` | 약관 그룹별 제목 조회 |
| `DocumentContentServlet` | `GET /server/api/documents/content?title={title}` | 약관 내용 조회 |

### 7.3 데이터베이스

| 테이블 | 주요 컬럼 | 역할 |
|--------|---------|------|
| `foreign_worker_master` | `user_id` (PK), `name`, `nationality`, `passport_number` (UNIQUE), `birth_date`, `entry_date`, `phone_number`, `current_company`, `email`, `req_date` | 외국인 근로자 개인정보 저장 |
| `documents` | `group_name`, `title`, `content`, `select_option` | 약관 문서 저장 |

## 8. 개인정보 필드 상세

### 8.1 필수 필드

| 필드명 | DB 컬럼 | 검증 규칙 |
|--------|--------|----------|
| 이름 | `name` | 필수 입력, 공백 불가 |
| 여권번호 | `passport_number` | 필수 입력, UNIQUE 제약 |
| 생년월일 | `birth_date` | 필수 입력, YYYY-MM-DD 형식, 유효한 날짜 |
| 입국일자 | `entry_date` | 필수 입력, YYYY-MM-DD 형식, 유효한 날짜 |
| 전화번호 | `phone_number` | 필수 입력, NOT NULL |
| 주소 | `address` | 필수 입력, NOT NULL |
| 현재 회사 | `current_company` | 필수 입력, NOT NULL |

### 8.2 선택 필드

| 필드명 | DB 컬럼 | 검증 규칙 |
|--------|--------|----------|
| 국적 | `nationality` | 선택 입력 |
| 이메일 | `email` | 선택 입력 |

## 9. 에러 처리

| HTTP 상태 코드 | 상황 | 메시지 |
|---------------|------|--------|
| 400 | 필수 필드 누락 | "user_id is required" / "필수 입력 항목이 누락되었습니다" |
| 400 | 날짜 형식 오류 | "날짜 형식이 올바르지 않습니다 (YYYY-MM-DD)" |
| 401 | 인증 실패 | "Not authenticated" |
| 409 | 중복 키 오류 | "중복된 여권번호입니다" / "중복된 사용자 ID입니다" |
| 500 | 서버 내부 오류 | "데이터베이스 오류" |

## 10. 특수 기능

### 10.1 대출 신청 처리

- **요청 파라미터**: `req-yn=yes`, `login-id={userId}`
- **처리**: `req_date`를 현재 일시로 업데이트
- **용도**: 대출 신청 시점 기록

### 10.2 약관 동의 관리

- **필터링**: "론닥 서비스 이용약관" 그룹에서 "개인정보" 포함 약관만 표시
- **필수 약관**: `select_option`에 "필수" 포함된 약관
- **전체 동의**: 모든 개별 약관 동의 시 자동 체크
- **저장 전 확인**: 저장 시 전체 동의 필수

### 10.3 데이터 저장 전략

- **기존 데이터 존재 시**: UPDATE 실행 (user_id 기준)
- **신규 데이터**: INSERT 실행
- **중복 방지**: passport_number UNIQUE 제약으로 중복 방지

## 11. 데이터 검증 규칙

### 11.1 클라이언트 검증

1. **필수 필드 검증**: 이름, 여권번호, 전화번호, 주소, 현재 회사
2. **날짜 형식 검증**: YYYY-MM-DD 형식
3. **날짜 유효성 검증**: 실제 존재하는 날짜인지 확인
4. **약관 동의 검증**: 전체 약관 동의 필수

### 11.2 서버 검증

1. **userId 필수**: 세션 또는 요청 파라미터에서 추출
2. **DB 제약 조건**: NOT NULL, UNIQUE 제약 확인
3. **SQL 오류 처리**: SQL State에 따른 적절한 오류 메시지 반환

## 12. 보안 고려사항

1. **인증 확인**: 세션 또는 login-id를 통한 사용자 확인
2. **데이터 무결성**: DB 제약 조건을 통한 데이터 무결성 보장
3. **중복 방지**: passport_number UNIQUE 제약으로 중복 등록 방지
4. **약관 동의**: 개인정보 처리 전 약관 동의 필수
5. **에러 메시지**: 민감한 정보 노출 방지



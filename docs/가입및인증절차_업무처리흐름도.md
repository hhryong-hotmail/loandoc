# 가입 및 인증 절차 업무 처리 흐름도

## 1. 회원가입 프로세스

```mermaid
flowchart TD
    A[사용자: signup.html 접속] --> B[아이디/비밀번호 입력]
    B --> C{클라이언트 검증}
    C -->|아이디 규칙 위반| D[오류 메시지 표시<br/>영문자로 시작, 4-50자,<br/>영문/숫자/._-만 허용]
    C -->|비밀번호 8자 미만| E[오류 메시지 표시<br/>비밀번호는 최소 8자 이상]
    C -->|검증 통과| F[POST /server/api/auth/register<br/>RegisterServlet 호출]
    
    F --> G{서버 검증}
    G -->|ID null/empty| H[400 Bad Request<br/>아이디를 입력하세요]
    G -->|비밀번호 8자 미만| I[400 Bad Request<br/>비밀번호는 최소 8자 이상]
    G -->|검증 통과| J[DB 연결 시도]
    
    J --> K{DB 연결 성공?}
    K -->|실패| L{파일 폴백 활성화?}
    L -->|비활성화| M[503 Service Unavailable<br/>DB 연결 불가]
    L -->|활성화| N[users.json 파일 확인]
    N --> O{이미 존재하는 ID?}
    O -->|예| P[409 Conflict<br/>이미 존재하는 ID]
    O -->|아니오| Q[bcrypt 해시 생성<br/>cost=12]
    Q --> R[users.json에 저장]
    R --> S[201 Created<br/>회원가입 성공]
    
    K -->|성공| T[user_account 테이블 조회]
    T --> U{이미 존재하는 ID?}
    U -->|예| V[409 Conflict<br/>이미 존재하는 ID]
    U -->|아니오| W[bcrypt 해시 생성<br/>cost=12]
    W --> X[INSERT INTO user_account<br/>user_id, password]
    X --> Y{INSERT 성공?}
    Y -->|실패| Z[500 Internal Server Error]
    Y -->|성공| S
    
    S --> AA[localStorage에 저장<br/>login-id: 회원가입한 ID<br/>login-access-time: 현재 시간]
    AA --> AB[자동 로그인 시도<br/>POST /server/api/auth/login]
    AB --> AC{로그인 성공?}
    AC -->|실패| AD[오류 메시지 표시]
    AC -->|성공| AE[workerInfo.html로 이동]
```

## 2. 로그인 프로세스

```mermaid
flowchart TD
    A[사용자: login.html 접속] --> B[아이디/비밀번호 입력]
    B --> C[개인정보 버튼 클릭]
    C --> D{입력값 검증}
    D -->|ID 또는 비밀번호 없음| E[오류 메시지 표시<br/>아이디와 비밀번호를 입력하세요]
    D -->|검증 통과| F[POST /server/api/auth/login<br/>LoginServlet 호출]
    
    F --> G{서버 검증}
    G -->|ID 또는 비밀번호 없음| H[400 Bad Request<br/>아이디와 비밀번호를 입력하세요]
    G -->|검증 통과| I[DB 연결 설정<br/>환경변수 → web.xml → db.properties → 기본값]
    
    I --> J[PostgreSQL JDBC 드라이버 로드]
    J --> K[DB 연결 시도]
    K --> L{연결 성공?}
    L -->|실패| M[500 Internal Server Error<br/>DB 연결 실패]
    
    L -->|성공| N[SELECT user_id, password<br/>FROM user_account<br/>WHERE user_id = ?]
    N --> O{사용자 존재?}
    O -->|없음| P[401 Unauthorized<br/>아이디 또는 비밀번호가 올바르지 않습니다]
    
    O -->|존재| Q[저장된 bcrypt 해시 조회]
    Q --> R[bcrypt.verify<br/>입력 비밀번호 vs 저장된 해시]
    R --> S{비밀번호 일치?}
    S -->|불일치| P
    S -->|일치| T[HttpSession 생성]
    
    T --> U[session.setAttribute<br/>userId, userName]
    U --> V[session.setMaxInactiveInterval<br/>3600초 = 1시간]
    V --> W[200 OK<br/>ok: true, userId, userName]
    
    W --> X[localStorage에 저장<br/>login-id: 로그인한 ID<br/>login-access-time: 현재 시간]
    X --> Y[workerInfo.html로 이동]
    
    P --> Z[오류 메시지 표시]
    M --> Z
```

## 3. 세션 관리 프로세스

### 3.1 세션 확인

```mermaid
flowchart TD
    A[GET /server/api/auth/session<br/>SessionServlet.checkSession] --> B[req.getSession false]
    B --> C{세션 존재?}
    C -->|없음| D[ok: true<br/>authenticated: false]
    C -->|있음| E{session.getAttribute<br/>userId 존재?}
    E -->|없음| D
    E -->|있음| F[ok: true<br/>authenticated: true<br/>userId, userName 반환]
```

### 3.2 세션 확인 (CheckSessionServlet)

```mermaid
flowchart TD
    A[GET /server/api/auth/check-session<br/>CheckSessionServlet] --> B[req.getSession false]
    B --> C{세션 존재?}
    C -->|없음| D[401 Unauthorized<br/>ok: false<br/>로그인이 필요합니다]
    C -->|있음| E{session.getAttribute<br/>userId 존재?}
    E -->|없음| D
    E -->|있음| F[200 OK<br/>ok: true<br/>userId 반환]
```

### 3.3 로그아웃

```mermaid
flowchart TD
    A[POST /server/api/auth/logout<br/>SessionServlet.logout] --> B[req.getSession false]
    B --> C{세션 존재?}
    C -->|없음| D[ok: true<br/>message: 로그아웃 되었습니다]
    C -->|있음| E[session.invalidate]
    E --> D
```

## 4. 개인정보 입력 프로세스

```mermaid
flowchart TD
    A[사용자: workerInfo.html 접속] --> B[localStorage에서<br/>login-id 조회]
    B --> C{login-id 존재?}
    C -->|없음| D[로그인 페이지로 리다이렉트<br/>또는 오류 메시지]
    C -->|있음| E[GET /server/api/worker/info<br/>login-id로 foreign_worker_master 조회]
    
    E --> F{사용자 정보 존재?}
    F -->|없음| G[빈 폼 표시<br/>신규 사용자]
    F -->|있음| H[기존 정보를 폼에 채움]
    
    G --> I[사용자 정보 입력/수정]
    H --> I
    
    I --> J[저장 버튼 클릭]
    J --> K[POST /server/api/worker/info<br/>foreign_worker_master 저장/업데이트]
    K --> L{저장 성공?}
    L -->|실패| M[오류 메시지 표시]
    L -->|성공| N[성공 메시지 표시<br/>정보 저장 완료]
```

## 5. 전체 인증 흐름 통합도

```mermaid
flowchart TD
    Start([시작]) --> Check{기존 계정?}
    
    Check -->|없음| Signup[회원가입 프로세스]
    Check -->|있음| Login[로그인 프로세스]
    
    Signup --> Register[RegisterServlet<br/>DB에 계정 생성]
    Register --> AutoLogin[자동 로그인]
    AutoLogin --> Session[세션 생성]
    
    Login --> Auth[LoginServlet<br/>비밀번호 검증]
    Auth --> Session
    
    Session --> WorkerInfo[workerInfo.html<br/>개인정보 입력]
    WorkerInfo --> LoadData[localStorage login-id로<br/>사용자 정보 조회]
    LoadData --> Display[정보 표시/수정]
    
    Display --> Save[정보 저장]
    Save --> End([완료])
    
    Session -.->|세션 확인| CheckSession[CheckSessionServlet<br/>SessionServlet]
    CheckSession -.->|로그아웃| Logout[SessionServlet.logout]
    Logout --> Start
```

## 6. 주요 컴포넌트 및 역할

### 6.1 클라이언트 측 (HTML/JavaScript)

| 파일 | 역할 |
|------|------|
| `signup.html` | 회원가입 폼, 아이디/비밀번호 검증, RegisterServlet 호출, localStorage 저장 |
| `login.html` | 로그인 폼, LoginServlet 호출, localStorage 저장, workerInfo.html 이동 |
| `workerInfo.html` | localStorage의 login-id로 사용자 정보 조회 및 표시, 정보 저장 |

### 6.2 서버 측 (Java Servlet)

| 서블릿 | 엔드포인트 | 역할 |
|--------|-----------|------|
| `RegisterServlet` | `POST /server/api/auth/register` | 회원가입 처리, bcrypt 해시 생성, DB 저장 |
| `LoginServlet` | `POST /server/api/auth/login` | 로그인 처리, bcrypt 검증, 세션 생성 |
| `SessionServlet` | `GET /server/api/auth/session`<br/>`POST /server/api/auth/logout` | 세션 확인, 로그아웃 |
| `CheckSessionServlet` | `GET /server/api/auth/check-session` | 세션 상태 확인 (401 반환) |

### 6.3 데이터베이스

| 테이블 | 컬럼 | 역할 |
|--------|------|------|
| `user_account` | `user_id` (PK), `password` (bcrypt 해시), `created_at` | 사용자 계정 정보, 인증 정보 저장 |
| `foreign_worker_master` | `login_id` (FK), 기타 개인정보 필드 | 외국인 근로자 개인정보 저장 |

## 7. 보안 고려사항

1. **비밀번호 해싱**: bcrypt 사용 (cost=12)
2. **세션 관리**: HttpSession 사용, 1시간 만료
3. **클라이언트 저장**: localStorage에 login-id만 저장 (비밀번호 저장 안 함)
4. **입력 검증**: 클라이언트 및 서버 양쪽에서 검증
5. **SQL Injection 방지**: PreparedStatement 사용
6. **에러 메시지**: 민감한 정보 노출 방지

## 8. 에러 처리

| HTTP 상태 코드 | 상황 | 메시지 |
|---------------|------|--------|
| 400 | 입력값 누락/검증 실패 | "아이디를 입력하세요" / "비밀번호는 최소 8자 이상" |
| 401 | 인증 실패 | "아이디 또는 비밀번호가 올바르지 않습니다" |
| 409 | 중복 ID | "이미 존재하는 ID입니다" |
| 500 | 서버 내부 오류 | "서버 내부 오류(데이터베이스)" |
| 503 | DB 연결 불가 | "데이터베이스에 연결할 수 없습니다" |

## 9. 데이터 흐름

```
회원가입:
signup.html → RegisterServlet → PostgreSQL (user_account) → localStorage → 자동 로그인 → workerInfo.html

로그인:
login.html → LoginServlet → PostgreSQL (user_account) → HttpSession → localStorage → workerInfo.html

개인정보 조회:
workerInfo.html → localStorage (login-id) → WorkerInfoServlet → PostgreSQL (foreign_worker_master) → 화면 표시
```


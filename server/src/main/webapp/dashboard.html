<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LOANDOC - 게시판</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, Helvetica, sans-serif; background: #f6f6f6; }
        header { background: #2d6cdf; color: #fff; padding: 20px; text-align: center; }
        main { max-width: 1200px; margin: 24px auto; padding: 18px; }
        nav { display: flex; justify-content: center; gap: 12px; padding: 12px 0; background: #f6f6f6; align-items: center; flex-wrap: wrap; }
        .nav-button { background: #FFD400; color: #000; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; text-decoration: none; font-weight: 700; }
        
        /* Dashboard Styles */
        .dashboard-container { background: #fff; padding: 28px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .dashboard-title { font-size: 24px; font-weight: bold; color: #333; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: #2d6cdf; color: white; }
        .btn-primary:hover { background: #1e5bc6; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        
        /* Post List */
        .post-list { margin-top: 20px; }
        .post-item { background: #f8f9fa; padding: 15px; margin-bottom: 12px; border-radius: 6px; border-left: 4px solid #2d6cdf; cursor: pointer; transition: all 0.3s; }
        .post-item:hover { background: #e9ecef; transform: translateX(5px); }
        .post-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .post-title { font-size: 18px; font-weight: 600; color: #333; }
        .post-meta { font-size: 12px; color: #6c757d; }
        .post-content-preview { font-size: 14px; color: #555; line-height: 1.5; max-height: 40px; overflow: hidden; text-overflow: ellipsis; }
        .post-actions { margin-top: 10px; display: flex; gap: 8px; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        /* Form Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.active { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 30px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: bold; }
        .close { font-size: 28px; cursor: pointer; color: #999; }
        .close:hover { color: #333; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-control:focus { outline: none; border-color: #2d6cdf; }
        textarea.form-control { min-height: 150px; resize: vertical; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; }
        
        /* Loading and Messages */
        .loading { text-align: center; padding: 40px; color: #6c757d; }
        .empty-state { text-align: center; padding: 60px 20px; color: #6c757d; }
        .error-message { background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #f5c6cb; }
        .success-message { background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #c3e6cb; }
        
        /* Post Detail View */
        .post-detail { background: #fff; padding: 20px; border-radius: 8px; }
        .post-detail-header { border-bottom: 2px solid #e9ecef; padding-bottom: 15px; margin-bottom: 20px; }
        .post-detail-title { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 10px; }
        .post-detail-meta { font-size: 14px; color: #6c757d; }
        .post-detail-content { font-size: 16px; line-height: 1.8; color: #333; white-space: pre-wrap; margin-bottom: 20px; }
        .post-detail-actions { display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 2px solid #e9ecef; }
    </style>
</head>
<body>
    <header>
        <h1>외국인 근로자 대출 중개 포털</h1>
        <p>게시판</p>
    </header>
    <nav>
        <a class="nav-button" href="home.html">LOANDOC</a>
        <a class="nav-button" href="introCo.html">회사소개</a>
        <a class="nav-button" href="login.html">로그인</a>
        <a class="nav-button" href="signup.html">회원가입</a>
        <a class="nav-button" href="workerInfo.html">정보조회</a>
        <a class="nav-button" href="intro.html">상품소개</a>
        <a class="nav-button" href="loanAppl.html">대출신청</a>
        <a class="nav-button" href="loanResult.html">대출결과</a>
        <a class="nav-button" href="dashboard.html">게시판</a>
        <a class="nav-button" href="customer.html">고객센터</a>
    </nav>
    <main>
        <div class="dashboard-container">
            <div id="message-container"></div>
            
            <!-- List View -->
            <div id="list-view">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">게시판</h2>
                    <button class="btn btn-primary" onclick="showCreateForm()">새 글 작성</button>
                </div>
                <div id="post-list" class="post-list">
                    <div class="loading">게시글을 불러오는 중...</div>
                </div>
            </div>
            
            <!-- Detail View -->
            <div id="detail-view" style="display: none;">
                <div class="post-detail">
                    <div class="post-detail-header">
                        <h2 class="post-detail-title" id="detail-title"></h2>
                        <div class="post-detail-meta">
                            <span>작성자: <strong id="detail-author"></strong></span> | 
                            <span>작성일: <span id="detail-created"></span></span> | 
                            <span>수정일: <span id="detail-updated"></span></span>
                        </div>
                    </div>
                    <div class="post-detail-content" id="detail-content"></div>
                    <div class="post-detail-actions">
                        <button class="btn btn-secondary" onclick="showListView()">목록으로</button>
                        <button class="btn btn-success" onclick="showEditForm()">수정</button>
                        <button class="btn btn-danger" onclick="deletePost()">삭제</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Create/Edit Modal -->
        <div id="post-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modal-title">새 글 작성</h3>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
                <form id="post-form" onsubmit="handleSubmit(event)">
                    <div class="form-group">
                        <label class="form-label" for="post-title">제목</label>
                        <input type="text" id="post-title" class="form-control" required maxlength="200" placeholder="제목을 입력하세요">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="post-author">작성자</label>
                        <input type="text" id="post-author" class="form-control" maxlength="100" placeholder="작성자 이름 (선택사항)">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="post-content">내용</label>
                        <textarea id="post-content" class="form-control" required placeholder="내용을 입력하세요"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </main>
    
    <script>
        const API_BASE = 'http://127.0.0.1:8080/api';
        let currentPostId = null;
        let isEditMode = false;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadPosts();
        });
        
        // Load all posts
        async function loadPosts() {
            try {
                const response = await fetch(`${API_BASE}/dashboard`);
                const data = await response.json();
                
                if (data.ok && data.posts) {
                    renderPosts(data.posts);
                } else {
                    showError('게시글을 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('Load posts error:', error);
                showError('서버 연결에 실패했습니다.');
            }
        }
        
        // Render posts list
        function renderPosts(posts) {
            const container = document.getElementById('post-list');
            
            if (posts.length === 0) {
                container.innerHTML = '<div class="empty-state">아직 게시글이 없습니다.<br>첫 번째 글을 작성해보세요!</div>';
                return;
            }
            
            container.innerHTML = posts.map(post => `
                <div class="post-item" onclick="viewPost(${post.id})">
                    <div class="post-item-header">
                        <div class="post-title">${escapeHtml(post.title)}</div>
                        <div class="post-meta">${formatDate(post.created_at)}</div>
                    </div>
                    <div class="post-content-preview">${escapeHtml(post.content)}</div>
                    <div class="post-meta">작성자: ${escapeHtml(post.author || 'Anonymous')}</div>
                </div>
            `).join('');
        }
        
        // View single post
        async function viewPost(id) {
            try {
                const response = await fetch(`${API_BASE}/dashboard/${id}`);
                const data = await response.json();
                
                if (data.ok && data.post) {
                    const post = data.post;
                    currentPostId = id;
                    
                    document.getElementById('detail-title').textContent = post.title;
                    document.getElementById('detail-author').textContent = post.author || 'Anonymous';
                    document.getElementById('detail-created').textContent = formatDate(post.created_at);
                    document.getElementById('detail-updated').textContent = formatDate(post.updated_at);
                    document.getElementById('detail-content').textContent = post.content;
                    
                    document.getElementById('list-view').style.display = 'none';
                    document.getElementById('detail-view').style.display = 'block';
                } else {
                    showError('게시글을 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('View post error:', error);
                showError('서버 연결에 실패했습니다.');
            }
        }
        
        // Show list view
        function showListView() {
            document.getElementById('detail-view').style.display = 'none';
            document.getElementById('list-view').style.display = 'block';
            currentPostId = null;
            clearMessages();
            loadPosts();
        }
        
        // Show create form
        function showCreateForm() {
            isEditMode = false;
            document.getElementById('modal-title').textContent = '새 글 작성';
            document.getElementById('submit-btn').textContent = '저장';
            document.getElementById('post-form').reset();
            document.getElementById('post-author').disabled = false;
            document.getElementById('post-modal').classList.add('active');
        }
        
        // Show edit form
        async function showEditForm() {
            if (!currentPostId) return;
            
            try {
                const response = await fetch(`${API_BASE}/dashboard/${currentPostId}`);
                const data = await response.json();
                
                if (data.ok && data.post) {
                    isEditMode = true;
                    const post = data.post;
                    
                    document.getElementById('modal-title').textContent = '글 수정';
                    document.getElementById('submit-btn').textContent = '수정';
                    document.getElementById('post-title').value = post.title;
                    document.getElementById('post-author').value = post.author || '';
                    document.getElementById('post-author').disabled = true;
                    document.getElementById('post-content').value = post.content;
                    document.getElementById('post-modal').classList.add('active');
                } else {
                    showError('게시글을 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('Load post for edit error:', error);
                showError('서버 연결에 실패했습니다.');
            }
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('post-modal').classList.remove('active');
            document.getElementById('post-form').reset();
        }
        
        // Handle form submit
        async function handleSubmit(event) {
            event.preventDefault();
            
            const title = document.getElementById('post-title').value.trim();
            const content = document.getElementById('post-content').value.trim();
            const author = document.getElementById('post-author').value.trim();
            
            if (!title || !content) {
                showError('제목과 내용을 입력해주세요.');
                return;
            }
            
            try {
                let response;
                if (isEditMode && currentPostId) {
                    // Update existing post
                    response = await fetch(`${API_BASE}/dashboard/${currentPostId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, content })
                    });
                } else {
                    // Create new post
                    response = await fetch(`${API_BASE}/dashboard`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, content, author })
                    });
                }
                
                const data = await response.json();
                
                if (data.ok) {
                    closeModal();
                    showSuccess(isEditMode ? '게시글이 수정되었습니다.' : '게시글이 작성되었습니다.');
                    
                    if (isEditMode) {
                        // Refresh detail view
                        await viewPost(currentPostId);
                    } else {
                        // Return to list view
                        showListView();
                    }
                } else {
                    showError('게시글 저장에 실패했습니다.');
                }
            } catch (error) {
                console.error('Submit error:', error);
                showError('서버 연결에 실패했습니다.');
            }
        }
        
        // Delete post
        async function deletePost() {
            if (!currentPostId) return;
            
            if (!confirm('정말로 이 게시글을 삭제하시겠습니까?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/dashboard/${currentPostId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    showSuccess('게시글이 삭제되었습니다.');
                    setTimeout(() => {
                        showListView();
                    }, 1000);
                } else {
                    showError('게시글 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showError('서버 연결에 실패했습니다.');
            }
        }
        
        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function showError(message) {
            const container = document.getElementById('message-container');
            container.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(clearMessages, 5000);
        }
        
        function showSuccess(message) {
            const container = document.getElementById('message-container');
            container.innerHTML = `<div class="success-message">${message}</div>`;
            setTimeout(clearMessages, 3000);
        }
        
        function clearMessages() {
            document.getElementById('message-container').innerHTML = '';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('post-modal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>

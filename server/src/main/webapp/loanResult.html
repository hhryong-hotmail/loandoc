<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LOANDOC - 대출결과</title>
    <style>
        body{font-family:Arial,Helvetica,sans-serif;background:#f6f6f6;margin:0}
    header{background:#2d6cdf;color:#fff;padding:28px 20px;text-align:center}
    main{max-width:none;width:100%;margin:24px 0;background:#f6f6f6;padding:18px 24px;border-radius:8px;box-sizing:border-box}
    nav{display:flex;justify-content:center;gap:10px;padding:12px 8px;background:#f6f6f6;align-items:center;flex-wrap:nowrap;overflow-x:auto;white-space:nowrap}
    .nav-button{background:#FFD400;color:#000;border:none;padding:8px 12px;min-width:100px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;font-size:14px;flex:0 0 auto;box-sizing:border-box}
    /* (removed right-align rule so buttons stay adjacent) */
    .hero{background:#fff;padding:28px;border-radius:8px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.06)}
    .title{font-size:1.4rem;font-weight:800;color:#2d6cdf}
    </style>
    <style>
    /* Column based nav (shared) */
    nav.nav-columns{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;padding:10px;background:#f6f6f6;border-radius:10px;align-items:start}
    nav.nav-columns .nav-column{display:flex;flex-direction:column;gap:12px}
    nav.nav-columns .nav-button{background:#FFD400;color:#000;border:none;padding:10px 12px;height:auto;display:block;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;font-size:14px;width:100%;box-sizing:border-box;text-align:center}
    nav.nav-columns .nav-column:nth-child(1){padding-right:12px}
    nav.nav-columns .nav-column:nth-child(2){padding:0 12px}
    nav.nav-columns .nav-column:nth-child(3){padding-left:12px}
    nav.nav-columns .nav-column:nth-child(4){padding-left:12px}
    @media (max-width:600px){nav.nav-columns{grid-template-columns:repeat(2,1fr);gap:10px;padding:8px}nav.nav-columns .nav-button{font-size:13px;padding:8px}}
    </style>
</head>
<body>
    <header>
        <h1>외국인 근로자 신용 대출</h1>
        <p>LOANDOC</p>
    </header>
    <nav class="nav-columns" aria-label="주요 네비게이션">
        <div class="nav-column">
            <a class="nav-button" href="home.html">LOANDOC</a>
            <a class="nav-button" href="introCo.html">회사소개</a>
            <a class="nav-button" href="intro.html">상품소개</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="login.html">로그인</a>
            <a class="nav-button" href="#" id="nav-logout">로그아웃</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="loanAppl.html">대출조회</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="dashboard.html">게시판</a>
            <a class="nav-button" href="customer.html">고객센터</a>
        </div>
    </nav>
    <hr />
    <main>
        <div class="hero">
            <table id="result-table" border="1" style="width:100%;border-collapse:collapse;text-align:center;">
                <tr>
                    <th rowspan="2">입력정보</th>
                    <th>비자종류</th>
                    <th>국가</th>
                    <th>나이</th>
                    <th>비자만료일</th>
                    <th>연소득</th>
                    <th rowspan="2">예상한도</th>
                    <th rowspan="2">예상금리</th>
                    <th rowspan="2">배열순서</th>
                </tr>
                <tr>
                    <td id="input-visa">E-7</td>
                    <td id="input-country">베트남</td>
                    <td id="input-age">19</td>
                    <td id="input-visa-expiry">26.10.31</td>
                    <td id="input-income">2000만원</td>
                </tr>
                <tbody id="result-tbody">
                    <!-- Results will be inserted here -->
                </tbody>
                <tr>
                    <td colspan="9" style="text-align:left;padding:10px;line-height:1.6;">
                        <strong>참고:</strong><br>
                        1. O는 조건 충족, X는 조건 미충족을 의미합니다.<br>
                        2. 대출 예상 한도와 예상금리는 개인별 평균신용등급으로 산정, 실제 해당은행에 신청시에는 한도와 금리는 달라질 수 있습니다.
                    </td>
                </tr>
            </table>
            <div style="text-align:right;margin-top:20px;">
                <button onclick="window.location.href='loanAppl.html'" style="background:#2d6cdf;color:#fff;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;font-size:16px;font-weight:700;">전화면</button>
            </div>
        </div>
    </main>
    
    <script>
        // Load and display loan estimate results
        document.addEventListener('DOMContentLoaded', function(){
            try{
                const resultData = sessionStorage.getItem('loanEstimateResult');
                const inputData = sessionStorage.getItem('loanEstimateInput');
                
                if(!resultData || !inputData){
                    alert('조회 결과가 없습니다. 대출 신청 페이지에서 먼저 조회해주세요.');
                    window.location.href = 'loanAppl.html';
                    return;
                }
                
                const results = JSON.parse(resultData);
                const inputs = JSON.parse(inputData);
                
                // Update input row
                document.getElementById('input-visa').textContent = inputs.visaType || 'E-7';
                document.getElementById('input-country').textContent = inputs.nationality || '베트남';
                document.getElementById('input-age').textContent = inputs.age || '19';
                document.getElementById('input-visa-expiry').textContent = calculateExpiryDate(inputs.remainMonths) || '26.10.31';
                document.getElementById('input-income').textContent = (inputs.annualIncome || '2000') + '만원';
                
                // Display results
                const tbody = document.getElementById('result-tbody');
                tbody.innerHTML = '';
                
                if(!Array.isArray(results) || results.length === 0){
                    tbody.innerHTML = '<tr><td colspan="9">조회 결과가 없습니다.</td></tr>';
                    return;
                }
                
                results.forEach((bank, idx) => {
                    const row = document.createElement('tr');
                    
                    // Bank name with rank
                    // For KB and 예가람, show bank name. For middle ranks (2-4), show actual bank name
                    let rankText;
                    if(bank.rank === 1){
                        rankText = 'KB저축은행';
                    } else if(bank.rank === 5){
                        rankText = '예가람저축은행';
                    } else {
                        // Show actual bank name for 2순위, 3순위, 4순위
                        rankText = bank.bankName;
                    }
                    const bankCell = document.createElement('th');
                    bankCell.textContent = rankText;
                    row.appendChild(bankCell);
                    
                    // Validation results
                    const visaCell = document.createElement('td');
                    visaCell.textContent = bank.visaType.valid ? 'O' : 'X';
                    if(!bank.visaType.valid) visaCell.style.color = 'red';
                    row.appendChild(visaCell);
                    
                    const countryCell = document.createElement('td');
                    countryCell.textContent = bank.country.valid ? 'O' : 'X';
                    if(!bank.country.valid) countryCell.style.color = 'red';
                    row.appendChild(countryCell);
                    
                    const ageCell = document.createElement('td');
                    ageCell.textContent = bank.age.valid ? 'O' : 'X';
                    if(!bank.age.valid) ageCell.style.color = 'red';
                    row.appendChild(ageCell);
                    
                    const visaExpiryCell = document.createElement('td');
                    visaExpiryCell.textContent = bank.visaExpiry.valid ? 'O' : 'X';
                    if(!bank.visaExpiry.valid) visaExpiryCell.style.color = 'red';
                    row.appendChild(visaExpiryCell);
                    
                    const incomeCell = document.createElement('td');
                    incomeCell.textContent = bank.annualIncome.valid ? 'O' : 'X';
                    if(!bank.annualIncome.valid) incomeCell.style.color = 'red';
                    row.appendChild(incomeCell);
                    
                    // Estimated limit
                    const limitCell = document.createElement('td');
                    limitCell.textContent = bank.estimatedLimit !== null ? 
                        bank.estimatedLimit.toLocaleString() + '만원' : '-';
                    row.appendChild(limitCell);
                    
                    // Interest rate
                    const rateCell = document.createElement('td');
                    rateCell.textContent = bank.estimatedRate !== null ? 
                        bank.estimatedRate + '%' : '-';
                    row.appendChild(rateCell);
                    
                    // Display order (배열순서)
                    const orderCell = document.createElement('td');
                    // KB(rank 1) and 예가람(rank 5) show X, others show their rank-1
                    if(bank.rank === 1 || bank.rank === 5){
                        orderCell.textContent = 'X';
                    } else {
                        orderCell.textContent = bank.rank - 1; // 2순위 -> 1, 3순위 -> 2, 4순위 -> 3
                    }
                    row.appendChild(orderCell);
                    
                    tbody.appendChild(row);
                });
                
                // Clear session storage after displaying
                // sessionStorage.removeItem('loanEstimateResult');
                // sessionStorage.removeItem('loanEstimateInput');
                
            }catch(err){
                console.error('결과 표시 오류:', err);
                alert('결과를 표시하는 중 오류가 발생했습니다.');
            }
        });
        
        // Calculate visa expiry date from remainMonths
        function calculateExpiryDate(remainMonths){
            if(!remainMonths) return '';
            const today = new Date();
            today.setMonth(today.getMonth() + parseInt(remainMonths));
            const year = String(today.getFullYear()).slice(2); // YY format
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}.${month}.${day}`;
        }
        
        // 네비게이션 로그아웃 버튼
        const navLogout = document.getElementById('nav-logout');
        if(navLogout){
            navLogout.addEventListener('click', async function(e){
                e.preventDefault();
                try {
                    const response = await fetch('/api/auth/logout', { method: 'POST' });
                    const result = await response.json();
                    if (result.ok) {
                        alert('로그아웃되었습니다');
                        window.location.href = 'login.html';
                    }
                } catch (err) {
                    console.error('Logout error', err);
                }
            });
        }
    </script>
</body>
</html>
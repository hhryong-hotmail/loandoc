<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LOANDOC - 상담 요청 게시판</title>
    <style>
        body{font-family:Arial,Helvetica,sans-serif;background:#f6f6f6;margin:0}
    header{background:#2d6cdf;color:#fff;padding:28px 20px;text-align:center}
    /* main을 전체 너비로 확장하여 nav와 좌우 길이를 맞춤 */
    main{max-width:none;width:100%;margin:24px 0;background:#f6f6f6;padding:18px 24px;border-radius:8px;box-sizing:border-box}
    nav{display:flex;justify-content:center;gap:10px;padding:12px 8px;background:#f6f6f6;align-items:center;flex-wrap:nowrap;overflow-x:auto;white-space:nowrap}
    .nav-button{background:#FFD400;color:#000;border:none;padding:8px 12px;min-width:100px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;font-size:14px;flex:0 0 auto;box-sizing:border-box}
        .hero{background:#fff;padding:28px;border-radius:8px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.06)}
    </style>
    <style>
    /* Column based nav (shared) */
    nav.nav-columns{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;padding:10px;background:#f6f6f6;border-radius:10px;align-items:start}
    nav.nav-columns .nav-column{display:flex;flex-direction:column;gap:12px}
    nav.nav-columns .nav-button{background:#FFD400;color:#000;border:none;padding:10px 12px;height:auto;display:block;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;font-size:14px;width:100%;box-sizing:border-box;text-align:center}
    nav.nav-columns .nav-column:nth-child(1){padding-right:12px}
    nav.nav-columns .nav-column:nth-child(2){padding:0 12px}
    nav.nav-columns .nav-column:nth-child(3){padding-left:12px}
    nav.nav-columns .nav-column:nth-child(4){padding-left:12px}
    @media (max-width:600px){nav.nav-columns{grid-template-columns:repeat(2,1fr);gap:10px;padding:8px}nav.nav-columns .nav-button{font-size:13px;padding:8px}}
    </style>
</head>
<body>
    <header>
        <h1>외국인 근로자 신용 대출</h1>
        <p>LOANDOC</p>
    </header>
    <nav class="nav-columns" aria-label="주요 네비게이션">
        <div class="nav-column">
            <a class="nav-button" href="/server/home.html">LOANDOC</a>
            <a class="nav-button" href="/server/introCo.html">회사소개</a>
            <a class="nav-button" href="/server/intro.html">상품소개</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="/server/login.html">로그인</a>
            <a class="nav-button" href="#" id="nav-logout">로그아웃</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="/server/loanAppl.html">대출조회</a>
            <a class="nav-button" href="/server/loanConsult.html">대출상담조회</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="/server/dashboard.html">게시판</a>
            <a class="nav-button" href="/server/customer.html">고객센터</a>
        </div>
    </nav>
    <hr />
    <main>
        <div class="hero">
            <h2>상담 요청 게시판</h2>
            <p class="note">상담요청</p>
            <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                <input id="searchInput" placeholder="검색어 (제목/내용/작성자)" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd" />
                <select id="filterType" style="padding:8px;border-radius:6px;border:1px solid #ddd">
                    <option value="질문">질문</option>
                    <option value="답변">답변</option>
                    <option value="완료">완료</option>
                    <option value="미결">미결</option>
                    <option value="전체" selected>전체</option>
                </select>
                <button class="nav-button" id="searchBtn">검색</button>
                <button class="nav-button" id="newBtn">상담요청</button>
            </div>
        </div>

        <section style="margin-top:18px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.04)">
            <table id="postsTable" style="width:100%;border-collapse:collapse">
                <thead>
                    <tr style="text-align:left;border-bottom:1px solid #eee">
                        <th style="padding:8px;width:80px">ID</th>
                        <th style="padding:8px;width:140px">작성일자</th>
                        <th style="padding:8px;width:160px">작성자</th>
                        <th style="padding:8px;width:100px">유형</th>
                        <th style="padding:8px">제목</th>
                    </tr>
                </thead>
                <tbody id="postsBody"></tbody>
            </table>
        </section>

        <!-- Form modal (simple) -->
        <div id="formPanel" style="display:none;margin-top:18px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.06)">
            <h3 id="formTitle">상담요청</h3>
            <!-- Single row: author(20ch) / type(10ch) / title(flex) -->
            <div style="display:grid;grid-template-columns:20ch 10ch 1fr;gap:8px;align-items:center">
                <input id="author" placeholder="작성자 (로그인 ID)" style="width:100%;height:44px;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box" />
                <select id="msg_type" style="height:44px;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box">
                    <option value="질문" selected>질문</option>
                    <option value="답변">답변</option>
                    <option value="완료">완료</option>
                    <option value="미결">미결</option>
                </select>
                <input id="title" placeholder="제목" style="width:100%;height:44px;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box" />
            </div>
            <!-- 상담요청 추가 정보: 이름, 전화번호, 국적 -->
            <div style="display:grid;grid-template-columns:1fr 20ch 20ch;gap:8px;align-items:center;margin-top:8px">
                <input id="name" placeholder="이름" style="width:100%;height:44px;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box" />
                <input id="phone_number" placeholder="전화번호" style="width:100%;height:44px;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box" />
                <input id="nationality" placeholder="국적" style="width:100%;height:44px;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box" />
            </div>
            <textarea id="content" rows="6" style="width:100%;margin-top:8px;padding:8px"></textarea>
            <div style="margin-top:8px;display:flex;gap:8px">
                <button id="saveBtn" class="nav-button">저장</button>
                <button id="cancelBtn" class="nav-button">취소</button>
            </div>
        </div>

        <!-- View panel -->
        <div id="viewPanel" style="display:none;margin-top:18px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.06)">
            <h3 id="viewTitle"></h3>
            <div style="color:#666;font-size:13px;margin-bottom:8px">작성자 (ID): <span id="viewAuthor"></span> | 이름: <span id="viewName"></span> | 전화: <span id="viewPhone"></span> | 국적: <span id="viewNation"></span> | 작성일: <span id="viewDate"></span></div>
            <div id="viewContent" style="white-space:pre-wrap"></div>
            <div style="margin-top:8px;display:flex;gap:8px">
                <button id="editBtn" class="nav-button">수정</button>
                <button id="delBtn" class="nav-button">삭제</button>
                <button id="closeViewBtn" class="nav-button">닫기</button>
            </div>
        </div>
    </main>
    <script>
        (function(){
            const postsBody = document.getElementById('postsBody');
            const searchInput = document.getElementById('searchInput');
            const filterType = document.getElementById('filterType');
            const searchBtn = document.getElementById('searchBtn');
            const newBtn = document.getElementById('newBtn');
            const formPanel = document.getElementById('formPanel');
            const viewPanel = document.getElementById('viewPanel');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const editBtn = document.getElementById('editBtn');
            const delBtn = document.getElementById('delBtn');
            const closeViewBtn = document.getElementById('closeViewBtn');

            let editId = null;
            let currentUser = null;

            // API URL helper: 보이는 페이지 경로를 기준으로 API 상대 경로를 생성
            function apiUrl(path){
                // 현재 URL 예: /server/loanConsult.html -> base = /server/
                const base = window.location.pathname.replace(/\/[^/]*$/, '/');
                return base + String(path).replace(/^\/+/, '');
            }

            // fetchApi: apiUrl로 호출을 시도하고, 실패(404 HTML 등)하면 '/server/' 접두사로 재시도
            async function fetchApi(path, opts){
                const tryUrls = [apiUrl(path)];
                // Also try with explicit /server/ prefix if not already present
                if (!String(path).startsWith('/server/') && !tryUrls[0].startsWith('/server/')){
                    tryUrls.push('/server/' + String(path).replace(/^\/+/, ''));
                }
                let lastNonJson = null;
                for(const u of tryUrls){
                    try{
                        const res = await fetch(u, opts);
                        const ct = res.headers.get('Content-Type') || '';
                        if(ct.includes('application/json')) return res;
                        // If server returned an error status (404/500), try next URL instead of returning immediately
                        if (res.status >= 400){
                            const text = await res.text();
                            console.warn('fetchApi received error status for', u, res.status, ct, text.slice(0,200));
                            lastNonJson = { status: res.status, contentType: ct, text: text };
                            continue; // try next URL
                        }
                        // 200 OK but non-JSON - capture and return so caller can handle
                        const text = await res.text();
                        console.warn('fetchApi non-JSON 200 response for', u, res.status, ct, text.slice(0,200));
                        return new Response(text, { status: res.status, headers: res.headers });
                    }catch(e){
                        console.warn('fetchApi error for', u, e);
                        // try next
                    }
                }
                if (lastNonJson) {
                    // return a Response-like object containing last non-json body/status
                    return new Response(lastNonJson.text, { status: lastNonJson.status });
                }
                throw new Error('API 호출 실패: 모든 시도 실패');
            }

            // 세션 확인 및 로그인 상태 체크
            async function checkLoginStatus() {
                try {
                    const response = await fetch('/server/api/auth/session', { credentials: 'same-origin' });
                    const ct0 = response.headers && response.headers.get ? response.headers.get('Content-Type') || '' : '';
                    if(!ct0.includes('application/json')){
                        const t0 = await response.text(); console.error('Session endpoint returned non-JSON', t0.slice(0,200));
                        throw new Error('세션 확인에 실패했습니다 (서버 응답이 JSON 아님)');
                    }
                    const result = await response.json();
                    
                    if (result.authenticated && result.userId) {
                        currentUser = result.userId;
                        
                        // If user is logged in, set author input to login id and make it read-only
                        const authorInputEl = document.getElementById('author');
                        if (authorInputEl) {
                            authorInputEl.value = currentUser;
                            authorInputEl.setAttribute('disabled', 'disabled');
                        }
                        
                        // 게시판 데이터 로드
                        await loadPosts();
                    } else {
                        // 로그인되지 않은 경우 로그인 페이지로 이동
                        alert('로그인이 필요합니다. 로그인 페이지로 이동합니다.');
                        window.location.href = '/server/login.html';
                    }
                } catch (e) {
                    console.error('Session check error', e);
                    alert('세션 확인 중 오류가 발생했습니다. 로그인 페이지로 이동합니다.');
                    window.location.href = 'login.html';
                }
            }

            // 페이지 로드 시 세션 확인
            checkLoginStatus();

            async function loadPosts(){
                const q = encodeURIComponent(searchInput.value || '');
                const t = encodeURIComponent(filterType.value || '');
                // use loan_consultant API and req_type as filter param
                const path = `api/loan_consultant?q=${q}&req_type=${t}`;
                try{
                    console.debug('Fetching posts from', path);
                    const r = await fetch('/server/api/loan_consultant?q='+q+'&req_type='+t, { credentials: 'same-origin' });
                    const ct = r.headers.get('Content-Type') || '';
                    if (!ct.includes('application/json')){
                        // not JSON -> capture text for debugging
                        const text = await r.text();
                        console.error('Expected JSON but got:', r.status, ct, text.slice(0,200));
                        throw new Error('서버가 JSON을 반환하지 않았습니다 (HTTP '+r.status+'). 개발자 콘솔을 확인하세요.');
                    }
                    const j = await r.json();
                    if(!j.ok) throw new Error(j.error || 'load failed');
                    renderPosts(j.rows || []);
                }catch(e){
                    alert('목록 불러오기 실패: '+e.message);
                }
            }

            function formatDateTime(val){
                if(!val) return '';
                // If already a Date object
                try{
                    const d = new Date(val);
                    if(isNaN(d)){
                        // If value is YYYY-MM-DD, return with 00:00
                        const s = String(val).trim();
                        if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s + ' 00:00';
                        return s;
                    }
                    const pad = (n) => String(n).padStart(2,'0');
                    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
                }catch(e){ return String(val); }
            }

            function renderPosts(rows){
                postsBody.innerHTML = '';
                if(!rows || rows.length===0){
                    postsBody.innerHTML = `<tr><td colspan="5" style="padding:12px;text-align:center;color:#666">등록된 글이 없습니다.</td></tr>`;
                    return;
                }
                for(const r of rows){
                    const tr = document.createElement('tr');
                    // Only allow edit/delete for the author who created the post (if logged in)
                    const allowEdit = currentUser && String(currentUser) === String(r.req_login);
                    tr.innerHTML = `
                        <td style="padding:8px;border-bottom:1px solid #f1f1f1">${r.req_id}</td>
                        <td style="padding:8px;border-bottom:1px solid #f1f1f1">${formatDateTime(r.created_at)}</td>
                        <td style="padding:8px;border-bottom:1px solid #f1f1f1">${escapeHtml(r.req_login || '')}</td>
                        <td style="padding:8px;border-bottom:1px solid #f1f1f1">${r.req_type || ''}</td>
                        <td style="padding:8px;border-bottom:1px solid #f1f1f1"><a href="#" class="view-link" data-id="${r.req_id}">${escapeHtml(r.title || '')}</a></td>
                    `;
                    postsBody.appendChild(tr);
                }
                // attach click handlers to title links for viewing
                postsBody.querySelectorAll('a.view-link').forEach(a=>{
                    a.addEventListener('click', (ev)=>{ ev.preventDefault(); const id = a.getAttribute('data-id'); viewPost(id); });
                });
            }

            function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

            // viewPost is defined below (with password check). Removed duplicate to avoid function shadowing.

            function startEdit(id){
                // load full request then populate form
                fetch('/server/api/loan_consultant/'+id, { credentials: 'same-origin' }).then(async r=>{
                    const ct = r.headers.get('Content-Type') || '';
                    if(!ct.includes('application/json')){
                        const t = await r.text(); console.error('Unexpected non-JSON response', r.status, ct, t.slice(0,200));
                        return alert('불러오기 실패: 서버가 JSON을 반환하지 않았습니다. 콘솔을 확인하세요.');
                    }
                    return r.json();
                }).then(j=>{
                    if(!j || !j.ok) return alert('불러오기 실패: '+(j && j.error? j.error : '')); 
                    const row = j.row;
                    // author is locked to logged-in user; keep value from currentUser
                    if (!currentUser) document.getElementById('author').value = row.req_login || '';
                    document.getElementById('title').value = row.title || '';
                    document.getElementById('msg_type').value = row.req_type || '질문';
                    document.getElementById('content').value = row.req_content || '';
                    document.getElementById('name').value = row.name || '';
                    document.getElementById('phone_number').value = row.phone_number || '';
                    document.getElementById('nationality').value = row.nationality || '';
                    formPanel.style.display = 'block';
                    viewPanel.style.display = 'none';
                    document.getElementById('formTitle').textContent = '글 수정';
                    editId = row.req_id;
                    }).catch(e=>alert('불러오기 실패: '+e.message));
            }

            async function viewPost(id){
                try{
                    const r = await fetch('/server/api/loan_consultant/'+id, { credentials: 'same-origin' });
                    const ct = r.headers.get('Content-Type') || '';
                    if(!ct.includes('application/json')){
                        const t = await r.text(); console.error('Unexpected non-JSON response', r.status, ct, t.slice(0,200));
                        throw new Error('서버가 JSON을 반환하지 않았습니다. 콘솔을 확인하세요.');
                    }
                    const j = await r.json();
                    if(!j.ok) throw new Error(j.error||'failed');
                    const row = j.row;

                    // No per-post password; access control handled by server/session when editing/deleting

                    document.getElementById('viewTitle').textContent = row.title;
                    document.getElementById('viewAuthor').textContent = row.req_login || '';
                    document.getElementById('viewName').textContent = row.name || '';
                    document.getElementById('viewPhone').textContent = row.phone_number || '';
                    document.getElementById('viewNation').textContent = row.nationality || '';
                    document.getElementById('viewDate').textContent = formatDateTime(row.created_at || '');
                    document.getElementById('viewViews').textContent = row.views || '';
                    document.getElementById('viewContent').textContent = row.req_content || '';
                    viewPanel.style.display = 'block';
                    formPanel.style.display = 'none';
                    editId = row.req_id;
                    }catch(e){ alert('게시글 불러오기 실패: '+e.message); }
            }

            // savePost: create or update a post
            async function savePost(){
                const data = {
                    req_login: document.getElementById('author').value,
                    title: document.getElementById('title').value,
                    req_type: document.getElementById('msg_type').value,
                    req_content: document.getElementById('content').value,
                    // name and nationality will be resolved server-side from foreign_worker_master by req_login
                    phone_number: document.getElementById('phone_number').value
                };
                try{
                    let res;
                    if(editId){
                        res = await fetch('/server/api/loan_consultant/'+editId, { method: 'PUT', credentials: 'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
                    } else {
                        res = await fetch('/server/api/loan_consultant', { method: 'POST', credentials: 'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
                    }
                    const ct = res.headers.get('Content-Type') || '';
                    if(!ct.includes('application/json')){
                        const t = await res.text(); console.error('Save returned non-JSON', res.status, ct, t.slice(0,200));
                        throw new Error('서버 응답이 JSON이 아닙니다. 콘솔을 확인하세요.');
                    }
                    const j = await res.json();
                    if(!j.ok) throw new Error(j.error||'save failed');
                    formPanel.style.display = 'none';
                    editId = null;
                    await loadPosts();
                    // show success message to user
                    try{ alert('저장이 되었습니다'); }catch(e){}
                }catch(e){ alert('저장 실패: '+e.message); }
            }

            // delete a post
            async function deletePost(id){
                if(!confirm('정말로 삭제하시겠습니까?')) return;
                try{
                    const res = await fetch('/server/api/loan_consultant/'+id, { method: 'DELETE', credentials: 'same-origin' });
                    const ct = res.headers.get('Content-Type') || '';
                    if(!ct.includes('application/json')){
                        const t = await res.text(); console.error('Delete returned non-JSON', res.status, ct, t.slice(0,200));
                        throw new Error('서버 응답이 JSON이 아닙니다. 콘솔을 확인하세요.');
                    }
                    const j = await res.json();
                    if(!j.ok) throw new Error(j.error||'delete failed');
                    editId = null;
                    viewPanel.style.display = 'none';
                    await loadPosts();
                    try{ alert('삭제되었습니다'); }catch(e){}
                }catch(e){ alert('삭제 실패: '+e.message); }
            }

            // events
            searchBtn.addEventListener('click', ()=>loadPosts());
            newBtn.addEventListener('click', async ()=>{
                editId = null;
                // Prefill author with logged-in user; keep the field disabled when logged-in
                const authorEl = document.getElementById('author');
                if(authorEl){
                    authorEl.value = currentUser || '';
                    if(currentUser) authorEl.setAttribute('disabled','disabled'); else authorEl.removeAttribute('disabled');
                }
                document.getElementById('title').value = '';
                document.getElementById('msg_type').value = '질문';
                document.getElementById('content').value = '';
                document.getElementById('phone_number').value = '';
                // Try to prefill name and nationality from foreign_worker_master
                try{
                    const resp = await fetch('/server/api/foreign_worker_master', { credentials: 'same-origin' });
                    if(resp.ok){
                        const j = await resp.json();
                        if(j && j.ok && j.found && j.data){
                            const nm = j.data.name || '';
                            const nat = j.data.nationality || '';
                            const nameEl = document.getElementById('name');
                            const natEl = document.getElementById('nationality');
                            if(nameEl){ nameEl.value = nm; nameEl.setAttribute('disabled','disabled'); }
                            if(natEl){ natEl.value = nat; natEl.setAttribute('disabled','disabled'); }
                        } else {
                            // clear and enable if not found
                            const nameEl = document.getElementById('name');
                            const natEl = document.getElementById('nationality');
                            if(nameEl){ nameEl.value = ''; nameEl.removeAttribute('disabled'); }
                            if(natEl){ natEl.value = ''; natEl.removeAttribute('disabled'); }
                        }
                    }
                }catch(e){
                    console.warn('Failed to prefill foreign_worker_master', e);
                }
                formPanel.style.display = 'block';
                viewPanel.style.display = 'none';
                document.getElementById('formTitle').textContent = '상담요청';
            });
            cancelBtn.addEventListener('click', ()=>{ formPanel.style.display = 'none'; editId=null; });
            closeViewBtn.addEventListener('click', ()=>{ viewPanel.style.display = 'none'; editId=null; });
            saveBtn.addEventListener('click', savePost);
            editBtn.addEventListener('click', ()=>{ if(editId) startEdit(editId); });
            delBtn.addEventListener('click', ()=>{ if(editId) deletePost(editId); });

            // initial load는 checkLoginStatus()에서 처리됨
        })();
        
        // 네비게이션 로그아웃 버튼
        const navLogout = document.getElementById('nav-logout');
        if(navLogout){
            navLogout.addEventListener('click', async function(e){
                e.preventDefault();
                try {
                    const response = await fetch('/server/api/auth/logout', { method: 'POST', credentials: 'same-origin' });
                    const result = await response.json();
                    if (result.ok) {
                        alert('로그아웃되었습니다');
                        window.location.href = '/server/login.html';
                    }
                } catch (err) {
                    console.error('Logout error', err);
                }
            });
        }
    </script>
</body>
</html>

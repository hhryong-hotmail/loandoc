<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LOANDOC - 대출신청</title>
    <style>
        :root{--bg:#f6f6f6;--brand:#2d6cdf;--accent:#FFD400;--nav-pad:8px}
        body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;color:#222}
    header{background:var(--brand);color:#fff;padding:28px 20px;text-align:center;position:relative}
    main{max-width:none;width:100%;margin:24px 0 0 50px;background:var(--bg);padding:18px 24px;border-radius:8px;box-sizing:border-box}
        .hero{background:#fff;padding:28px;border-radius:8px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.06)}
        .title{font-size:1.4rem;font-weight:800;color:var(--brand)}
        .note{color:#666;font-size:0.95em;margin-top:8px}
        button{background:var(--brand);color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer}
        /* Nav centering and uniform button style */
    nav{display:flex;justify-content:space-between;gap:10px;padding:12px 8px;background:var(--bg);align-items:center;flex-wrap:nowrap;overflow-x:auto;white-space:nowrap}
    .nav-left{display:flex;flex-direction:column;gap:8px;align-items:flex-start}
    .nav-center{display:flex;gap:10px;align-items:center}
    .nav-button{background:var(--accent);color:#000;border:none;padding:8px 16px;min-width:100px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;font-size:14px;flex:0 0 auto;box-sizing:border-box}
    /* nav actions wrapper to align logout and consult with equal spacing */
    .nav-actions{display:flex;gap:12px;align-items:center}
    .action-buttons-nav{display:flex;flex-direction:column;gap:8px;margin-top:4px}
    /* Action buttons (stacked, white background, navy text) */
    .action-buttons{display:flex;flex-direction:column;gap:12px;align-items:center}
    .action-button{background:#FFFFFF;color:#000080;border:1px solid #000080;padding:8px 12px;min-width:200px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;font-size:14px}
    /* (removed right-align rule so buttons stay adjacent) */
        label{display:block;margin-top:10px}
        input[type=number]{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%;max-width:320px}
        .form-row{margin-top:12px}
    </style>
    <style>
    /* Loan form layout: label on the left, select/input on the right
       Align container with login page by using same max-width and centering. */
    .loan-form{max-width:420px;margin:24px auto;padding:0 12px;box-sizing:border-box}
    .loan-form .form-row{display:flex;align-items:center;gap:12px}
    /* narrower label so it fits inside 420px container next to control */
    .loan-form label{width:140px;margin-top:0}
    .loan-form select, .loan-form input{flex:1;max-width:none;padding:10px;border-radius:6px;border:1px solid #ccc}
    @media (max-width:600px){
        .loan-form{margin-left:8px;margin-right:8px}
        .loan-form .form-row{flex-direction:column;align-items:stretch}
        .loan-form label{width:auto;margin-bottom:6px}
    }
    /* member-style outline used near login info: bordered rounded box */
    .member-box{display:flex;align-items:center;gap:12px;padding:10px;border:1px solid #d0d7df;background:#fff;border-radius:10px;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
    /* Match label/select appearance to login page inputs */
    .member-box label{display:block;margin-bottom:6px;font-weight:600;color:inherit}
    .member-box select{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;background:#fff;font-size:14px}
    /* Ensure select controls sit to the right inside member-box without changing box size */
    .member-box{position:relative}
    .member-box select{margin-left:auto;max-width:220px}
    @media (max-width:600px){
        .member-box{flex-direction:column;align-items:stretch}
    }
    /* 약관동의 버튼: 데스크톱에서는 로그인 버튼과 같은 높이에 오도록 .login-row 내부로 이동시키고
       좌측을 nav 3열(대출결과) 왼쪽 경계와 대략 정렬시키기 위해 margin-left 계산 사용.
       모바일에서는 흐름에 따라 원래 위치로 돌아옴. */
     /* previously shifted left by 250px; move right 100px from that position -> effectively -150px
         Now shift the 약관동의 button 500px to the right (add 500px) -> -150 + 500 = 350px */
     #action-terms{position:static;margin-left:calc(50% - 15%);align-self:center;padding:8px 12px;transform:translateX(350px)}
    @media (max-width:600px){
        /* mobile: no horizontal shift, keep normal flow */
        #action-terms{margin-left:0;display:inline-block;margin-top:12px;transform:none}
    }
    </style>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LOANDOC - 대출신청</title>
    <style>
        :root{--bg:#f6f6f6;--brand:#2d6cdf;--accent:#FFD400}
        body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;color:#222}
    header{background:var(--brand);color:#fff;padding:28px 20px;text-align:center}
    main{max-width:none;width:100%;margin:24px 0;background:var(--bg);padding:18px 24px;border-radius:8px;box-sizing:border-box}
        .hero{background:#fff;padding:28px;border-radius:8px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.06)}
        .title{font-size:1.4rem;font-weight:800;color:var(--brand)}
        .note{color:#666;font-size:0.95em;margin-top:8px}
        button{background:var(--brand);color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer}
        /* Nav centering and uniform button style */
    nav{display:flex;justify-content:center;gap:10px;padding:12px var(--nav-pad);background:var(--bg);align-items:center;flex-wrap:nowrap;overflow-x:auto;white-space:nowrap}
    .nav-button{background:var(--accent);color:#000;border:none;padding:8px 12px;min-width:100px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;font-size:14px;flex:0 0 auto;box-sizing:border-box}
    /* Action area: left-offset, vertical stacked buttons */
    /* Move the button panel 15% to the right from the left edge */
    .button-panel{margin-left:15%;display:flex;flex-direction:column;gap:12px;padding-top:18px}
    .login-row{display:flex;align-items:center;gap:8px}
    .login-label{color:#000080;font-weight:700}
    /* terms controls: checkbox and 전체 동의 button/text to the right of 약관동의 */
    .terms-controls{display:flex;align-items:center;gap:8px;margin-left:8px}
    .terms-controls .terms-checkbox{width:auto;height:18px;margin:0;padding:0}
    /* Shift the 전체 동의 controls 460px to the right on desktop (40px left from original) */
    @media (min-width:601px) {
        .terms-controls{transform:translateX(460px);transition:transform .18s ease}
    }
    .terms-controls .agree-all-btn{background:var(--brand);color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:13px}
    @media (max-width:600px){.terms-controls{margin-left:0;margin-top:8px}}
    /* 약관 체크리스트 스타일 */
    .terms-list{background:#fff;border:1px solid #e0e6ef;border-radius:8px;padding:12px;margin-top:12px;max-width:80%;box-shadow:0 2px 6px rgba(0,0,0,0.04);/* positioned by script on desktop */}
    .terms-list .term-item{display:flex;align-items:center;gap:10px;padding:6px 4px;border-bottom:1px solid #f1f4fb}
    .terms-list .term-item:last-child{border-bottom:none}
    .terms-list .term-item label{font-size:14px;color:#222;cursor:pointer}
    .terms-list .term-item label:hover{color:var(--brand);text-decoration:underline}
    .term-checkbox{width:18px;height:18px}
    .terms-list-footer{display:flex;justify-content:flex-end;margin-top:12px;padding-top:12px;border-top:1px solid #f1f4fb}
    .terms-view-btn{background:var(--brand);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600}
    /* 약관 상세 팝업 스타일 */
    .terms-modal{display:none;position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);overflow:auto}
    .terms-modal-content{background-color:#fff;margin:5% auto;padding:20px;border:1px solid #888;border-radius:8px;width:80%;max-width:600px;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
    .terms-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid var(--brand)}
    .terms-modal-title{font-size:1.2rem;font-weight:700;color:var(--brand)}
    .terms-modal-close{color:#aaa;font-size:28px;font-weight:bold;cursor:pointer;line-height:20px}
    .terms-modal-close:hover,.terms-modal-close:focus{color:#000}
    .terms-modal-body{max-height:400px;overflow-y:auto;padding:12px 0}
    .terms-modal-item{display:flex;align-items:center;gap:10px;padding:8px 12px;margin-bottom:6px;background:#f9f9f9;border-left:3px solid var(--brand);border-radius:4px}
    .terms-modal-item input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
    .terms-modal-item label{flex:1;cursor:pointer;margin:0}
    .terms-modal-item label:hover{color:var(--brand);text-decoration:underline}
    .terms-modal-footer{display:flex;align-items:center;gap:10px;margin-top:16px;padding-top:16px;border-top:2px solid #e0e6ef;background:#f9f9f9;padding:12px;border-radius:4px}
    .terms-modal-footer input[type="checkbox"]{width:20px;height:20px;cursor:pointer}
    .terms-modal-footer label{font-weight:600;color:#333;cursor:pointer;margin:0}
    /* Content modal (nested) */
    .content-modal{display:none;position:fixed;z-index:10000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.6);overflow:auto}
    .content-modal-content{background-color:#fff;margin:3% auto;padding:20px;border:1px solid #888;border-radius:8px;width:85%;max-width:800px;box-shadow:0 4px 16px rgba(0,0,0,0.4)}
    .content-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid var(--brand)}
    .content-modal-title{font-size:1.1rem;font-weight:700;color:var(--brand)}
    .content-modal-close{color:#aaa;font-size:28px;font-weight:bold;cursor:pointer;line-height:20px}
    .content-modal-close:hover,.content-modal-close:focus{color:#000}
    .content-modal-body{max-height:500px;overflow-y:auto;padding:12px;background:#f9f9f9;border-radius:4px;white-space:pre-wrap;line-height:1.6}
    .content-modal-footer{display:flex;align-items:center;gap:10px;margin-top:16px;padding-top:16px;border-top:2px solid #e0e6ef;background:#f9f9f9;padding:12px;border-radius:4px}
    .content-modal-footer input[type="checkbox"]{width:20px;height:20px;cursor:pointer}
    .content-modal-footer label{font-weight:600;color:#333;cursor:pointer;margin:0}
    @media (max-width:600px){.terms-list{padding:10px;margin-left:0;margin-right:0;position:static;max-width:100%}}
    /* Restore original nav button sizing but keep white/navy styling */
    .action-btn{background:#FFFFFF;color:#000080;border:1px solid #000080;padding:8px 10px;border-radius:8px;height:38px;display:inline-flex;align-items:center;justify-content:center;text-decoration:none;font-weight:700;font-size:14px;box-sizing:border-box;width:calc(100% / 6)}
    /* action-item: put button and its select immediately adjacent (select on the right) */
    .action-item{display:flex;flex-direction:row;gap:4px;align-items:center;margin-bottom:6px}
    .action-item .action-btn{flex:0 0 auto;width:220px;height:38px;padding:8px 10px}
    .action-item .action-select{flex:0 0 auto;margin-left:4px;padding:8px 5px;border-radius:6px;border:1px solid #ddd;background:#fff;font-size:14px;box-sizing:border-box;width:220px;height:38px}
    /* Wrapper for action items that will be horizontally aligned to the login button on desktop */
    .action-items-wrapper{max-width:100%;box-sizing:border-box}
    @media (min-width:601px){
        .action-items-wrapper{margin-left:0}
    }
    @media (max-width:600px){
        /* on narrow screens stack vertically (button above select) */
        .action-item{flex-direction:column;align-items:flex-start}
        .action-item .action-btn, .action-item .action-select{width:100%}
    }
    /* (removed right-align rule so buttons stay adjacent) */
        label{display:block;margin-top:10px}
        input[type=number]{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%;max-width:320px}
        .form-row{margin-top:12px}
    </style>
    <style>
    /* Column based nav (shared) */
    nav.nav-columns{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;padding:10px;background:#f6f6f6;border-radius:10px;align-items:start}
    nav.nav-columns .nav-column{display:flex;flex-direction:column;gap:12px}
    nav.nav-columns .nav-button{background:#FFD400;color:#000;border:none;padding:10px 12px;height:auto;display:block;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;font-size:14px;width:100%;box-sizing:border-box;text-align:center}
    /* removed colored vertical separators for a cleaner top nav */
    nav.nav-columns .nav-column:nth-child(1){padding-right:12px}
    nav.nav-columns .nav-column:nth-child(2){padding:0 12px}
    nav.nav-columns .nav-column:nth-child(3){padding-left:12px}
    nav.nav-columns .nav-column:nth-child(4){padding-left:12px}
    @media (max-width:600px){nav.nav-columns{grid-template-columns:repeat(2,1fr);gap:10px;padding:8px}nav.nav-columns .nav-button{font-size:13px;padding:8px}}
    /* button-panel: match height with terms list area */
    .button-panel{min-height:600px}
    </style>
</head>
<body>
    <header>
        <h1>외국인 근로자 신용 대출</h1>
        <p>LOANDOC</p>
    </header>

    <nav class="nav-columns" aria-label="주요 네비게이션">
        <div class="nav-column">
            <a class="nav-button" href="home.html">LOANDOC</a>
            <a class="nav-button" href="introCo.html">회사소개</a>
                <a class="nav-button" href="intro.html">상품소개</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="login.html">로그인</a>
            <div class="nav-actions">
                <a class="nav-button" href="#" id="nav-logout">로그아웃</a>
            </div>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="loanAppl.html">대출조회</a>
                <a class="nav-button" href="loanDashboard.html">대출상담요청게시판</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="dashboard.html">게시판</a>
            <a class="nav-button" href="customer.html">고객센터</a>
        </div>
    </nav>
    <hr />
    <style>
        /* Reduce vertical gaps between nav and input area */
        header { margin-bottom: 4px; }
        nav.nav-columns { margin-bottom: 4px; }
        /* Make hr slimmer and reduce its vertical margins */
        hr { margin: 6px 0; border: none; border-top: 1px solid #e6e9ef; }
        main { margin-top: 0; padding-top: 0; }
        .button-panel { margin-top: 4px; padding-top: 0; }
    </style>
    <!-- 환경 선택: 항상 상단에 표시 (label 제거) -->
    <div style="width:100%;display:flex;justify-content:flex-end;align-items:center;margin:8px 0 0 0;padding:0 24px 0 0;gap:8px;">
        <select id="env-select" style="margin-left:0;padding:6px 12px;border-radius:6px;border:1px solid #ccc;font-size:1em;width:120px;">
            <option value="prod" selected>운영</option>
            <option value="test">테스트</option>
        </select>
    </div>
    <main>
        <!-- All action buttons vertically aligned in a single column -->
        <div class="button-panel" style="display: flex; flex-direction: column; padding-left: 6.25%; margin-left: 0px;">
            <!-- 로그인 & 약관동의 in same row -->
            <div style="display: flex; align-items: center; gap: 8px;">
                <div class="action-item">
                    <a id="action-login" class="action-btn" href="#">로그인</a>
                    <span id="login-label" class="login-label" aria-live="polite"></span>
                    <span id="user-name-label" class="login-label" aria-live="polite" style="margin-left:8px;"></span>
                    <button id="logout-btn" class="action-btn" style="display:none; background:#dc3545; color:#fff; margin-left:8px; padding:8px 12px; border:none; cursor:pointer; border-radius:8px;">로그인</button>
                </div>
                <a id="action-terms" class="action-btn" href="#">약관동의</a>
                <span class="terms-controls" aria-hidden="false">
                    <input id="terms-checkbox" class="terms-checkbox" type="checkbox" aria-label="전체 약관 동의" />
                    <button id="agree-all-btn" class="agree-all-btn" type="button">전체 동의</button>
                </span>
            </div>

            <!-- 약관 체크리스트 -->
            <div id="terms-list" class="terms-list" aria-label="약관 체크리스트">
                <div id="terms-loading">로딩 중...</div>
            </div>
            
            <!-- 국가 -->
            <div class="action-item">
                <a id="nationality" class="action-btn" href="#">국가</a>
                <select id="action-nationality" class="action-select" name="nationality">
                    <option value="">선택</option>
                    <option>Cambodia</option>
                    <option>Bangladesh</option>
                    <option>China</option>
                    <option>East Timor</option>
                    <option>India</option>
                    <option>Indonesia</option>
                    <option>Kazakhstan</option>
                    <option>Kyrgyzstan</option>
                    <option>Laos</option>
                    <option>Myanmar</option>
                    <option>Nepal</option>
                    <option>Pakistan</option>
                    <option>Philippines</option>
                    <option>Sri Lanka</option>
                    <option>Thailand</option>
                    <option>Uzbekistan</option>
                    <option>Vietnam</option>
                </select>
            </div>

            <!-- 잔여체류기간 -->
            <div class="action-item">
                <a id="remain-months-btn" class="action-btn" href="#">잔여체류기간(월수)</a>
                <input id="remain_months" class="action-select" type="number" min="0" placeholder="개월" aria-labelledby="remain-months-btn">
            </div>
            
            <!-- 연소득 -->
            <div class="action-item">
                <a id="annual-income-btn" class="action-btn" href="#">연소득 (단위:만원)</a>
                <input id="annual_income" class="action-select" type="number" min="0" step="1" placeholder="단위: 만원" aria-labelledby="annual-income-btn">
            </div>
            
            <!-- 나이 -->
            <div class="action-item">
                <a id="age-btn" class="action-btn" href="#">나이</a>
                <input id="age" class="action-select" type="number" min="0" max="120" placeholder="세" aria-labelledby="age-btn">
            </div>
            
            <!-- 재직기간 -->
            <div class="action-item">
                <a id="working-months-btn" class="action-btn" href="#">재직기간(월수)</a>
                <input id="working_months" class="action-select" type="number" min="0" placeholder="개월" aria-labelledby="working-months-btn">
            </div>
            
            <!-- 비자종류 -->
            <div class="action-item">
                <a id="visa-type-btn" class="action-btn" href="#">비자종류</a>
                <select id="visa_type" class="action-select" aria-labelledby="visa-type-btn">
                    <option value="">선택</option>
                    <option value="E9">E-9 (비전문취업)</option>
                    <option value="E7">E-7 (전문취업)</option>
                    <option value="F2">F-2 (거주)</option>
                    <option value="F4">F-4 (재외동포)</option>
                    <option value="F5">F-5 (영주)</option>
                    <option value="F6">F-6 (결혼이민)</option>
                </select>
            </div>
            
            <!-- 의료보험 종류 -->
            <div class="action-item">
                <a id="health-insurance-btn" class="action-btn" href="#">의료보험 종류</a>
                <select id="health_insurance" class="action-select" aria-labelledby="health-insurance-btn">
                    <option value="">선택</option>
                    <option value="지역">지역</option>
                    <option value="직장">직장</option>
                </select>
            </div>
        </div>
    </main>

    <!-- 대출 결과 섹션 -->
    <div id="result-section" style="display:none;max-width:none;width:100%;margin:-200px 0 0 0;background:#f6f6f6;padding:8px 24px;border-radius:8px;box-sizing:border-box;">
        <div style="background:#fff;padding:12px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.06);overflow-x:auto;width:calc(100% - 100px);max-width:calc(100% - 100px);margin:0 auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:20px;margin:8px 0;">
                <div style="display:flex;justify-content:center;align-items:center;gap:20px;flex:1;">
                    <h2 style="font-size:1.4rem;font-weight:800;color:#2d6cdf;margin:0;text-align:center;">대출 조회 결과</h2>
                    <div style="display:flex;gap:15px;align-items:center;">
                        <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
                            <input type="radio" name="sortOption" value="rate" checked style="cursor:pointer;">
                            <span>예상금리로 조회</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
                            <input type="radio" name="sortOption" value="limit" style="cursor:pointer;">
                            <span>예상한도로 조회</span>
                        </label>
                        <div class="action-item">
                            <select id="env-select-result" class="action-select">
                                <option value="prod" selected>운영</option>
                                <option value="test">테스트</option>
                                <option value="setting">설정</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <style>
                /* Result table styling: distinguish header/title rows and data rows */
                /* Header rows (those above tbody) */
                #result-table > tr,
                #result-table > thead > tr {
                    background: #e9f2ff;
                    color: #123f90;
                    font-weight: 800;
                }
                /* Data rows: alternate subtle backgrounds for readability */
                #result-table tbody tr:nth-child(even) {
                    background: #fafafa;
                }
                #result-table tbody tr:nth-child(odd) {
                    background: #ffffff;
                }
                /* Cell padding and lighter borders */
                #result-table td, #result-table th {
                    padding: 8px 6px;
                    border: 1px solid #e6e9ef;
                }
                /* Ensure action buttons and nav buttons do not change mouse cursor */
                .action-btn, .nav-button {
                    cursor: default !important;
                }

                /* Reduce vertical gaps between input controls (login, 국가, 잔여체류기간, 연소득, 의료보험 등) */
                .button-panel {
                    gap: 6px !important; /* smaller gap between stacked items */
                    padding-left: 6.25%;
                    margin-top: 4px !important;
                }

                .button-panel .action-item {
                    margin-bottom: 4px !important; /* reduce space below each item */
                    padding-top: 2px;
                    padding-bottom: 2px;
                }

                /* Reduce spacing inside action buttons/selects */
                .action-btn {
                    margin: 0 6px 0 0 !important;
                    padding: 6px 8px !important;
                }
                .action-select {
                    margin: 0 !important;
                    padding: 6px 8px !important;
                }
            </style>
            <table id="result-table" style="min-width:1300px;width:calc(100% - 100px);border-collapse:collapse;text-align:center;">
                <thead>
                    <tr>
                        <th>순위</th>
                        <th>은행명</th>
                        <th>결과</th>
                        <th>신청</th>
                        <th>예상한도</th>
                        <th>예상금리</th>
                        <th>비자종류</th>
                        <th>국가</th>
                        <th>나이</th>
                        <th>연소득</th>
                        <th>재직기간</th>
                        <th>의료보험</th>
                        <th>잔여체류기간</th>
                        <th style="color:#123f90;font-weight:800;">통신 상태</th>
                    </tr>
                </thead>
                <tbody id="result-tbody">
                    <!-- Results will be inserted here -->
                </tbody>
                <tr>
                    <td colspan="14" style="text-align:left;padding:10px;line-height:1.6;">
                        <strong>참고:</strong><br>
                        1. O는 조건 충족, X는 조건 미충족을 의미합니다.<br>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!-- 약관 상세 팝업 모달 -->
    <div id="terms-modal" class="terms-modal">
        <div class="terms-modal-content">
            <div class="terms-modal-header">
                <h2 class="terms-modal-title" id="modal-title">약관 상세</h2>
                <span class="terms-modal-close" id="modal-close">&times;</span>
            </div>
            <div class="terms-modal-body" id="modal-body">
                <p>로딩 중...</p>
            </div>
        </div>
    </div>

    <!-- 약관 내용 팝업 모달 (nested) -->
    <div id="content-modal" class="content-modal">
        <div class="content-modal-content">
            <div class="content-modal-header">
                <h2 class="content-modal-title" id="content-modal-title">약관 내용</h2>
                <span class="content-modal-close" id="content-modal-close">&times;</span>
            </div>
            <div class="content-modal-body" id="content-modal-body">
                <p>로딩 중...</p>
            </div>
            <div class="content-modal-footer" id="content-modal-footer" style="display:none;">
                <input type="checkbox" id="content-modal-agree">
                <label for="content-modal-agree">상기 내용에 대해 충분히 이해하였으며, 이에 동의 합니다</label>
            </div>
        </div>
    </div>

    <script>
        // 전역 에러/미처리 프로미스 리젝션 로깅: 확장(extension) 메시지 오류인지, 페이지 코드인지 확인하기 위함
        window.addEventListener('unhandledrejection', function(e) {
            try {
                console.error('Unhandled promise rejection (captured):', e.reason);
                // If the rejection is an Error, print stack for deeper inspection
                if (e.reason && e.reason.stack) console.error(e.reason.stack);
            } catch (err) {
                console.error('Error while logging unhandledrejection:', err);
            }
        });

        window.addEventListener('error', function(e) {
            try {
                console.error('Global window error:', e.message, 'at', e.filename + ':' + e.lineno + ':' + e.colno);
                if (e.error && e.error.stack) console.error(e.error.stack);
            } catch (err) {
                console.error('Error while logging window.onerror:', err);
            }
        });

        // 세션 확인 및 로그인 상태 표시
        let currentUserId = null;

        // 환경 모드: 운영/테스트
        let testMode = false;

        // 은행 정보 (데이터베이스에서 로드)
        let bank_info = [];
        let test_bank_info = [];

        // 대출 결과 데이터 저장 (정렬 옵션 변경 시 재사용)
        let lastLoanResult = null;
        let lastInputData = null;

        // 은행 정보를 데이터베이스에서 가져오는 함수
        async function loadBankInfo(mode) {
            try {
                const modeParam = mode === 'test' ? 'test' : 'prod';
                const response = await fetch(`/server/api/bank-info?mode=${modeParam}`);
                if (!response.ok) {
                    throw new Error('Failed to load bank info');
                }
                const data = await response.json();
                if (mode === 'test') {
                    test_bank_info = data;
                } else {
                    bank_info = data;
                }
                return data;
            } catch (error) {
                console.error('Error loading bank info:', error);
                // Fallback to empty array
                return mode === 'test' ? (test_bank_info = []) : (bank_info = []);
            }
        }

        // 초기 로드: 운영 모드와 테스트 모드 모두 로드
        loadBankInfo('prod');
        loadBankInfo('test');

        // env-select 값 변경 시 testMode 설정 및 은행 정보 재로드
        // 모든 env-select 요소에 이벤트 리스너 추가
        function updateTestMode() {
            let envValue = '';
            // 결과 섹션이 표시되어 있으면 env-select-result를 우선 확인
            const resultSection = document.getElementById('result-section');
            const envSelectResult = document.getElementById('env-select-result');
            
            if (resultSection && resultSection.style.display !== 'none' && envSelectResult && envSelectResult.value !== 'setting') {
                envValue = envSelectResult.value;
            } else {
                // 결과 섹션이 없거나 표시되지 않았으면 상단의 env-select 확인
                const envSelect = document.getElementById('env-select');
                envValue = envSelect ? envSelect.value : '';
            }
            
            testMode = (envValue === 'test' || envValue === 'Test' || envValue === 'TEST');
            
            // 모드 변경 시 해당 모드의 은행 정보가 없으면 로드
            const currentBanks = testMode ? test_bank_info : bank_info;
            if (currentBanks.length === 0) {
                loadBankInfo(testMode ? 'test' : 'prod');
            }
        }
        
        // 초기 로드 시 testMode 설정
        updateTestMode();
        
        // env-select 변경 이벤트 리스너
        document.getElementById('env-select')?.addEventListener('change', function(e) {
            updateTestMode();
        });

        // 결과 섹션의 env-select 변경 이벤트 리스너 (설정 선택 시 loanTest.html로 이동)
        document.getElementById('env-select-result')?.addEventListener('change', function(e) {
            if (e.target.value === 'setting') {
                window.location.href = 'loanTest.html';
            } else {
                // 운영/테스트 선택 시 testMode 업데이트
                updateTestMode();
            }
        });

        // 조건 체크 함수 (간단 예시)
        function checkBankEligibility(bank, input) {
            // 실제 조건은 필요에 따라 수정
            // O: 조건 충족, X: 미충족
            // input: {nationality, age, visaType, ...}
            const result = {
                visa: 'O',
                country: 'O',
                age: 'O',
                income: 'O',
                working: 'O',
                remain: 'O'
            };
            // 예시: 나이 20~60세만 O
            if (!input.age || input.age < 20 || input.age > 60) result.age = 'X';
            // 예시: 연소득 1000만원 이상만 O
            if (!input.annualIncome || input.annualIncome < 1000) result.income = 'X';
            // 예시: 재직기간 6개월 이상만 O
            if (!input.workingMonths || input.workingMonths < 6) result.working = 'X';
            // 예시: 잔여체류기간 3개월 이상만 O
            if (!input.remainMonths || input.remainMonths < 3) result.remain = 'X';
            // 예시: 비자종류 필수
            if (!input.visaType) result.visa = 'X';
            // 예시: 국가 필수
            if (!input.nationality) result.country = 'X';
            return result;
        }

        // Format an error value for display in popups: hide empty / zero-like values
        function fmtError(val) {
            if (val === null || val === undefined) return '';
            // treat empty string and numeric zero as "no error"
            if (typeof val === 'string' && val.trim() === '') return '';
            if (typeof val === 'number' && val === 0) return '';
            return String(val);
        }

        // Build a short comma-separated list of country debug flags (e.g. China, India)
        function countryFlagsText(countryDebug) {
            if (!countryDebug || typeof countryDebug !== 'object') return '';
            const keys = [];
            for (const k of Object.keys(countryDebug)) {
                if (k === 'natLower') continue;
                if (countryDebug[k]) {
                    // remove leading 'is' if present and capitalize
                    let label = k.replace(/^is/, '');
                    label = label.charAt(0).toUpperCase() + label.slice(1);
                    keys.push(label);
                }
            }
            return keys.join(', ');
        }

        // -------- 전북은행(Jeonbuk) 클라이언트 규칙 매핑 --------
        // 이 맵에 X(대출불가) 규칙을 구성하면 서버 응답을 렌더링하기 전에
        // 전북은행 항목에 대해 client-side에서 '불가'로 표시합니다.
        // 각 키는 비자종류(예: 'E-9', 'F-4', 'F-2' 등)이고 값은 해당 비자종류에서
        // 대출불가로 처리할 국가명 배열입니다. 국가명은 한국어/영어 모두 매치하도록
        // 소문자 정규화를 사용합니다. 필요하면 이 맵을 수정하세요.
        const JEONBUK_COUNTRY_KEYWORDS = {
            china: ['china', '중국'],
            india: ['india', '인도'],
            uzbekistan: ['uzbekistan', 'uzbek', '우즈베키스탄', '우즈벡'],
            kazakhstan: ['kazakhstan', 'kazakh', '카자흐스탄', '카자흐'],
            vietnam: ['vietnam', '베트남'],
            philippines: ['philippines', 'philippine', '필리핀'],
            cambodia: ['cambodia', '캄보디아'],
            nepal: ['nepal', '네팔'],
            indonesia: ['indonesia', '인도네시아'],
            myanmar: ['myanmar', '미얀마', 'burma', '버마'],
            bangladesh: ['bangladesh', '방글라데시'],
            thailand: ['thailand', '태국'],
            srilanka: ['sri lanka', 'srilanka', '스리랑카'],
            pakistan: ['pakistan', '파키스탄'],
            kyrgyzstan: ['kyrgyzstan', 'kyrgyz', '키르기스스탄', '키르기스'],
            laos: ['laos', '라오스'],
            easttimor: ['east timor', 'timor', 'timor-leste', '동티모르']
        };

        function expandJeonbukCountries(keys) {
            const seen = new Set();
            const result = [];
            keys.forEach(key => {
                const aliases = JEONBUK_COUNTRY_KEYWORDS[key] || [key];
                aliases.forEach(raw => {
                    const token = String(raw).trim().toLowerCase();
                    if (!seen.has(token) && token) {
                        seen.add(token);
                        result.push(token);
                    }
                });
            });
            return result;
        }

        const JEONBUK_BLOCK_RULES = {
            'E-9': expandJeonbukCountries(['china', 'india']),
            'F-4': expandJeonbukCountries([
                'china','india','vietnam','philippines','cambodia','nepal','indonesia',
                'myanmar','bangladesh','thailand','srilanka','pakistan','kyrgyzstan','laos','easttimor'
            ]),
            'F-2': expandJeonbukCountries(['india']),
            'F-5': expandJeonbukCountries(['india']),
            'F-6': expandJeonbukCountries(['india']),
            'E-7': []
        };

        function normalizeCountryName(nat) {
            if (!nat) return '';
            return String(nat).trim().toLowerCase();
        }

        function isJeonbukBlockedByRule(nationality, visaType) {
            if (!visaType) return false;
            // Normalize visa variants to match keys like 'E-9' or 'E9' etc.
            const raw = String(visaType).trim();
            const up = raw.toUpperCase();
            const candidates = new Set([
                raw,
                up,
                raw.replace(/[-\s]/g, ''),
                up.replace(/[-\s]/g, '')
            ]);
            // If format is like 'E9' generate 'E-9' to match existing keys
            if (/^[A-Z]\d+$/i.test(up)) {
                candidates.add(up[0] + '-' + up.slice(1));
            }

            // Find rules by trying candidate keys
            let rules = null;
            for (const k of candidates) {
                if (Object.prototype.hasOwnProperty.call(JEONBUK_BLOCK_RULES, k)) {
                    rules = JEONBUK_BLOCK_RULES[k];
                    break;
                }
            }

            if (!Array.isArray(rules) || rules.length === 0) return false;

            const natNorm = normalizeCountryName(nationality);
            for (const r of rules) {
                if (!r) continue;
                if (natNorm === String(r).trim().toLowerCase()) return true;
            }
            return false;
        }

        // 앱 컨텍스트 자동 감지
        const APP_BASE = (function(){
            try{
                const p = window.location.pathname || '';
                const m = p.match(/^\/(?<ctx>[^\/]+)\//);
                return (m && m.groups && m.groups.ctx) ? ('/' + m.groups.ctx) : '';
            }catch(e){ return ''; }
        })();
        const EFFECTIVE_BASE = APP_BASE || '';

        // 접근 시간 확인 및 자동 로그아웃 처리
        function checkAccessTime() {
            // 이미 리다이렉트 중이면 실행하지 않음
            if(isRedirecting) return false;
            
            try {
                const loginId = localStorage.getItem('login-id');
                const accessTimeStr = localStorage.getItem('login-access-time');
                
                if (!loginId || !accessTimeStr) {
                    // 로그인 정보가 없으면 로그인 페이지로 리다이렉트
                    isRedirecting = true; // 리다이렉트 중 플래그 설정
                    loginPromptShown = true; // 알림 표시 플래그 설정
                    alert('로그인이 필요합니다. 로그인 페이지로 이동합니다.');
                    window.location.href = 'login.html';
                    return false;
                }
                
                // 접근 시간 확인 (10분 = 600000 밀리초)
                const accessTime = new Date(accessTimeStr);
                const currentTime = new Date();
                const timeDiff = currentTime.getTime() - accessTime.getTime();
                const tenMinutes = 10 * 60 * 1000; // 10분
                
                if (timeDiff > tenMinutes) {
                    // 10분 이상 경과 시 자동 로그아웃
                    isRedirecting = true; // 리다이렉트 중 플래그 설정
                    loginPromptShown = true; // 알림 표시 플래그 설정
                    localStorage.removeItem('login-id');
                    localStorage.removeItem('login-access-time');
                    alert('10분 이상 비활성 상태로 인해 자동 로그아웃되었습니다. 다시 로그인해주세요.');
                    window.location.href = 'login.html';
                    return false;
                }
                
                // 접근 시간 업데이트
                localStorage.setItem('login-access-time', new Date().toISOString());
                return true;
            } catch (e) {
                console.error('Access time check error', e);
                if(!isRedirecting) {
                    isRedirecting = true; // 리다이렉트 중 플래그 설정
                    loginPromptShown = true; // 알림 표시 플래그 설정
                    alert('로그인 확인 중 오류가 발생했습니다. 로그인 페이지로 이동합니다.');
                    window.location.href = 'login.html';
                }
                return false;
            }
        }

        // 페이지 로드 시 localStorage에서 로그인 상태 업데이트
        function checkLoginStatus() {
            // 리다이렉트 중이면 실행하지 않음
            if(isRedirecting) return;
            
            try {
                // 먼저 접근 시간 확인
                if (!checkAccessTime()) {
                    isRedirecting = true; // 리다이렉트 중 플래그 설정
                    currentUserId = null;
                    updateLoginDisplay(null);
                    return;
                }
                
                const loginId = localStorage.getItem('login-id');
                
                if (loginId && loginId.trim() !== '') {
                    currentUserId = loginId.trim();
                    updateLoginDisplay(loginId.trim());
                } else {
                    currentUserId = null;
                    updateLoginDisplay(null);
                }
            } catch (e) {
                console.error('Login check error', e);
                currentUserId = null;
                updateLoginDisplay(null);
            }
        }

        // 로그인 버튼과 라벨 업데이트
        async function updateLoginDisplay(userId) {
            const actionLogin = document.getElementById('action-login');
            const loginLabel = document.getElementById('login-label');
            const userNameLabel = document.getElementById('user-name-label');
            
            // 항상 '로그인'만 표시
            if (actionLogin) {
                actionLogin.textContent = '로그인';
                actionLogin.href = '#';
            }
            
            if (loginLabel) {
                if (userId) {
                    loginLabel.textContent = userId;
                    loginLabel.style.display = 'inline';
                    // 사용자 이름 가져오기
                    if (userNameLabel) {
                        try {
                            // GET 방식으로 login-id를 쿼리 파라미터로 전달
                            const url = `/server/api/foreign_worker_master?login-id=${encodeURIComponent(userId)}`;
                            const response = await fetch(url, { credentials: 'include' });
                            const result = await response.json();
                            if (result.ok && result.found && result.data && result.data.name) {
                                userNameLabel.textContent = '(' + result.data.name + ')';
                                userNameLabel.style.display = 'inline';
                            } else {
                                userNameLabel.textContent = '';
                                userNameLabel.style.display = 'none';
                                // 이름이 없으면 알림창을 띄우고 개인정보 입력/로그인 선택
                                const goInfo = window.confirm('개인정보(이름)가 없습니다.\n개인정보 입력 화면으로 이동하시겠습니까?\n취소를 누르면 로그인 화면으로 이동합니다.');
                                if (goInfo) {
                                    window.location.href = 'workerInfo.html';
                                } else {
                                    window.location.href = 'login.html';
                                }
                            }
                        } catch (error) {
                            console.error('이름 로드 오류:', error);
                            userNameLabel.textContent = '';
                            userNameLabel.style.display = 'none';
                        }
                    }
                } else {
                    loginLabel.textContent = '';
                    loginLabel.style.display = 'none';
                    if (userNameLabel) {
                        userNameLabel.textContent = '';
                        userNameLabel.style.display = 'none';
                    }
                    // userId가 없으면 UI만 업데이트 (알림은 requireLoginPromptOnLoad에서 처리)
                }
            }
        }

        // 로그인 버튼 이벤트 리스너 삭제됨 (사용자 요청)

        // 네비게이션 로그아웃 버튼 이벤트
        const navLogout = document.getElementById('nav-logout');
        if(navLogout){
            navLogout.addEventListener('click', async function(e){
                e.preventDefault();
                try {
                    const response = await fetch('/server/api/auth/logout', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 'login-id': null })
                    });
                    const result = await response.json();
                    if (result.ok) {
                    // localStorage에서 login-id와 접근 시간 제거
                    localStorage.removeItem('login-id');
                    localStorage.removeItem('login-access-time');
                    alert('로그아웃이 정상적으로 되었습니다');
                    window.location.href = 'login.html';
                    }
                } catch (err) {
                    console.error('Logout error', err);
                }
            });
        }

        const actionProfile = document.getElementById('action-profile');
        if(actionProfile){
            actionProfile.addEventListener('click', function(e){
                e.preventDefault();
                // localStorage 제거됨 - 항상 회원가입 페이지로 이동
                window.location.href = 'signup.html';
            });
        }

        // 대출신청 버튼: require login
        const actionApply = document.getElementById('action-apply');
        if(actionApply){
            actionApply.addEventListener('click', function(e){
                e.preventDefault();
                // localStorage 제거됨 - 항상 로그인 페이지로 이동
                window.location.href = 'login.html';
            });
        }

        // 약관동의 버튼 이벤트 리스너 삭제됨 (사용자 요청)

        // Load terms checklist from server and render as checkboxes.
        // Assumption: server exposes a JSON endpoint at /api/documents/groups
        // which returns an array of { group_name: string, select_option: string }
       /* async function loadTermsList(){
            const container = document.getElementById('terms-list');
            if(!container) return;
            const loading = document.getElementById('terms-loading');
            try{
                // Use absolute path for consistent routing
                const res = await fetch('/server/api/documents/groups');
                if(!res.ok) throw new Error('네트워크 오류');
                let text = await res.text();
                let items = null;
                try {
                    items = JSON.parse(text);
                } catch(parseErr) {
                    // JSON 파싱 실패: HTML 등 비정상 응답
                    let preview = text.slice(0, 120);
                    alert('목록 불러오기 실패: 서버에서 올바른 JSON이 반환되지 않았습니다.\n\n응답 미리보기:\n' + preview);
                    if(loading) loading.textContent = '목록 불러오기 실패: 서버 응답이 올바르지 않습니다.';
                    console.error('loadTermsList: JSON parse error', parseErr, '\n서버 응답:', preview);
                    return;
                }
                // Expect items to be an array of {group_name, select_option}
                container.innerHTML = '';
                if(!Array.isArray(items) || items.length === 0){
                    container.textContent = '약관 항목이 없습니다.';
                    return;
                }
                items.forEach((it, idx)=>{
                    const div = document.createElement('div');
                    div.className = 'term-item';
                    const chk = document.createElement('input');
                    chk.type = 'checkbox';
                    chk.className = 'term-checkbox';
                    chk.id = 'term-' + idx;
                    chk.setAttribute('data-select-option', it.select_option || '');
                    chk.setAttribute('data-group-name', it.group_name || '');

                    // Add change handler to sync with top-level checkbox
                    chk.addEventListener('change', function(e){
                        const topTermsCheckbox = document.getElementById('terms-checkbox');
                        if(!topTermsCheckbox) return;
                        // Get all term checkboxes
                        const allTermCheckboxes = document.querySelectorAll('#terms-list .term-checkbox');
                        const checkedCount = Array.from(allTermCheckboxes).filter(cb => cb.checked).length;
                        // If all are checked, check the top-level checkbox
                        // If any is unchecked, uncheck the top-level checkbox
                        if(checkedCount === allTermCheckboxes.length){
                            topTermsCheckbox.checked = true;
                        } else {
                            topTermsCheckbox.checked = false;
                        }
                    });

                    const label = document.createElement('label');
                    label.htmlFor = chk.id;
                    // [필수] 또는 [선택] prefix 붙이기
                    let prefix = '';
                    if(it.select_option && it.select_option.includes('필수')) {
                        prefix = '[필수] ';
                    } else if(it.select_option && it.select_option.includes('선택')) {
                        prefix = '[선택] ';
                    }
                    label.textContent = prefix + (it.group_name || '');

                    // Add click handler to label to show details
                    label.addEventListener('click', function(e){
                        e.preventDefault();
                        // Extract group_name without prefix
                        const groupName = it.group_name || '';
                        showTermDetails(groupName);
                    });

                    div.appendChild(chk);
                    div.appendChild(label);
                    container.appendChild(div);
                });

                // Add footer with view button
                const footer = document.createElement('div');
                footer.className = 'terms-list-footer';
                const viewBtn = document.createElement('button');
                viewBtn.className = 'terms-view-btn';
                viewBtn.textContent = '조회';
                viewBtn.type = 'button';
                viewBtn.addEventListener('click', async function() {
                    // 입력값 수집
                    const input = {
                        nationality: document.getElementById('action-nationality')?.value,
                        remainMonths: parseInt(document.getElementById('remain_months')?.value),
                        annualIncome: parseInt(document.getElementById('annual_income')?.value),
                        age: parseInt(document.getElementById('age')?.value),
                        workingMonths: parseInt(document.getElementById('working_months')?.value),
                        visaType: document.getElementById('visa_type')?.value,
                        healthInsurance: document.getElementById('health_insurance')?.value
                    };
                    // testMode가 true면 test_bank_info만 사용
                    // 은행 정보가 없으면 먼저 로드
                    const currentBanks = testMode ? test_bank_info : bank_info;
                    if (currentBanks.length === 0) {
                        await loadBankInfo(testMode ? 'test' : 'prod');
                    }
                    const banks = testMode ? test_bank_info : bank_info;
                    // 서버에서 이미 use_it=1인 데이터만 조회하므로 필터링 불필요
                    // 결과 테이블 tbody
                    const tbody = document.getElementById('result-tbody');
                    tbody.innerHTML = '';
                    banks.forEach((bank, idx) => {
                        const check = checkBankEligibility(bank, input);
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${idx+1}</td>
                            <td>${bank.bank_name}</td>
                            <td>${Object.values(check).every(v=>v==='O') ? 'O' : 'X'}</td>
                            <td><button class="loan-apply-btn" ${Object.values(check).every(v=>v==='O')?'':'disabled'}>신청</button></td>
                            <td>${bank.max_limit.toLocaleString()}</td>
                            <td>${bank.current_rate}</td>
                            <td>${input.visaType||'-'} (${check.visa})</td>
                            <td>${input.nationality||'-'} (${check.country})</td>
                            <td>${input.age||'-'} (${check.age})</td>
                            <td>${input.annualIncome||'-'} (${check.income})</td>
                            <td>${input.workingMonths||'-'} (${check.working})</td>
                            <td>${input.healthInsurance||'-'}</td>
                            <td>${input.remainMonths||'-'} (${check.remain})</td>
                            <td>OK</td>
                        `;
                        tbody.appendChild(tr);
                    });
                    // 결과 섹션 보이기
                    document.getElementById('result-section').style.display = 'block';
                });
                footer.appendChild(viewBtn);
                container.appendChild(footer);
                // Position the terms list to align with the left edge of the 약관동의 button on desktop.
                // If the function isn't available (older browsers), this will silently fail.
                if (typeof positionTermsList === 'function') {
                    positionTermsList();
                }
            }catch(err){
                if(loading) loading.textContent = '약관 항목을 불러오는 중 오류가 발생했습니다.';
                console.error('loadTermsList error', err);
            }
        }
*/
async function loadTermsList(){
            const container = document.getElementById('terms-list');
            if(!container) return;
            const loading = document.getElementById('terms-loading');
            try{
                // Use absolute path for consistent routing
                const res = await fetch('/server/api/documents/groups');
                if(!res.ok) throw new Error('네트워크 오류');
                const items = await res.json();
                // Expect items to be an array of {group_name, select_option}
                container.innerHTML = '';
                if(!Array.isArray(items) || items.length === 0){
                    container.textContent = '약관 항목이 없습니다.';
                    return;
                }
                items.forEach((it, idx)=>{
                    const div = document.createElement('div');
                    div.className = 'term-item';
                    const chk = document.createElement('input');
                    chk.type = 'checkbox';
                    chk.className = 'term-checkbox';
                    chk.id = 'term-' + idx;
                    chk.setAttribute('data-select-option', it.select_option || '');
                    chk.setAttribute('data-group-name', it.group_name || '');

                    // Add change handler to sync with top-level checkbox
                    chk.addEventListener('change', function(e){
                        const topTermsCheckbox = document.getElementById('terms-checkbox');
                        if(!topTermsCheckbox) return;
                        // Get all term checkboxes
                        const allTermCheckboxes = document.querySelectorAll('#terms-list .term-checkbox');
                        const checkedCount = Array.from(allTermCheckboxes).filter(cb => cb.checked).length;
                        // If all are checked, check the top-level checkbox
                        // If any is unchecked, uncheck the top-level checkbox
                        if(checkedCount === allTermCheckboxes.length){
                            topTermsCheckbox.checked = true;
                        } else {
                            topTermsCheckbox.checked = false;
                        }
                    });

                    const label = document.createElement('label');
                    label.htmlFor = chk.id;
                    // [필수] prefix 붙이기 (select_option에 '필수'가 포함된 경우)
                    let displayText = '';
                    if(it.select_option && it.select_option.includes('필수')) {
                        displayText = '[필수] ' + (it.group_name || '');
                    } else if(it.select_option && it.select_option.includes('선택')) {
                        displayText = '[선택] ' + (it.group_name || '');
                    } else {
                        // select_option이 없거나 명시되지 않은 경우 기본적으로 [필수]로 표시
                        displayText = '[필수] ' + (it.group_name || '');
                    }
                    label.textContent = displayText;

                    // Add click handler to label to show details
                    label.addEventListener('click', function(e){
                        e.preventDefault();
                        // Extract group_name without prefix for API call
                        const groupName = it.group_name || '';
                        showTermDetails(groupName);
                    });

                    div.appendChild(chk);
                    div.appendChild(label);
                    container.appendChild(div);
                });

                // Add footer with view button
                const footer = document.createElement('div');
                footer.className = 'terms-list-footer';
                const viewBtn = document.createElement('button');
                viewBtn.className = 'terms-view-btn';
                viewBtn.textContent = '조회';
                viewBtn.type = 'button';
                
                // Store the click handler function for reuse
                const queryClickHandler = async function(){
                    // Check all checkboxes
                    const allCheckboxes = document.querySelectorAll('#terms-list .term-checkbox');
                    const checked = Array.from(allCheckboxes).filter(cb => cb.checked);
                    
                    // Find required terms (select_option contains '필수')
                    const requiredUnchecked = Array.from(allCheckboxes).filter(cb => {
                        const selectOption = cb.getAttribute('data-select-option') || '';
                        return selectOption.includes('필수') && !cb.checked;
                    });
                    
                    // Alert if any required terms are unchecked
                    if(requiredUnchecked.length > 0){
                        console.warn('필수 약관의 동의가 필요합니다');
                        return;
                    }
                    
                    if(checked.length === 0){
                        console.warn('필수 약관을 체크해주세요.');
                        return;
                    }
                    
                    // Collect form data
                    const loginId = currentUserId; // 서버 세션에서 가져온 사용자 ID 사용
                    const nationality = document.getElementById('action-nationality')?.value || '';
                    const remainMonths = document.getElementById('remain_months')?.value || '';
                    const annualIncome = document.getElementById('annual_income')?.value || '';
                    const age = document.getElementById('age')?.value || '';
                    const workingMonths = document.getElementById('working_months')?.value || '';
                    const visaType = document.getElementById('visa_type')?.value || '';
                    const healthInsurance = document.getElementById('health_insurance')?.value || '';
                    
                    // Debug: Log all field values
                    console.log('=== 입력 필드 확인 ===');
                    console.log('로그인ID:', loginId, '(서버 세션 필요)');
                    console.log('국가:', nationality, '(element:', document.getElementById('action-nationality'), ')');
                    console.log('잔여체류기간:', remainMonths, '(element:', document.getElementById('remain_months'), ')');
                    console.log('연소득:', annualIncome, '(element:', document.getElementById('annual_income'), ')');
                    console.log('나이:', age, '(element:', document.getElementById('age'), ')');
                    console.log('재직기간:', workingMonths, '(element:', document.getElementById('working_months'), ')');
                    console.log('비자종류:', visaType, '(element:', document.getElementById('visa_type'), ')');
                    console.log('의료보험:', healthInsurance, '(element:', document.getElementById('health_insurance'), ')');
                    
                    // Validate required fields
                    const missingFields = [];
                    if(!loginId) missingFields.push('로그인ID (로그인이 필요합니다)');
                    if(!nationality) missingFields.push('국가');
                    if(!remainMonths) missingFields.push('잔여체류기간');
                    if(!annualIncome) missingFields.push('연소득');
                    if(!age) missingFields.push('나이');
                    if(!workingMonths) missingFields.push('재직기간');
                    if(!visaType) missingFields.push('비자종류');
                    
                    if(missingFields.length > 0){
                        console.error('누락된 필드:', missingFields);
                        console.warn('모든 필드를 입력해주세요. 누락된 필드: ' + missingFields.join(', '));
                        return;
                    }
                    
                    // env-select의 현재 값을 확인하여 testMode 설정
                    // 결과 섹션이 표시되어 있으면 env-select-result를 우선 확인, 없으면 상단의 env-select 확인
                    let currentTestMode = false;
                    let envValue = '';
                    const resultSection = document.getElementById('result-section');
                    const envSelectResult = document.getElementById('env-select-result');
                    
                    // 결과 섹션이 표시되어 있고 env-select-result가 존재하면 그것을 사용
                    if (resultSection && resultSection.style.display !== 'none' && envSelectResult && envSelectResult.value !== 'setting') {
                        envValue = envSelectResult.value;
                        currentTestMode = (envValue === 'test' || envValue === 'Test' || envValue === 'TEST');
                    } else {
                        // 결과 섹션이 없거나 표시되지 않았으면 상단의 env-select 확인
                        const envSelect = document.getElementById('env-select');
                        envValue = envSelect ? envSelect.value : '';
                        currentTestMode = (envValue === 'test' || envValue === 'Test' || envValue === 'TEST');
                    }
                    testMode = currentTestMode; // 전역 변수도 업데이트
                    
                    console.log('=== testMode 설정 확인 ===');
                    console.log('결과 섹션 표시 여부:', resultSection && resultSection.style.display !== 'none');
                    console.log('env-select-result 존재:', !!envSelectResult);
                    console.log('env-select-result 값:', envSelectResult ? envSelectResult.value : 'N/A');
                    console.log('최종 envValue:', envValue);
                    console.log('최종 currentTestMode:', currentTestMode);
                    
                    // Send to server
                    try{
                        const requestData = {
                            loginId,
                            nationality,
                            remainMonths: parseInt(remainMonths),
                            annualIncome: parseFloat(annualIncome),
                            age: parseInt(age),
                            workingMonths: parseInt(workingMonths),
                            visaType,
                            healthInsurance,
                            testMode: currentTestMode
                        };
                        console.log('=== 서버로 전송할 데이터 ===');
                        console.log('healthInsurance 값:', healthInsurance);
                        console.log('env-select 값:', envValue);
                        console.log('testMode 값:', currentTestMode);
                        console.log('전체 데이터:', requestData);
                        
                        const res = await fetch('/server/api/server/loan-estimate', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(requestData)
                        });
                        
                        if(!res.ok) throw new Error('서버 오류');
                        const result = await res.json();

                        // Client-side safeguards and immediate Jeonbuk popups removed per request.
                        
                        // Remove any cached result then store fresh result in sessionStorage
                        sessionStorage.removeItem('loanEstimateResult');
                        sessionStorage.removeItem('loanEstimateInput');

                        // Jeonbuk immediate popup logic removed.

                        sessionStorage.setItem('loanEstimateResult', JSON.stringify(result));
                        sessionStorage.setItem('loanEstimateInput', JSON.stringify({
                            loginId,
                            nationality,
                            remainMonths,
                            annualIncome,
                            age,
                            workingMonths,
                            visaType
                        }));
                        
                        // Display result in the same page
                        displayLoanResult(result, {
                            loginId,
                            nationality,
                            remainMonths,
                            annualIncome,
                            age,
                            workingMonths,
                            visaType,
                            healthInsurance
                        });

                        // Jeonbuk quick visibility popup removed.
                        
                    }catch(err){
                        console.error('대출 조회 오류:', err);
                        console.error('대출 조회 중 오류가 발생했습니다.');
                    }
                };
                
                // Add click handler to the button (for backward compatibility)
                viewBtn.addEventListener('click', queryClickHandler);
                footer.appendChild(viewBtn);
                container.appendChild(footer);


                // 중복 코드 제거됨 - queryClickHandler에 통합됨

                // Position the terms list to align with the left edge of the 약관동의 button on desktop.
                // If the function isn't available (older browsers), this will silently fail.
                if (typeof positionTermsList === 'function') {
                    positionTermsList();
                }
            }catch(err){
                if(loading) loading.textContent = '약관 항목을 불러오는 중 오류가 발생했습니다.';
                console.error('loadTermsList error', err);
            }
        }
        // Display loan result in the same page
        function displayLoanResult(result, inputData){
            // loanTest.html에서 돌아왔을 때 env-select-result를 'prod'로 초기화
            const envSelectResultInit = document.getElementById('env-select-result');
            if (envSelectResultInit && envSelectResultInit.value === 'setting') {
                envSelectResultInit.value = 'prod';
            }
            
            // 결과 데이터 저장 (라디오 버튼 변경 시 재사용)
            lastLoanResult = result;
            lastInputData = inputData;

            // Immediate debug: ensure we always print input/result summary so console shows something
            try {
                console.log('[loanAppl debug] displayLoanResult called. inputData=', inputData);
                console.log('[loanAppl debug] result banks length=', Array.isArray(result && result.banks) ? result.banks.length : 0, 'result=', result);
                // show a non-blocking info once so user sees debug happened (uses session flag to avoid repeated alerts)
                if (!window._loanappl_top_debug_shown) {
                    try { console.info('DEBUG: displayLoanResult called. check console for details.'); } catch(e) { /* ignore */ }
                    window._loanappl_top_debug_shown = true;
                }
            } catch(e) {
                console.error('Error printing top-level debug:', e);
            }

            // Hide env-select after rendering results (in case it was shown)
            try {
                var envSel = document.getElementById('env-select');
                if(envSel) envSel.style.opacity = '0';
            } catch(e) {}

            // 전북은행 관련 일회성 알람 로직 제거됨
            
            const resultSection = document.getElementById('result-section');
            const resultTbody = document.getElementById('result-tbody');
            
            if(!resultSection || !resultTbody) {
                console.error('Result section elements not found');
                return;
            }
            
            // Get current sort option
            const sortByRate = document.querySelector('input[name="sortOption"]:checked')?.value === 'rate';
            // Removed input-* population: those elements no longer exist in the table header.
            
            // Clear previous results
            resultTbody.innerHTML = '';
            
            // testMode 확인 (env-select-result를 우선 확인)
            let isTestMode = false;
            const envSelectResult = document.getElementById('env-select-result');
            if (envSelectResult && envSelectResult.value !== 'setting') {
                const envValue = envSelectResult.value;
                isTestMode = (envValue === 'test' || envValue === 'Test' || envValue === 'TEST');
            } else {
                // fallback: 상단의 env-select 확인
                const envSelect = document.getElementById('env-select');
                if (envSelect) {
                    const envValue = envSelect.value;
                    isTestMode = (envValue === 'test' || envValue === 'Test' || envValue === 'TEST');
                }
            }
            
            // 예가람저축은행 예상금리 강제 설정 (운영 모드일 때만)
            if (!isTestMode && result && Array.isArray(result.banks)) {
                result.banks.forEach(function(bank) {
                    if (bank && bank.bankName && String(bank.bankName).trim() === '예가람저축은행') {
                        bank.estimatedRate = 16.5;
                    }
                });
            }
            //console.log("하현용.............")
            // Apply 전북은행 client-side rules: 서버 응답을 덮어쓰지 않되,
            // 전북은행 항목이 규칙에 걸리면 country.valid=false로 표시하여
            // UI에서 '불가'로 보이게 합니다. 맵은 JEONBUK_BLOCK_RULES에 있음.
            try {
                if (result && Array.isArray(result.banks) && inputData) {
                    result.banks.forEach(bank => {
                        if (!bank) return;
                        try {
                            console.log('[Bank row]', 'bankName=', bank.bankName, 'country.valid=', bank.country && bank.country.valid, 'country.error=', bank.country && bank.country.error);
                        } catch (lgErr) {
                            console.debug('Bank row log error', lgErr);
                        }
                        if (!bank.bankName) return;
                        if (String(bank.bankName).trim() === '전북은행') {
                            // inputData.nationality, inputData.visaType 사용
                            const nat = inputData.nationality || inputData.nationalityName || inputData.country || '';
                            const visa = inputData.visaType || inputData.visa || '';
                            try {
                                // 항상 은행명/비자/국가 정보를 내부 필드에 남겨 UI나 디버그에서 표시 가능하도록 함
                                bank._jeonbuk_info = {
                                    bankName: bank.bankName || '전북은행',
                                    visa: String(visa).trim(),
                                    nationality: String(nat).trim()
                                };

                                // 디버그: 규칙 매칭 여부를 콘솔에 남겨 문제를 진단하기 쉽도록 함
                                const blockedInitial = isJeonbukBlockedByRule(nat, visa);
                                let blocked = blockedInitial;

                                // 예외: 전북은행에서 F4 + China 는 허용되어야 함
                                try {
                                    const natNorm = normalizeCountryName(nat);
                                    const visaNorm = String(visa || '').trim().toUpperCase().replace(/[-\s]/g, '');
                                    const isF4 = visaNorm === 'F4' || visaNorm === 'F-4' || /^F4/.test(visaNorm);
                                    if (isF4 && natNorm === 'china') {
                                        // 강제 허용
                                        blocked = false;
                                        console.log('[Jeonbuk override] Allowing F4 + China -> blocked forced false');
                                    }
                                } catch (exOverride) {
                                    console.debug('Jeonbuk override check error', exOverride);
                                }
                                try {
                                    console.log('[Jeonbuk check]', 'bankName=', bank.bankName, 'visa=', String(visa).trim(), 'nationality=', String(nat).trim(), 'blockedInitial=', blockedInitial, 'blockedAfterOverride=', blocked);
                                } catch (lgErr) {
                                    // 로그 중 에러가 나더라도 흐름은 계속되도록 함
                                    console.debug('Jeonbuk 로그 에러', lgErr);
                                }
                                try {
                                    console.log('[Jeonbuk check]', 'bankName=', bank.bankName, 'visa=', String(visa).trim(), 'nationality=', String(nat).trim(), 'blocked=', blocked);
                                } catch (lgErr) {
                                    // 로그 중 에러가 나더라도 흐름은 계속되도록 함
                                    console.debug('Jeonbuk 로그 에러', lgErr);
                                }

                                if (blocked) {
                                    bank.country = bank.country || {};
                                    bank.country.valid = false;
                                    // 사용자에게 명확히 보이도록 은행명/비자/국가 정보를 포함한 메시지로 설정
                                    const visaDisplay = String(visa).trim() || '-';
                                    const natDisplay = String(nat).trim() || '-';
                                    bank.country.error = bank.country.error || (bank.bankName + ' - ' + visaDisplay + ' - ' + natDisplay + ' : 대출불가');
                                    bank._jeonbukBlocked = true;
                                } else {
                                    bank._jeonbukBlocked = false;
                                    // 만약 서버가 country.valid=false로 내려줬다면, 클라이언트 예외에 의해 허용 처리
                                    try {
                                        if (bank.country && bank.country.valid === false) {
                                            bank.country.valid = true;
                                            // 이전 에러 메시지는 보존하지 않으려면 비우거나 주석 처리
                                            bank.country.error = '';
                                            console.log('[Jeonbuk client override] Cleared server country.error for', bank.bankName);
                                        }
                                    } catch (clrErr) {
                                        console.debug('Error clearing server country.error after override', clrErr);
                                    }
                                }
                            } catch (e) {
                                console.error('전북은행 규칙 적용/메시지 작성 중 오류', e);
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('전북은행 규칙 적용 중 오류', e);
            }
            // Populate result rows
            if(result && Array.isArray(result.banks)){
                // Sort banks: '가능' first, '불가' last
                // Within '가능' banks, sort by estimatedRate (if sortByRate) or estimatedLimit (if sortByLimit)
                // 인덱스를 추가하여 안정적인 정렬을 위해
                const banksWithIndex = result.banks.map((bank, idx) => ({ bank, originalIndex: idx }));
                
                const sortedBanks = banksWithIndex.sort((itemA, itemB) => {
                    const a = itemA.bank;
                    const b = itemB.bank;
                    
                    // comm 값이 null이거나 undefined이거나 0보다 작으면 통신장애로 처리
                    const commValueA = (a.comm !== null && a.comm !== undefined) ? a.comm : null;
                    const hasCommFailureA = (commValueA === null || commValueA === undefined || commValueA <= 0);
                    const commValueB = (b.comm !== null && b.comm !== undefined) ? b.comm : null;
                    const hasCommFailureB = (commValueB === null || commValueB === undefined || commValueB <= 0);
                    
                    const hasFailureA = 
                        (a.visaType && !a.visaType.valid) ||
                        (a.country && !a.country.valid) ||
                        (a.age && !a.age.valid) ||
                        (a.annualIncome && !a.annualIncome.valid) ||
                        (a.employmentDate && !a.employmentDate.valid) ||
                        (a.visaExpiry && !a.visaExpiry.valid) ||
                        (a.healthInsurance && !a.healthInsurance.valid) ||
                        hasCommFailureA; // comm 값이 null이거나 0 이하면 대출불가
                    
                    const hasFailureB = 
                        (b.visaType && !b.visaType.valid) ||
                        (b.country && !b.country.valid) ||
                        (b.age && !b.age.valid) ||
                        (b.annualIncome && !b.annualIncome.valid) ||
                        (b.employmentDate && !b.employmentDate.valid) ||
                        (b.visaExpiry && !b.visaExpiry.valid) ||
                        (b.healthInsurance && !b.healthInsurance.valid) ||
                        hasCommFailureB; // comm 값이 null이거나 0 이하면 대출불가
                    
                    // '가능' (no failure) comes before '불가' (has failure)
                    if (!hasFailureA && hasFailureB) return -1;
                    if (hasFailureA && !hasFailureB) return 1;
                    
                    // If both are '가능', sort by selected option
                    if (!hasFailureA && !hasFailureB) {
                        if (sortByRate) {
                            // Sort by rate (lower rate first)
                            const rateA = a.estimatedRate || 999;
                            const rateB = b.estimatedRate || 999;
                            if (rateA !== rateB) {
                                return rateA - rateB;
                            }
                            // 금리가 같으면 예상한도가 큰 순서대로
                            const limitA = a.estimatedLimit || 0;
                            const limitB = b.estimatedLimit || 0;
                            if (limitA !== limitB) {
                                return limitB - limitA;
                            }
                            // 금리와 한도가 모두 같으면 comm 값이 작은 순서대로
                            const commA = (a.comm !== null && a.comm !== undefined) ? a.comm : 999999;
                            const commB = (b.comm !== null && b.comm !== undefined) ? b.comm : 999999;
                            if (commA !== commB) {
                                return commA - commB;
                            }
                            // 모든 값이 같으면 원래 인덱스로 정렬
                            return itemA.originalIndex - itemB.originalIndex;
                        } else {
                            // Sort by limit (higher limit first)
                            const limitA = a.estimatedLimit || 0;
                            const limitB = b.estimatedLimit || 0;
                            if (limitA !== limitB) {
                                return limitB - limitA;
                            }
                            // 한도가 같으면 예상금리가 작은 순서대로
                            const rateA = a.estimatedRate || 999;
                            const rateB = b.estimatedRate || 999;
                            if (rateA !== rateB) {
                                return rateA - rateB;
                            }
                            // 금리와 한도가 모두 같으면 comm 값이 작은 순서대로
                            const commA = (a.comm !== null && a.comm !== undefined) ? a.comm : 999999;
                            const commB = (b.comm !== null && b.comm !== undefined) ? b.comm : 999999;
                            if (commA !== commB) {
                                return commA - commB;
                            }
                            // 모든 값이 같으면 원래 인덱스로 정렬
                            return itemA.originalIndex - itemB.originalIndex;
                        }
                    }
                    
                    // 둘 다 불가능한 경우 원래 인덱스로 정렬
                    return itemA.originalIndex - itemB.originalIndex;
                }).map(item => item.bank); // bank 객체만 추출
                
                // 먼저 순위를 계산하여 각 은행에 저장
                // 순차적으로 순위 부여 (동일한 값이어도 다른 순위)
                let currentRank = 1;
                
                // 정렬된 순서대로 순위 부여
                for (let i = 0; i < sortedBanks.length; i++) {
                    const bank = sortedBanks[i];
                    // comm 값이 null이거나 undefined이거나 0보다 작으면 통신장애로 처리
                    const commValue = (bank.comm !== null && bank.comm !== undefined) ? bank.comm : null;
                    const hasCommFailure = (commValue === null || commValue === undefined || commValue <= 0);
                    
                    const hasFailure = 
                        (bank.visaType && !bank.visaType.valid) ||
                        (bank.country && !bank.country.valid) ||
                        (bank.age && !bank.age.valid) ||
                        (bank.annualIncome && !bank.annualIncome.valid) ||
                        (bank.employmentDate && !bank.employmentDate.valid) ||
                        (bank.visaExpiry && !bank.visaExpiry.valid) ||
                        (bank.healthInsurance && !bank.healthInsurance.valid) ||
                        hasCommFailure; // comm 값이 null이거나 0 이하면 대출불가
                    
                    if (!hasFailure) {
                        // 순위를 은행 객체에 저장 (순차적으로 증가)
                        bank._displayRank = currentRank;
                        currentRank++;
                    } else {
                        bank._displayRank = null; // 불가능한 경우 순위 없음
                    }
                }
                
                // 순위 계산 후 화면에 표시
                sortedBanks.forEach((bank, idx) => {
                    
                    const tr = document.createElement('tr');
                    
                    // Check if this bank has any failure
                    // comm 값이 null이거나 undefined이거나 0보다 작으면 통신장애로 처리
                    const commValue = (bank.comm !== null && bank.comm !== undefined) ? bank.comm : null;
                    const hasCommFailure = (commValue === null || commValue === undefined || commValue <= 0);
                    
                    const hasFailure = 
                        (bank.visaType && !bank.visaType.valid) ||
                        (bank.country && !bank.country.valid) ||
                        (bank.age && !bank.age.valid) ||
                        (bank.annualIncome && !bank.annualIncome.valid) ||
                        (bank.employmentDate && !bank.employmentDate.valid) ||
                        (bank.visaExpiry && !bank.visaExpiry.valid) ||
                        (bank.healthInsurance && !bank.healthInsurance.valid) ||
                        hasCommFailure; // comm 값이 null이거나 0 이하면 대출불가
                    
                    // Rank column - show number for '가능', 'X' for '불가'
                    const tdRank = document.createElement('td');
                    if (hasFailure) {
                        tdRank.textContent = 'X';
                        tdRank.style.color = 'red';
                        tdRank.style.fontWeight = 'bold';
                    } else {
                        tdRank.textContent = bank._displayRank || '-';
                    }
                    tr.appendChild(tdRank);
                    
                    // Bank name
                    const tdBank = document.createElement('td');
                    tdBank.textContent = bank.bankName || '-';
                    // If Jeonbuk rule matched or server provided a country.error, show a visible red note under the bank name
                        try {
                        // 원본 메시지 취득
                        let noteText = ((bank._jeonbukBlocked ? (bank.country && bank.country.error) : (bank.country && bank.country.error)) || '').trim();
                        // 'E국가' 또는 'E국가비자' 전체 단독 메시지는 삭제
                        if (noteText === 'E국가' || noteText === 'E국가비자') {
                            noteText = '';
                        }

                        // 메시지에 '대출불가' 텍스트가 포함된 경우 (예: "전북은행 - F4 - Cambodia : 대출불가")
                        // 사용자 요청에 따라 해당 전체 메시지는 표시하지 않음
                        if (noteText && noteText.indexOf('대출불가') !== -1) {
                            noteText = '';
                        } else {
                            // 내부에 포함된 E국가 토큰만 제거하고 나머지 메시지는 유지
                            noteText = noteText.replace(/E국가비자/g, '').replace(/E국가/g, '').replace(/\s{2,}/g, ' ').trim();
                        }

                        if (noteText) {
                            const note = document.createElement('div');
                            note.style.fontSize = '0.8rem';
                            note.style.color = 'red';
                            note.style.marginTop = '4px';
                            note.textContent = noteText;
                            tdBank.appendChild(note);
                        }
                    } catch (noteErr) {
                        console.debug('Bank note render error', noteErr);
                    }
                    tr.appendChild(tdBank);

                    // 결과 (Result) - 'X'가 하나라도 있으면 '불가' 표시
                    const tdResult = document.createElement('td');
                    if (hasFailure) {
                        tdResult.textContent = '불가';
                        tdResult.style.color = 'red';
                        tdResult.style.fontWeight = 'bold';
                    } else {
                        tdResult.textContent = '가능';
                        tdResult.style.color = 'green';
                        tdResult.style.fontWeight = 'bold';
                    }
                    tr.appendChild(tdResult);

                    // 신청 컬럼: '가능'일 때만 신청 버튼을 표시
                    const tdApply = document.createElement('td');
                    if (!hasFailure) {
                        const applyBtn = document.createElement('button');
                        applyBtn.type = 'button';
                        applyBtn.className = 'loan-apply-btn';
                        applyBtn.textContent = '신청';
                        applyBtn.style.background = '#28a745';
                        applyBtn.style.color = '#fff';
                        applyBtn.style.border = 'none';
                        applyBtn.style.padding = '6px 10px';
                        applyBtn.style.borderRadius = '6px';
                        applyBtn.style.cursor = 'pointer';
                        applyBtn.addEventListener('click', function(e){
                            e.preventDefault();
                            // store current bank + input for submission
                            window._loanApplyContext = { bank: bank, input: lastInputData };
                            openApplyConfirmModal(bank, lastInputData);
                        });
                        tdApply.appendChild(applyBtn);
                    } else {
                        tdApply.textContent = '';
                    }
                    tr.appendChild(tdApply);

                    // Estimated limit
                    const tdLimit = document.createElement('td');
                    if (hasFailure) {
                        // 대출불가 판정 시 예상한도 표시 안 함
                        tdLimit.textContent = '-';
                    } else {
                        tdLimit.textContent = bank.estimatedLimit ? bank.estimatedLimit.toLocaleString() + '만원' : '-';
                    }
                    tr.appendChild(tdLimit);

                    // Estimated rate
                    const tdRate = document.createElement('td');
                    if (hasFailure) {
                        // 대출불가 판정 시 예상금리 표시 안 함
                        tdRate.textContent = '-';
                    } else {
                        // 소수점 2자리까지 표시
                        tdRate.textContent = bank.estimatedRate ? bank.estimatedRate.toFixed(2) + '%' : '-';
                    }
                    tr.appendChild(tdRate);

                    // Visa validation
                    const tdVisa = document.createElement('td');
                    tdVisa.textContent = bank.visaType && bank.visaType.valid ? 'O' : 'X';
                    tr.appendChild(tdVisa);

                    // Country validation
                    const tdCountry = document.createElement('td');
                    tdCountry.textContent = bank.country && bank.country.valid ? 'O' : 'X';
                    tr.appendChild(tdCountry);

                    // Age validation
                    const tdAge = document.createElement('td');
                    tdAge.textContent = bank.age && bank.age.valid ? 'O' : 'X';
                    tr.appendChild(tdAge);

                    // Income validation
                    const tdIncome = document.createElement('td');
                    tdIncome.textContent = bank.annualIncome && bank.annualIncome.valid ? 'O' : 'X';
                    tr.appendChild(tdIncome);

                    // Working months validation (employment date)
                    const tdWorkingMonths = document.createElement('td');
                    tdWorkingMonths.textContent = bank.employmentDate && bank.employmentDate.valid ? 'O' : 'X';
                    tr.appendChild(tdWorkingMonths);

                    // Health insurance validation (KB저축은행만)
                    const tdHealthInsurance = document.createElement('td');
                    if (bank.healthInsurance) {
                        tdHealthInsurance.textContent = bank.healthInsurance.valid ? 'O' : 'X';
                    } else {
                        tdHealthInsurance.textContent = '-';
                    }
                    tr.appendChild(tdHealthInsurance);

                    // Visa expiry validation (잔여체류기간)
                    const tdVisaExpiry = document.createElement('td');
                    tdVisaExpiry.textContent = bank.visaExpiry && bank.visaExpiry.valid ? 'O' : 'X';
                    tr.appendChild(tdVisaExpiry);

                    // 통신 상태
                    const tdCommStatus = document.createElement('td');
                    let commStatus;
                    // comm 값이 null이거나 undefined이면 '장애'
                    if (commValue === null || commValue === undefined) {
                        commStatus = '장애';
                    } else if (commValue > 0) {
                        commStatus = '정상';
                    } else {
                        commStatus = '장애';
                    }
                    tdCommStatus.textContent = commStatus;
                    tdCommStatus.style.fontWeight = 'bold';
                    tdCommStatus.style.color = commStatus === '정상' ? 'green' : 'red';
                    tr.appendChild(tdCommStatus);
                    resultTbody.appendChild(tr);

                    
                });
            }
            
            // Show result section
            resultSection.style.display = 'block';
            
            // Scroll to result section
            setTimeout(() => {
                resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // Show term details in modal
        async function showTermDetails(groupName){
            const modal = document.getElementById('terms-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            if(!modal || !modalTitle || !modalBody) return;
            
            // Show modal and set title
            modal.style.display = 'block';
            modalTitle.textContent = groupName;
            modalBody.innerHTML = '<p>로딩 중...</p>';
            
            try{
                // Fetch details from server (absolute path)
                    const res = await fetch('/server/api/server/group-details?group_name=' + encodeURIComponent(groupName));
                if(!res.ok) throw new Error('네트워크 오류');
                const items = await res.json();
                
                // Clear and populate modal body
                modalBody.innerHTML = '';
                if(!Array.isArray(items) || items.length === 0){
                    modalBody.innerHTML = '<p>상세 내역이 없습니다.</p>';
                    return;
                }
                
                items.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'terms-modal-item';
                    
                    // Create checkbox
                    const chk = document.createElement('input');
                    chk.type = 'checkbox';
                    chk.id = 'modal-term-' + idx;
                    chk.className = 'modal-term-checkbox';
                    
                    // Add change handler to uncheck top-level checkbox if any item is unchecked
                    chk.addEventListener('change', function(e){
                        const topTermsCheckbox = document.getElementById('terms-checkbox');
                        if(topTermsCheckbox && !e.target.checked){
                            topTermsCheckbox.checked = false;
                        }
                    });
                    
                    // Create label
                    const label = document.createElement('label');
                    label.htmlFor = chk.id;
                    label.textContent = item.title || '';
                    
                    // Add click handler to label to show content
                    label.addEventListener('click', function(e){
                        e.preventDefault();
                        showTermContent(item.title || '');
                    });
                    
                    div.appendChild(chk);
                    div.appendChild(label);
                    modalBody.appendChild(div);
                });
                
                // Add agreement footer
                const footer = document.createElement('div');
                footer.className = 'terms-modal-footer';
                
                const agreeChk = document.createElement('input');
                agreeChk.type = 'checkbox';
                agreeChk.id = 'terms-modal-agree';
                
                const agreeLabel = document.createElement('label');
                agreeLabel.htmlFor = 'terms-modal-agree';
                agreeLabel.textContent = '상기 전체의 내용에 대하여 충분히 이해하였으며, 이에 동의 합니다';
                
                // Add change handler to sync with main modal
                agreeChk.addEventListener('change', function(e){
                    if(e.target.checked){
                        // Find the corresponding checkbox in the main terms list
                        const mainCheckboxes = document.querySelectorAll('#terms-list .term-checkbox');
                        mainCheckboxes.forEach(cb => {
                            const cbGroupName = cb.getAttribute('data-group-name');
                            if(cbGroupName === groupName){
                                cb.checked = true;
                            }
                        });
                        
                        // Close the modal after a short delay
                        setTimeout(() => {
                            modal.style.display = 'none';
                        }, 300);
                    }
                });
                
                footer.appendChild(agreeChk);
                footer.appendChild(agreeLabel);
                modalBody.appendChild(footer);
            }catch(err){
                modalBody.innerHTML = '<p style="color:red;">약관 상세 내역을 불러오는 중 오류가 발생했습니다.</p>';
                console.error('showTermDetails error', err);
            }
        }

        // Show term content in nested modal
        async function showTermContent(title){
            const modal = document.getElementById('content-modal');
            const modalTitle = document.getElementById('content-modal-title');
            const modalBody = document.getElementById('content-modal-body');
            const modalFooter = document.getElementById('content-modal-footer');
            const agreeChk = document.getElementById('content-modal-agree');
            
            if(!modal || !modalTitle || !modalBody) return;
            
            // Show modal and set title
            modal.style.display = 'block';
            modalTitle.textContent = title;
            modalBody.innerHTML = '<p>로딩 중...</p>';
            
            // Hide footer initially and reset checkbox
            if(modalFooter) modalFooter.style.display = 'none';
            if(agreeChk) agreeChk.checked = false;
            
            try{
                // Fetch content from server (absolute path)
                const res = await fetch('/server/api/documents/content?title=' + encodeURIComponent(title));
                if(!res.ok) throw new Error('네트워크 오류');
                const data = await res.json();
                
                // Display content
                modalBody.innerHTML = '';
                if(data.content){
                    modalBody.textContent = data.content;
                    
                    // Show footer with agreement checkbox
                    if(modalFooter) modalFooter.style.display = 'flex';
                    
                    // Remove any existing event listeners by cloning
                    if(agreeChk){
                        const newAgreeChk = agreeChk.cloneNode(true);
                        agreeChk.parentNode.replaceChild(newAgreeChk, agreeChk);
                        
                        // Add change handler to check the specific title checkbox
                        newAgreeChk.addEventListener('change', function(e){
                            if(e.target.checked){
                                // Find the checkbox for this specific title in the terms modal
                                const modalCheckboxes = document.querySelectorAll('#modal-body .terms-modal-item');
                                modalCheckboxes.forEach(item => {
                                    const label = item.querySelector('label');
                                    const checkbox = item.querySelector('input[type="checkbox"]');
                                    if(label && checkbox && label.textContent === title){
                                        checkbox.checked = true;
                                    }
                                });
                                
                                // Close only the content modal after a short delay
                                setTimeout(() => {
                                    modal.style.display = 'none';
                                }, 300);
                            }
                        });
                    }
                } else {
                    modalBody.innerHTML = '<p>내용이 없습니다.</p>';
                }
            }catch(err){
                modalBody.innerHTML = '<p style="color:red;">약관 내용을 불러오는 중 오류가 발생했습니다.</p>';
                console.error('showTermContent error', err);
            }
        }

        // Close modal when clicking X or outside
        window.addEventListener('click', function(e){
            const termsModal = document.getElementById('terms-modal');
            const termsModalClose = document.getElementById('modal-close');
            const contentModal = document.getElementById('content-modal');
            const contentModalClose = document.getElementById('content-modal-close');
            
            // Close terms modal
            if(e.target === termsModal || e.target === termsModalClose){
                termsModal.style.display = 'none';
            }
            
            // Close content modal
            if(e.target === contentModal || e.target === contentModalClose){
                contentModal.style.display = 'none';
            }
        });

        // 전체 동의 버튼: 체크리스트의 모든 체크박스를 체크합니다.
        const agreeAllBtn = document.getElementById('agree-all-btn');
        if(agreeAllBtn){
            agreeAllBtn.addEventListener('click', function(e){
                e.preventDefault();
                const boxes = document.querySelectorAll('#terms-list .term-checkbox');
                boxes.forEach(b=> { b.checked = true; });
                // Also check the top-level terms-checkbox if present
                const top = document.getElementById('terms-checkbox');
                if(top) top.checked = true;
            });
        }

        // Top-level terms checkbox toggles all items
        const topTermsCheckbox = document.getElementById('terms-checkbox');
        if(topTermsCheckbox){
            topTermsCheckbox.addEventListener('change', function(e){
                const checked = !!e.target.checked;
                const boxes = document.querySelectorAll('#terms-list .term-checkbox');
                boxes.forEach(b=> { b.checked = checked; });
            });
        }

    // Positioning helper: align the left edge of #terms-list with #action-terms on desktop.
        function positionTermsList(){
            const container = document.getElementById('terms-list');
            const btn = document.getElementById('action-terms');
            if(!container || !btn) return;
            // mobile: keep normal flow
            if(window.innerWidth <= 600){
                container.style.position = '';
                container.style.left = '';
                container.style.top = '';
                container.style.zIndex = '';
                container.style.width = '';
                return;
            }
            const rect = btn.getBoundingClientRect();
            const left = Math.max(rect.left + window.scrollX, 8); // don't go negative
            const top = rect.bottom + window.scrollY + 8; // small gap below the button
            container.style.position = 'absolute';
            container.style.left = left + 'px';
            container.style.top = top + 'px';
            container.style.zIndex = '999';
            // use 80% of available width (20% reduction from maximum)
            const maxWidth = window.innerWidth - left - 20;
            container.style.width = Math.round(maxWidth * 0.8) + 'px';
        }

        // Reposition on resize/scroll; also load terms once DOM is ready.
        window.addEventListener('resize', positionTermsList);
        window.addEventListener('scroll', positionTermsList);

        // Position action-items wrapper so its left edge matches the 로그인 button's left edge on desktop.
        function positionActionItems(){
            const wrapper = document.getElementById('action-items-wrapper');
            const loginBtn = document.getElementById('action-login');
            if(!wrapper || !loginBtn) return;
            // mobile: keep normal flow
            if(window.innerWidth <= 600){
                wrapper.style.marginLeft = '';
                wrapper.style.width = '';
                return;
            }
            const loginRect = loginBtn.getBoundingClientRect();
            const parentRect = wrapper.parentElement.getBoundingClientRect();
            // compute left offset relative to wrapper's container
            // align exactly with login button's left edge (no correction)
            const desiredMargin = Math.max(0, Math.round(loginRect.left - parentRect.left));
            wrapper.style.marginLeft = desiredMargin + 'px';
            // ensure wrapper doesn't overflow too far to the right
            wrapper.style.width = Math.min(960, parentRect.width - desiredMargin) + 'px';
        }

        window.addEventListener('resize', positionActionItems);
        window.addEventListener('scroll', positionActionItems);

        // Display loan results
        function displayLoanResults(results){
            if(!Array.isArray(results) || results.length === 0){
                console.warn('조회 결과가 없습니다.');
                return;
            }
            
            // Create result display
            let resultHtml = '<div style="background:#fff;padding:20px;border-radius:8px;margin-top:20px;max-width:800px;">';
            resultHtml += '<h3 style="color:#2d6cdf;margin-bottom:20px;">대출 조회 결과</h3>';
            
            results.forEach((bank, idx) => {
                // Check if this bank has any failure
                const hasFailure = 
                    (bank.visaType && !bank.visaType.valid) ||
                    (bank.country && !bank.country.valid) ||
                    (bank.age && !bank.age.valid) ||
                    (bank.annualIncome && !bank.annualIncome.valid) ||
                    (bank.employmentDate && !bank.employmentDate.valid) ||
                    (bank.visaExpiry && !bank.visaExpiry.valid) ||
                    (bank.healthInsurance && !bank.healthInsurance.valid);
                
                resultHtml += `<div style="border:1px solid #e0e6ef;border-radius:8px;padding:16px;margin-bottom:16px;">`;
                resultHtml += `<h4 style="color:#000080;margin:0 0 12px 0;">${idx + 1}위: ${bank.bankName}</h4>`;
                resultHtml += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px;">';
                
                // Display validation results
                resultHtml += `<div>비자종류: ${bank.visaType.valid ? 'O' : 'X (' + bank.visaType.error + ')'}</div>`;
                resultHtml += `<div>국가: ${bank.country.valid ? 'O' : 'X (' + bank.country.error + ')'}</div>`;
                resultHtml += `<div>나이: ${bank.age.valid ? 'O' : 'X (' + bank.age.error + ')'}</div>`;
                resultHtml += `<div>비자만료일: ${bank.visaExpiry.valid ? 'O' : 'X (' + bank.visaExpiry.error + ')'}</div>`;
                resultHtml += `<div>재직일자: ${bank.employmentDate.valid ? 'O' : 'X (' + bank.employmentDate.error + ')'}</div>`;
                resultHtml += `<div>연소득: ${bank.annualIncome.valid ? 'O' : 'X (' + bank.annualIncome.error + ')'}</div>`;
                
                // Display loan estimate - 대출불가 판정 시 표시 안 함
                if(!hasFailure && (bank.estimatedLimit !== null || bank.bankName === '예가람저축은행' || bank.bankName === '웰컴저축은행' || (inputData.annualIncome && inputData.annualIncome < 2000))){
                    resultHtml += `<div style="grid-column:1/-1;margin-top:8px;padding-top:8px;border-top:1px solid #f1f4fb;">`;
                    if (inputData.annualIncome && inputData.annualIncome < 2000) {
                        // 연소득이 2000만원 미만일 경우 예상한도를 연소득으로 표시 (모든 은행)
                        resultHtml += `<strong>예상한도:</strong> ${inputData.annualIncome.toLocaleString()}만원 | `;
                        resultHtml += `<strong>예상금리:</strong> ${bank.estimatedRate || '-'}%</div>`;
                    } else {
                        resultHtml += `<strong>예상한도:</strong> ${bank.estimatedLimit ? bank.estimatedLimit.toLocaleString() : '-'}만원 | `;
                        resultHtml += `<strong>예상금리:</strong> ${bank.estimatedRate || '-'}%</div>`;
                    }
                } else if(hasFailure) {
                    resultHtml += `<div style="grid-column:1/-1;margin-top:8px;padding-top:8px;border-top:1px solid #f1f4fb;color:#999;">`;
                    resultHtml += `대출불가</div>`;
                } else {
                    resultHtml += `<div style="grid-column:1/-1;margin-top:8px;padding-top:8px;border-top:1px solid #f1f4fb;color:#999;">`;
                    resultHtml += `예상한도 및 금리 정보 없음</div>`;
                }
                
                resultHtml += '</div></div>';
            });
            
            resultHtml += '</div>';
            
            // Insert result below the action items
            const actionWrapper = document.getElementById('action-items-wrapper');
            if(actionWrapper){
                let resultDiv = document.getElementById('loan-results');
                if(!resultDiv){
                    resultDiv = document.createElement('div');
                    resultDiv.id = 'loan-results';
                    actionWrapper.parentElement.insertBefore(resultDiv, actionWrapper.nextSibling);
                }
                resultDiv.innerHTML = resultHtml;
            }
        }

        // Check if user is logged in via localStorage
        let loginPromptShown = false; // 플래그 추가
        let isRedirecting = false; // 리다이렉트 중 플래그 추가
        function requireLoginPromptOnLoad(){
            // 이미 알림이 표시되었거나 리다이렉트 중이면 중복 실행 방지
            if(loginPromptShown || isRedirecting) return;
            
            try{
                // 먼저 접근 시간 확인
                if (!checkAccessTime()) {
                    loginPromptShown = true;
                    isRedirecting = true; // 리다이렉트 중 플래그 설정
                    return; // checkAccessTime에서 이미 로그아웃 처리 및 리다이렉트 완료
                }
                
                // localStorage에서 login-id 확인
                const loginId = localStorage.getItem('login-id');
                
                if(!loginId || loginId.trim() === ''){
                    loginPromptShown = true; // 플래그 설정
                    isRedirecting = true; // 리다이렉트 중 플래그 설정
                    const ok = window.confirm('로그인을 먼저 하십시오');
                    if(ok){
                        window.location.href = 'login.html';
                    }
                } else {
                    console.log('User logged in:', loginId);
                    // 로그인 상태 표시 업데이트
                    currentUserId = loginId.trim();
                    updateLoginDisplay(loginId.trim());
                }
            }catch(e){
                console.error('Login check error', e);
                if(!loginPromptShown && !isRedirecting) {
                    loginPromptShown = true; // 플래그 설정
                    isRedirecting = true; // 리다이렉트 중 플래그 설정
                    const ok = window.confirm('로그인을 먼저 하십시오');
                    if(ok){
                        window.location.href = 'login.html';
                    }
                }
            }
        }

        // Load terms when the page finishes loading and position dynamic elements
        if(document.readyState === 'complete' || document.readyState === 'interactive'){
            // Prompt for login if needed, then position elements (자동 목록조회/terms 불러오기 제거)
            // checkLoginStatus()는 requireLoginPromptOnLoad() 내부에서 처리되므로 중복 호출 제거
            requireLoginPromptOnLoad();
            if(!isRedirecting) {
                // loanTest.html에서 돌아올 때 env-select-result를 'prod'로 초기화
                const envSelectResult = document.getElementById('env-select-result');
                if (envSelectResult && envSelectResult.value === 'setting') {
                    envSelectResult.value = 'prod';
                }
                
                setTimeout(function(){ positionTermsList(); positionActionItems(); }, 120);
                loadTermsList();
                // Add event listeners for sort option radio buttons (자동 목록조회 제거)
                document.querySelectorAll('input[name="sortOption"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (lastLoanResult && lastInputData) {
                            displayLoanResult(lastLoanResult, lastInputData);
                        }
                    });
                });
                // Hide env-select on initial load
                try {
                    var envSel = document.getElementById('env-select');
                    if(envSel) envSel.style.opacity = '0';
                } catch(e) {}
            }
        } else {
            window.addEventListener('DOMContentLoaded', function(){ 
                // checkLoginStatus()는 requireLoginPromptOnLoad() 내부에서 처리되므로 중복 호출 제거
                requireLoginPromptOnLoad();
                if(!isRedirecting) {
                    // loanTest.html에서 돌아올 때 env-select-result를 'prod'로 초기화
                    const envSelectResult = document.getElementById('env-select-result');
                    if (envSelectResult && envSelectResult.value === 'setting') {
                        envSelectResult.value = 'prod';
                    }
                    
                    setTimeout(function(){ positionTermsList(); positionActionItems(); },120);
                    loadTermsList();
                    // Add event listeners for sort option radio buttons (자동 목록조회 제거)
                    document.querySelectorAll('input[name="sortOption"]').forEach(radio => {
                        radio.addEventListener('change', function() {
                            if (lastLoanResult && lastInputData) {
                                displayLoanResult(lastLoanResult, lastInputData);
                            }
                        });
                    });
                    // Hide env-select on initial load
                    try {
                        var envSel = document.getElementById('env-select');
                        if(envSel) envSel.style.opacity = '0';
                    } catch(e) {}
                }
            });
        }

    </script>

    <!-- 신청 확인 모달 -->
    <div id="apply-confirm-modal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);z-index:10000;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:8px;padding:18px;max-width:480px;margin:0 auto;box-shadow:0 8px 30px rgba(0,0,0,0.2);">
            <h3 style="margin:0 0 12px 0;color:#2d6cdf">대출 신청 확인</h3>
            <div id="apply-confirm-message" style="margin-bottom:14px;color:#222;line-height:1.4;">대출 신청을 하시겠습니까?</div>
            <div style="display:flex;gap:8px;justify-content:flex-end">
                <button id="apply-confirm-cancel" type="button" style="background:#6c757d;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">취소</button>
                <button id="apply-confirm-submit" type="button" style="background:#28a745;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">제출</button>
            </div>
        </div>
    </div>

    <script>
        // Open confirmation modal and populate message
        function openApplyConfirmModal(bank, inputData){
            try{
                const modal = document.getElementById('apply-confirm-modal');
                const msg = document.getElementById('apply-confirm-message');
                if(!modal || !msg) return;
                const bankName = bank && bank.bankName ? bank.bankName : '-';
                const limit = (bank && bank.estimatedLimit) ? (bank.estimatedLimit.toLocaleString() + '만원') : '-';
                const rate = (bank && bank.estimatedRate) ? (bank.estimatedRate.toFixed ? bank.estimatedRate.toFixed(2) + '%' : bank.estimatedRate + '%') : '-';
                const visa = inputData && inputData.visaType ? inputData.visaType : (bank && bank.visaType && bank.visaType.value ? bank.visaType.value : '-');
                const nat = inputData && inputData.nationality ? inputData.nationality : (bank && bank.country && bank.country.value ? bank.country.value : '-');

                // 간단한 확인 문구만 표시
                msg.textContent = '대출 신청을 하시면 담당직원이 연락을 드립니다. \n' +
                '계속 진행 하시겠습니까?';
                modal.style.display = 'flex';
            }catch(e){
                console.error('openApplyConfirmModal error', e);
                alert('신청 확인을 열 수 없습니다.');
            }
        }

        function closeApplyConfirmModal(){
            const modal = document.getElementById('apply-confirm-modal');
            if(modal) modal.style.display = 'none';
        }

        // Cancel button
        document.getElementById('apply-confirm-cancel')?.addEventListener('click', function(e){
            e.preventDefault();
            closeApplyConfirmModal();
        });

        // 모든 신청 버튼 비활성화 함수
        function disableAllApplyButtons() {
            const applyButtons = document.querySelectorAll('.loan-apply-btn');
            applyButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.background = '#6c757d';
                btn.style.cursor = 'not-allowed';
                btn.style.opacity = '0.6';
            });
        }

        // Submit button: 대출 신청 제출
        document.getElementById('apply-confirm-submit')?.addEventListener('click', async function(e){
            e.preventDefault();
            try{
                // 모든 신청 버튼 비활성화
                disableAllApplyButtons();

                // localStorage에서 login-id 가져오기
                const loginId = localStorage.getItem('login-id');
                if (!loginId || loginId.trim() === '') {
                    alert('로그인이 필요합니다. 로그인 화면으로 이동합니다.');
                    window.location.href = 'login.html';
                    return;
                }

                // login-id와 req-yn=yes를 서버에 전송
                const payload = {
                    'login-id': loginId.trim(),
                    'req-yn': 'yes'
                };

                const res = await fetch('/server/api/foreign_worker_master', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                const result = await res.json().catch(()=>({ok: false, error: '응답 파싱 실패'}));
                
                if (res.ok && result.ok) {
                    alert('대출 신청이 완료되었습니다');
                    closeApplyConfirmModal();
                } else {
                    alert('대출 신청 중 오류가 발생했습니다: ' + (result.error || '알 수 없는 오류'));
                    // 오류 시 버튼 다시 활성화하지 않음 (이미 신청이 처리되었을 수 있음)
                }
            }catch(err){
                console.error('apply submit error', err);
                alert('대출 신청 중 오류가 발생했습니다.');
                // 오류 시에도 버튼은 비활성화 상태 유지
            }finally{
                window._loanApplyContext = null;
            }
        });
    </script>
</body>
</html>
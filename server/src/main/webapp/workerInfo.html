<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LOANDOC - 개인정보 입력</title>
    <style>
        /* 기본 스타일 */
        body{font-family:Arial,Helvetica,sans-serif;background:#f6f6f6;margin:0}
        header{background:#2d6cdf;color:#fff;padding:20px;text-align:center}
        main{max-width:820px;margin:24px auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.06)}
        label{display:block;margin-bottom:6px;font-weight:600}
        input, select, textarea { box-sizing: border-box; width:100%; height:40px; padding:10px 12px; border:1px solid #ccc; border-radius:6px; margin:0; }
        .grid{display:grid;grid-template-columns:1fr 1fr; gap:18px 18px; align-items:start}
        .note{color:#666;font-size:0.95em; margin-top:8px}
        button{background:#2d6cdf;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer}
        
        /* 네비게이션 스타일 */
        nav{display:flex;justify-content:center;gap:20px;padding:12px 0;background:#fff;align-items:center}
        nav a{color:#2d6cdf;text-decoration:none;font-weight:600;padding:6px 8px}
        .nav-button{background:#FFD400;color:#000;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;text-decoration:none;font-weight:700}
        
        /* 미디어 쿼리 (반응형) */
        @media(max-width:720px){ 
            .grid{grid-template-columns:1fr;} 
            input, select, textarea{height:44px;} 
        }
    </style>
</head>
<body>
    <header>
        <h1>외국인 근로자 대출 연계 포털</h1>
        <p>개인정보 입력</p>
    </header>
    <nav>
        <a class="nav-button" href="index.html">로그인</a>
        <a class="nav-button" href="signup.html">회원가입</a>
        <a class="nav-button" href="workerInfo.html">정보조회</a>
        <a class="nav-button" href="loanAppl.html">대출신청</a>
    </nav>
    <main>
        <div style="position:relative;padding:28px 0;">
            <h2 style="margin:0;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);">개인 정보</h2>
            <div style="position:absolute;right:0;top:50%;transform:translateY(-50%);font-size:0.95em;color:#333;white-space:nowrap;display:flex;align-items:center;gap:8px;">
                <strong style="margin:0">아이디:</strong>
                <input id="displayUserIdInput" readonly aria-label="로그인 아이디" style="width:220px;padding:10px 12px;border-radius:6px;border:1px solid #ccc;background:#f5f9ff;color:#2d6cdf;font-weight:800;text-align:center;font-size:1.1rem;" value="-" />
            </div>
        </div>
        <form id="profileForm">
            <input type="hidden" id="userId" name="userId" value="" /> 

            <div class="grid">
                <div>
                    <label for="name">1. 이름 (name)</label>
                    <input id="name" />
                </div>
                <div>
                    <label for="nationality">2. 국가 (nationality)</label>
                    <select id="nationality">
                        <option value="">선택</option>
                        <option>Vietnam</option>
                        <option>Thailand</option>
                        <option>Philippines</option>
                        <option>Indonesia</option>
                        <option>Malaysia</option>
                        <option>Myanmar</option>
                        <option>Cambodia</option>
                        <option>Laos</option>
                        <option>Singapore</option>
                        <option>Timor-Leste</option>
                    </select>
                </div>

                <div>
                    <label for="passport">3. 여권번호 (passport_number)</label>
                    <input id="passport" />
                </div>
                <div>
                    <label for="birth">4. 생년월일 (birth_date)</label>
                    <input id="birth" type="date" />
                </div>

                <div>
                    <label for="entry">5. 입국일자 (entry_date)</label>
                    <input id="entry" type="date" />
                </div>
                <div>
                    <label for="gender">6. 성별 (gender)</label>
                    <select id="gender">
                        <option value="">선택</option>
                        <option value="M">M</option>
                        <option value="F">F</option>
                    </select>
                </div>

                <div>
                    <label for="employment">7. 입사구분</label>
                    <select id="employment">
                        <option value="">선택</option>
                        <option>정규직</option>
                        <option>비정규직</option>
                        <option>무직</option>
                    </select>
                </div>
                <div>
                    <label for="foreigner_grade">8. 외국인 등급 (foreigner_grade)</label>
                    <select id="foreigner_grade">
                        <option value="">선택</option>
                        <option>A</option>
                        <option>B</option>
                        <option>C</option>
                    </select>
                </div>

                <div>
                    <label for="visa_grade">9. 비자등급 (visa_grade)</label>
                    <select id="visa_grade">
                        <option value="">선택</option>
                        <option>A</option>
                        <option>B</option>
                        <option>C</option>
                    </select>
                </div>
                <div>
                    <label for="phone">10. 전화번호 (phone_number)</label>
                    <input id="phone" />
                </div>

                <div>
                    <label for="address">11. 국내주소 (address)</label>
                    <input id="address" />
                </div>
                <div>
                    <label for="home_address">12. 본국주소 (home_country_address)</label>
                    <input id="home_address" />
                </div>

                <div>
                    <label for="current_company">13. 현재 직장명 (current_company)</label>
                    <input id="current_company" />
                </div>
                <div>
                    <label for="company_entry_date">14. 입사일자 (company_entry_date)</label>
                    <input id="company_entry_date" type="date" />
                </div>

                <div>
                    <label for="annual_salary">15. 연봉 (annual_salary)</label>
                    <input id="annual_salary" type="number" step="1" min="0" />
                </div>
                <div>
                    <label for="commute_company">16. 출근 회사명 (commute_company)</label>
                    <input id="commute_company" />
                </div>

                <div>
                    <label for="has_health">17. 의료보험 여부 (has_health_insurance)</label>
                    <select id="has_health">
                        <option value="">선택</option>
                        <option value="Y">Y</option>
                        <option value="N">N</option>
                    </select>
                </div>

                <div>
                    <label for="stay_expiry_date">18. 체재만료일자 (stay_expiry_date)</label>
                    <input id="stay_expiry_date" type="date" />
                </div>
                <div>
                    <label for="has_loan">19. 기존대출여부 (has_loan)</label>
                    <select id="has_loan">
                        <option value="">선택</option>
                        <option value="Y">Y</option>
                        <option value="N">N</option>
                    </select>
                </div>
            </div>
            <div style="margin-top:12px;">
                <button type="button" id="saveBtn">저장</button>
                <button type="reset" id="resetBtn">초기화</button> 
                <div id="formMsg" class="note"></div>
            </div>
        </form>
    </main>
    <script>
        // LocalStorage 헬퍼 함수
        function loadProfiles(){ return JSON.parse(localStorage.getItem('foreign_workers')||'[]'); }
        function saveProfiles(arr){ localStorage.setItem('foreign_workers', JSON.stringify(arr)); }
        
        // DOM 콘텐츠 로드 후 실행
        document.addEventListener('DOMContentLoaded', function(){
            const formElements = [
                'name', 'nationality', 'passport', 'birth', 'entry', 'gender', 'employment', 
                'foreigner_grade', 'visa_grade', 'phone', 'address', 'home_address', 
                'current_company', 'company_entry_date', 'annual_salary', 'commute_company', 
                'has_health', 'stay_expiry_date', 'has_loan'
            ];

            try {
                // 로그인된 사용자 ID 가져오기
                const loggedInUser = localStorage.getItem('loggedInUser') || 
                                     localStorage.getItem('lastRegisteredId') ||
                                     'guest';
                
                // 로그인 ID 표시 업데이트
                const displayInput = document.getElementById('displayUserIdInput');
                if (displayInput) {
                    displayInput.value = loggedInUser;
                }
                
                // 폼 내의 숨겨진 userId 필드에 값 설정
                const userIdInput = document.getElementById('userId');
                if (userIdInput) {
                    userIdInput.value = loggedInUser;
                }

                // 로그인 ID 알림 표시
                if (loggedInUser !== 'guest') {
                    //alert('로그인 아이디: ' + loggedInUser);
                    
                    // 기존 정보 로드 및 필드 채우기 (개선 반영)
                    const profiles = loadProfiles();
                    const userProfile = profiles.find(p => p.userId === loggedInUser);
                    
                    if (userProfile) {
                        formElements.forEach(id => {
                            const element = document.getElementById(id);
                            if (element && userProfile[id] !== undefined) {
                                element.value = userProfile[id];
                            }
                        });
                        console.log('기존 개인정보를 폼에 로드했습니다.');
                    }
                }
                
                console.log('Logged in user ID:', loggedInUser);
                
            } catch (error) {
                console.error('Error setting user ID or loading profile:', error);
            }
        });

        // "저장" 버튼 클릭 이벤트 핸들러
        document.getElementById('saveBtn').addEventListener('click', ()=>{
            const userId = (document.getElementById('userId').value||'').trim();
            if (userId === 'guest' || userId === '') {
                 document.getElementById('formMsg').textContent = '❌ 로그인된 사용자 정보가 없습니다. 저장할 수 없습니다.';
                 return;
            }

            // 모든 폼 필드 값 수집 (완성)
            const profile = {
                userId: userId,
                name: document.getElementById('name').value,
                nationality: document.getElementById('nationality').value,
                passport: document.getElementById('passport').value,
                birth: document.getElementById('birth').value,
                entry: document.getElementById('entry').value,
                gender: document.getElementById('gender').value,
                employment: document.getElementById('employment').value,
                foreigner_grade: document.getElementById('foreigner_grade').value,
                visa_grade: document.getElementById('visa_grade').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                home_address: document.getElementById('home_address').value,
                current_company: document.getElementById('current_company').value,
                company_entry_date: document.getElementById('company_entry_date').value,
                annual_salary: document.getElementById('annual_salary').value,
                commute_company: document.getElementById('commute_company').value,
                has_health: document.getElementById('has_health').value,
                stay_expiry_date: document.getElementById('stay_expiry_date').value,
                has_loan: document.getElementById('has_loan').value,
            };

            // 유효성 검사 (예시: 이름 필드 확인)
            if (profile.name.trim() === '') {
                 document.getElementById('formMsg').textContent = '⚠️ 이름을 입력해야 합니다.';
                 return;
            }

            // 데이터 저장/업데이트 로직
            const profiles = loadProfiles();
            const existingIndex = profiles.findIndex(p => p.userId === profile.userId);

            if (existingIndex > -1) {
                // 기존 정보 업데이트
                profiles[existingIndex] = profile;
            } else {
                // 새 정보 추가 (로그인된 사용자가 새 정보를 입력하는 경우)
                profiles.push(profile);
            }

            saveProfiles(profiles);
            document.getElementById('formMsg').textContent = '✅ 개인정보가 성공적으로 저장되었습니다. 잠시 후 메인 페이지로 이동합니다.';
            
            // 페이지 리디렉션
            setTimeout(()=>{ window.location.href = 'index.html'; }, 1200);
        });
        // resetBtn은 type="reset"으로 변경되어 별도 JS 핸들러가 필요 없음.
    </script>
</body>
</html>
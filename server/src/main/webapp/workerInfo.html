<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LOANDOC - 개인정보 입력</title>
    <style>
        body{font-family:Arial,Helvetica,sans-serif;background:#f6f6f6;margin:0}
    header{background:#2d6cdf;color:#fff;padding:28px 20px;text-align:center}
    main{max-width:none;width:100%;margin:24px 0;background:#f6f6f6;padding:18px 24px;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.06);box-sizing:border-box}
        label{display:block;margin-bottom:6px;font-weight:600}
        input, select, textarea { box-sizing: border-box; width:100%; height:40px; padding:10px 12px; border:1px solid #ccc; border-radius:6px; margin:0; }
        .grid{display:grid;grid-template-columns:1fr 1fr; gap:18px 18px; align-items:start}
        .note{color:#666;font-size:0.95em; margin-top:8px}
        button{background:#2d6cdf;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer}
        /* 네비게이션 스타일 */
        nav{display:flex;justify-content:center;gap:10px;padding:12px 8px;background:#f6f6f6;align-items:center;flex-wrap:nowrap;overflow-x:auto;white-space:nowrap}
            nav a{color:#2d6cdf;text-decoration:none;font-weight:600;padding:6px 8px}
            .nav-button{background:#FFD400;color:#000;border:none;padding:8px 12px;min-width:100px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;font-size:14px;flex:0 0 auto;box-sizing:border-box}
        /* 미디어 쿼리 (반응형) */
        @media(max-width:720px){ .grid{grid-template-columns:1fr;} input, select, textarea{height:44px;} }
    /* (removed right-align rule so buttons stay adjacent) */
        /* form message icon and bangs */
        .form-msg { display:inline-flex; align-items:center; gap:8px; font-weight:700; }
        .msg-icon { width:18px; height:18px; display:inline-block; vertical-align:middle; }
        .msg-bangs { margin-left:8px; color:#b91c1c; font-weight:900; }
    </style>
    <style>
    /* Column based nav (shared) */
    nav.nav-columns{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;padding:10px;background:#f6f6f6;border-radius:10px;align-items:start}
    nav.nav-columns .nav-column{display:flex;flex-direction:column;gap:12px}
    nav.nav-columns .nav-button{background:#FFD400;color:#000;border:none;padding:10px 12px;height:auto;display:block;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;font-size:14px;width:100%;box-sizing:border-box;text-align:center}
    nav.nav-columns .nav-column:nth-child(1){padding-right:12px}
    nav.nav-columns .nav-column:nth-child(2){padding:0 12px}
    nav.nav-columns .nav-column:nth-child(3){padding-left:12px}
    nav.nav-columns .nav-column:nth-child(4){padding-left:12px}
    @media (max-width:600px){nav.nav-columns{grid-template-columns:repeat(2,1fr);gap:10px;padding:8px}nav.nav-columns .nav-button{font-size:13px;padding:8px}}
    
    /* 약관 모달 스타일 */
    .terms-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        overflow: auto;
    }
    .terms-modal-content {
        background-color: #fff;
        margin: 5% auto;
        padding: 0;
        border-radius: 8px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
    }
    .terms-modal-header {
        padding: 20px;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .terms-modal-header h2 {
        margin: 0;
        color: #2d6cdf;
        font-size: 18px;
    }
    .terms-modal-close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        width: 30px;
        height: 30px;
        line-height: 28px;
    }
    .terms-modal-close:hover {
        color: #000;
    }
    .terms-modal-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }
    .terms-modal-footer {
        padding: 20px;
        border-top: 1px solid #ddd;
        background-color: #f9f9f9;
    }
    .terms-agree-checkbox {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    .terms-agree-checkbox input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    .terms-agree-checkbox label {
        cursor: pointer;
        margin: 0;
        font-weight: 600;
        color: #333;
    }
    .terms-modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    .terms-modal-buttons button {
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
    }
    .terms-modal-buttons .btn-confirm {
        background: #2d6cdf;
        color: #fff;
        border: none;
    }
    .terms-modal-buttons .btn-confirm:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    .terms-modal-buttons .btn-cancel {
        background: #fff;
        color: #333;
        border: 1px solid #ccc;
    }
    .terms-title-link {
        color: #2d6cdf;
        cursor: pointer;
        text-decoration: underline;
    }
    .terms-title-link:hover {
        color: #1a4d9f;
    }
    </style>
</head>
<body>
    <header>
        <h1>외국인 근로자 신용 대출</h1>
        <p>LOANDOC</p>
    </header>
    <nav class="nav-columns" aria-label="주요 네비게이션">
        <div class="nav-column">
            <a class="nav-button" href="home.html">LOANDOC</a>
            <a class="nav-button" href="introCo.html">회사소개</a>
            <a class="nav-button" href="intro.html">상품소개</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="login.html">로그인</a>
            <a class="nav-button" href="#" id="nav-logout">로그아웃</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="loanAppl.html">대출조회</a>
            <a class="nav-button" href="loanDashboard.html">대출상담요청게시판</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="dashboard.html">게시판</a>
            <a class="nav-button" href="customer.html">고객센터</a>
        </div>
    </nav>
    <hr />
    <main>
        <div style="position:relative;padding:28px 0;">
            <h2 style="margin:0;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);">개인 정보</h2>
            <div style="position:absolute;right:0;top:50%;transform:translateY(-50%);font-size:0.95em;color:#333;white-space:nowrap;display:flex;align-items:center;gap:8px;">
                <strong style="margin:0">아이디:</strong>
                <input id="displayUserIdInput" readonly aria-label="로그인 아이디" style="width:220px;padding:10px 12px;border-radius:6px;border:1px solid #ccc;background:#f5f9ff;color:#2d6cdf;font-weight:800;text-align:center;font-size:1.1rem;" value="-" />
            </div>
        </div>
        <form id="profileForm">
            <input type="hidden" id="userId" name="userId" value="" /> 

            <div class="grid">
                <div>
                    <label for="name">1. 이름 (name)</label>
                    <input id="name" />
                </div>
                <div>
                    <label for="nationality">2. 국가 (nationality)</label>
                    <select id="nationality">
                        <option value="">선택</option>
                        <option>Cambodia</option>
                        <option>Bangladesh</option>
                        <option>China</option>
                        <option>East Timor</option>
                        <option>India</option>
                        <option>Indonesia</option>
                        <option>Kazakhstan</option>
                        <option>Kyrgyzstan</option>
                        <option>Laos</option>
                        <option>Myanmar</option>
                        <option>Nepal</option>
                        <option>Pakistan</option>
                        <option>Philippines</option>
                        <option>Sri Lanka</option>
                        <option>Thailand</option>
                        <option>Uzbekistan</option>
                        <option>Vietnam</option>
                    </select>
                </div>

                <div>
                    <label for="passport">3. 여권번호 (passport_number)</label>
                    <input id="passport" />
                </div>
                <div>
                    <label for="birth">4. 생년월일 (birth_date)</label>
                    <input id="birth" type="date" />
                </div>

                <div>
                    <label for="entry">5. 입국일자 (entry_date)</label>
                    <input id="entry" type="date" />
                </div>

                <div>
                    <label for="phone">6. 전화번호 (phone_number)</label>
                    <input id="phone" />
                </div>

                <div>
                    <label for="current_company">7. 현재 직장명 (current_company)</label>
                    <input id="current_company" />
                </div>

                <div>
                    <label for="email">8. 이메일 (email)</label>
                    <input id="email" type="email" />
                </div>

                                <div class="full">
                    <label style="font-weight:700; margin-top:12px; margin-bottom:8px; display:block;">9. 비밀번호 변경</label>
                    <div style="display:grid; grid-template-columns: 1.2fr 1.2fr 1.2fr 0.6fr; gap:14px; align-items:end; margin-bottom:10px; width:100%;">
                        <div>
                            <label for="currentPassword">기존 비밀번호</label>
                            <input id="currentPassword" type="password" placeholder="현재 비밀번호" />
                        </div>
                        <div>
                            <label for="newPassword">새 비밀번호</label>
                            <input id="newPassword" type="password" placeholder="8자 이상, 숫자+특수문자" />
                        </div>
                        <div>
                            <label for="confirmPassword">비밀번호 확인</label>
                            <input id="confirmPassword" type="password" placeholder="새 비밀번호 재입력" />
                        </div>
                        <button type="button" id="changePasswordBtn" style="background:#f59e0b; height:38px; padding:0 16px; white-space:nowrap; width:100%;">비밀번호 변경</button>
                    </div>
                    <div id="passwordChangeMsg" class="note"></div>
                </div>

                <div class="full">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; margin-bottom:8px;">
                        <label style="font-weight:700; margin:0;">10. 약관동의</label>
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:600; color:#2d6cdf;">
                            <input type="checkbox" id="agreeAllTerms" style="width:20px; height:20px; cursor:pointer;">
                            <span>전체 동의</span>
                        </label>
                    </div>
                    <div style="border:1px solid #ccc; border-radius:6px; padding:16px; background:#f9f9f9;">
                        <div style="font-weight:600; margin-bottom:12px; color:#2d6cdf;">론닥 서비스 이용 약관</div>
                        <div id="termsListArea" style="min-height:100px;">
                            <p style="color:#666; text-align:center; margin:40px 0;">약관 목록을 불러오는 중...</p>
                        </div>
                    </div>
                </div>
            </div>
```
            </div>
            <div style="margin-top:12px; display:flex; align-items:center; gap:12px;">
                <button type="button" id="saveBtn">저장</button>
                <button type="reset" id="resetBtn">초기화</button>
                <div id="formMsg" class="note" style="margin:0;"></div>
            </div>
        </form>
    </main>
    <script>
        const WORKER_INFO_API_BASE = '/server';
        const FOREIGN_WORKER_URL = `${WORKER_INFO_API_BASE}/api/foreign_worker_master`;
        const CHANGE_PASSWORD_URL = `${WORKER_INFO_API_BASE}/api/auth/change-password`;
        const LOGOUT_URL = `${WORKER_INFO_API_BASE}/api/auth/logout`;

        async function showTermsDetail(title) {
            const modal = document.getElementById('termsModal');
            const modalTitle = document.getElementById('termsModalTitle');
            const modalContent = document.getElementById('termsModalContent');
            const agreeCheckbox = document.getElementById('termsAgreeCheckbox');
            const confirmBtn = document.getElementById('termsConfirmBtn');

            modalTitle.textContent = title;
            modalContent.textContent = '로딩 중...';
            agreeCheckbox.checked = false;
            confirmBtn.disabled = true;
            modal.style.display = 'block';

            try {
                const pureTitle = title.startsWith('[필수]') ? title.replace(/^\[필수\]\s*/, '') : title;
                const url = `${WORKER_INFO_API_BASE}/api/documents/content?title=${encodeURIComponent(pureTitle)}`;
                const response = await fetch(url);
                const result = await response.json();
                modalContent.textContent = (result.ok && result.content) ? result.content : '약관 내용을 불러올 수 없습니다.';
            } catch (error) {
                console.error('약관 내용 로드 오류:', error);
                modalContent.textContent = '약관 내용 로드 중 오류가 발생했습니다.';
            }
        }

        // 전역 함수: 전체 동의 체크박스 이벤트 리스너 설정
        function setupAgreeAllTermsListener() {
            const agreeAllCheckbox = document.getElementById('agreeAllTerms');
            if (agreeAllCheckbox) {
                agreeAllCheckbox.addEventListener('change', function() {
                    const individualCheckboxes = document.querySelectorAll('.individual-term-checkbox');
                    individualCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                });
            }
        }

        // 전역 함수: 개별 약관 체크박스 변경 시 전체 동의 상태 업데이트
        function checkIndividualTermChange() {
            const individualCheckboxes = document.querySelectorAll('.individual-term-checkbox');
            const agreeAllCheckbox = document.getElementById('agreeAllTerms');
            
            if (!agreeAllCheckbox || individualCheckboxes.length === 0) return;
            
            // 모든 개별 체크박스가 체크되어 있는지 확인
            const allChecked = Array.from(individualCheckboxes).every(checkbox => checkbox.checked);
            
            // 전체 동의 체크박스 상태 업데이트
            agreeAllCheckbox.checked = allChecked;
        }

        // 전역 함수: 모달 닫기
        function closeTermsModal() {
            document.getElementById('termsModal').style.display = 'none';
        }

        // DOM 콘텐츠 로드 후 실행
        document.addEventListener('DOMContentLoaded', async function(){
            const TERMS_GROUP_URL = `${WORKER_INFO_API_BASE}/api/documents?group_name=${encodeURIComponent('론닥 서비스 이용약관')}`;

            // 접근 시간 확인 및 자동 로그아웃 처리
            function checkAccessTime() {
                try {
                    const loginId = localStorage.getItem('login-id');
                    const accessTimeStr = localStorage.getItem('login-access-time');
                    
                    if (!loginId || !accessTimeStr) {
                        return false;
                    }
                    
                    // 접근 시간 확인 (10분 = 600000 밀리초)
                    const accessTime = new Date(accessTimeStr);
                    const currentTime = new Date();
                    const timeDiff = currentTime.getTime() - accessTime.getTime();
                    const tenMinutes = 10 * 60 * 1000; // 10분
                    
                    if (timeDiff > tenMinutes) {
                        // 10분 이상 경과 시 자동 로그아웃
                        localStorage.removeItem('login-id');
                        localStorage.removeItem('login-access-time');
                        alert('10분 이상 비활성 상태로 인해 자동 로그아웃되었습니다. 다시 로그인해주세요.');
                        window.location.href = 'login.html';
                        return false;
                    }
                    
                    // 접근 시간 업데이트
                    localStorage.setItem('login-access-time', new Date().toISOString());
                    return true;
                } catch (e) {
                    console.error('Access time check error', e);
                    return false;
                }
            }

            // login-id 가져오기 (localStorage 우선, 없으면 URL 파라미터)
            function getLoginId() {
                // 먼저 접근 시간 확인
                if (!checkAccessTime()) {
                    return null; // checkAccessTime에서 이미 로그아웃 처리 및 리다이렉트 완료
                }
                
                // 1. localStorage에서 먼저 확인
                let loginId = localStorage.getItem('login-id');
                if (loginId && loginId.trim() !== '') {
                    return loginId.trim();
                }
                // 2. URL 파라미터에서 확인
                const urlParams = new URLSearchParams(window.location.search);
                loginId = urlParams.get('login-id');
                if (loginId && loginId.trim() !== '') {
                    // URL 파라미터에서 가져온 경우 localStorage에 저장하고 접근 시간도 저장
                    localStorage.setItem('login-id', loginId.trim());
                    localStorage.setItem('login-access-time', new Date().toISOString());
                    return loginId.trim();
                }
                return null;
            }

            // login-id 체크 및 초기화
            async function initializePage() {
                const loginId = getLoginId();
                
                // login-id가 null이면 로그인 페이지로 이동
                if (!loginId) {
                    alert('로그인이 필요합니다');
                    window.location.href = 'login.html';
                    return;
                }
                
                // 로그인 ID 표시 업데이트
                const displayInput = document.getElementById('displayUserIdInput');
                const hiddenInput = document.getElementById('userId');
                if (displayInput) displayInput.value = loginId || '';
                if (hiddenInput) hiddenInput.value = loginId || '';
                
                // 개인정보 불러오기
                await loadUserProfile(loginId);
                console.log('로그인 사용자:', loginId);
            }

            // 사용자 프로필 데이터를 서버에서 가져오기
            async function loadUserProfile(loginId) {
                if (!loginId || loginId.trim() === '') {
                    console.warn('login-id가 제공되지 않았습니다.');
                    return;
                }
                try {
                    // login-id를 쿼리 파라미터로 전달
                    const url = `${FOREIGN_WORKER_URL}?login-id=${encodeURIComponent(loginId)}`;
                    const response = await fetch(url, { credentials: 'include' });
                    const result = await response.json();
                    if (result.ok && result.found && result.data) {
                        applyUserProfile(result.data);
                    } else if (result.ok && !result.found) {
                        console.info('저장된 개인정보가 없습니다. 새로 입력해 주세요.');
                    } else {
                        console.warn('개인정보 조회 실패:', result.error || result.message);
                    }
                } catch (error) {
                    console.error('프로필 로드 오류:', error);
                }
            }

            function applyUserProfile(data) {
                const fieldMap = [
                    ['name', 'name'],
                    ['nationality', 'nationality'],
                    ['passport', 'passport_number'],
                    ['birth', 'birth_date'],
                    ['entry', 'entry_date'],
                    ['phone', 'phone_number'],
                    ['current_company', 'current_company'],
                    ['email', 'email']
                ];
                fieldMap.forEach(([elementId, key]) => {
                    const el = document.getElementById(elementId);
                    if (!el) return;
                    const value = (data && data[key]) ? data[key] : '';
                    el.value = value || '';
                });
            }
            // 전역에서 호출 가능하도록 window에 등록
            window.loadUserProfile = loadUserProfile;

            // 약관 목록 불러오기
            async function loadTermsList() {
                try {
                    const response = await fetch(TERMS_GROUP_URL);
                    const result = await response.json();
                    const termsListArea = document.getElementById('termsListArea');
                    if (!termsListArea) return;

                    if (result.ok && result.documents && result.documents.length > 0) {
                        const personalInfoTerms = result.documents.filter(doc => doc.title && doc.title.includes('개인정보'));
                        if (personalInfoTerms.length === 0) {
                            termsListArea.innerHTML = '<p style="color:#999; margin:20px 0;">개인정보 관련 약관이 없습니다.</p>';
                            return;
                        }
                        let html = '';
                        personalInfoTerms.forEach(doc => {
                            const displayTitle = `[필수] ${doc.title}`;
                            html += `
                                <div style="margin-bottom:10px; display:flex; align-items:center; gap:8px;">
                                    <input type="checkbox" class="individual-term-checkbox" id="term_${doc.id}" value="${doc.id}"
                                           style="width:18px; height:18px; cursor:pointer; flex-shrink:0;" onchange="checkIndividualTermChange()">
                                    <span class="terms-title-link" onclick="showTermsDetail('${displayTitle}')" style="cursor:pointer; color:#2563eb; text-decoration:underline;">${displayTitle}</span>
                                </div>
                            `;
                        });
                        termsListArea.innerHTML = html;
                        setupAgreeAllTermsListener();
                    } else {
                        termsListArea.innerHTML = '<p style="color:#999; margin:20px 0;">약관을 불러올 수 없습니다.</p>';
                    }
                } catch (error) {
                    console.error('약관 로드 오류:', error);
                    const termsListArea = document.getElementById('termsListArea');
                    if (termsListArea) {
                        termsListArea.innerHTML = '<p style="color:#e74c3c; margin:20px 0;">약관 로드 중 오류가 발생했습니다.</p>';
                    }
                }
            }

            // 모달 외부 클릭 시 닫기
            window.onclick = function(event) {
                const modal = document.getElementById('termsModal');
                if (event.target === modal) {
                    closeTermsModal();
                }
            }

            // 동의 체크박스 상태에 따라 확인 버튼 활성화
            document.getElementById('termsAgreeCheckbox').addEventListener('change', function() {
                document.getElementById('termsConfirmBtn').disabled = !this.checked;
            });

            // 확인 버튼 클릭 시
            document.getElementById('termsConfirmBtn').addEventListener('click', function() {
                const title = document.getElementById('termsModalTitle').textContent;
                
                // 해당 약관의 체크박스를 찾아서 체크
                const checkboxes = document.querySelectorAll('.individual-term-checkbox');
                const titleLinks = document.querySelectorAll('.terms-title-link');
                
                // 타이틀과 일치하는 체크박스 찾기
                titleLinks.forEach((link, index) => {
                    if (link.textContent === title && checkboxes[index]) {
                        checkboxes[index].checked = true;
                        // 전체 동의 상태 업데이트
                        checkIndividualTermChange();
                    }
                });
                
                alert(`"${title}"에 동의하셨습니다.`);
                closeTermsModal();
            });

            // 페이지 로드 시 login-id 체크 및 약관 로드
            initializePage();
            loadTermsList();
        });

       // "저장" 버튼 클릭 이벤트 핸들러
       // validate form before sending to server
       function validateForm() {
            const msgEl = document.getElementById('formMsg');
            msgEl.style.color = '#9b1c1c';
            // required text fields
            const nameEl = document.getElementById('name');
            if (!nameEl || nameEl.value.trim() === '') {
                msgEl.textContent = '⚠️ 이름을 입력하세요.';
                if (nameEl) nameEl.focus();
                return { ok: false };
            }
            const passportEl = document.getElementById('passport');
            if (!passportEl || passportEl.value.trim() === '') {
                msgEl.textContent = '⚠️ 여권번호를 입력하세요.';
                if (passportEl) passportEl.focus();
                return { ok: false };
            }

            // 날짜 형식 검증은 하지 않음 (요청에 따라 생년월일/입국일자/입사일자/체재만료일자 검증 제외)

            // NOT NULL checks for specific fields
            const notNullIds = ['phone','address','home_address','current_company'];
            for (const id of notNullIds) {
                const el = document.getElementById(id);
                if (!el) continue;
                const v = (el.value || '').toString().trim();
                if (v === '') {
                    msgEl.textContent = `⚠️ '${el.previousElementSibling ? el.previousElementSibling.innerText.split('(')[0].trim() : id}' 항목은 필수입니다.`;
                    el.focus();
                    return { ok: false };
                }
            }

            // 날짜 필드들: 필수(빈값 불가)이며 YYYY-MM-DD 형식 및 유효한 날짜인지 검사
            const dateFieldsToValidate = ['birth','entry'];
            for (const id of dateFieldsToValidate) {
                const el = document.getElementById(id);
                if (!el) continue;
                const v = (el.value || '').toString().trim();
                // now required
                if (v === '') {
                    msgEl.textContent = `⚠️ ${el.previousElementSibling ? el.previousElementSibling.innerText.split('(')[0].trim() : id} 항목은 필수입니다.`;
                    el.focus();
                    return { ok: false };
                }
                // format check
                if (!/^\d{4}-\d{2}-\d{2}$/.test(v)) {
                    msgEl.textContent = `⚠️ ${el.previousElementSibling ? el.previousElementSibling.innerText.split('(')[0].trim() : id} 날짜 형식이 올바르지 않습니다 (YYYY-MM-DD).`;
                    el.focus();
                    return { ok: false };
                }
                // semantic validity
                const parts = v.split('-').map(x => Number(x));
                const year = parts[0], month = parts[1], day = parts[2];
                const d = new Date(v);
                if (isNaN(d.getTime()) || d.getFullYear() !== year || (d.getMonth()+1) !== month || d.getDate() !== day) {
                    msgEl.textContent = `⚠️ ${el.previousElementSibling ? el.previousElementSibling.innerText.split('(')[0].trim() : id} 유효한 날짜가 아닙니다.`;
                    el.focus();
                    return { ok: false };
                }
            }

            // clear message when valid
            msgEl.textContent = '';
            return { ok: true };
       }

       document.getElementById('saveBtn').addEventListener('click', async ()=>{
            const userId = (document.getElementById('userId').value||'').trim();
            if (userId === '') {
                 document.getElementById('formMsg').textContent = '❌ 로그인된 사용자 정보가 없습니다. 저장할 수 없습니다.';
                 return;
            }

            // run validations first
            const v = validateForm();
            if (!v.ok) return;

            // 전체 동의 체크 확인
            const agreeAllCheckbox = document.getElementById('agreeAllTerms');
            if (agreeAllCheckbox && !agreeAllCheckbox.checked) {
                document.getElementById('formMsg').textContent = '⚠️ 약관 전체 동의가 필요합니다.';
                document.getElementById('formMsg').style.color = '#e74c3c';
                // 약관 섹션으로 스크롤
                agreeAllCheckbox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            // 모든 폼 필드 값 수집 (완성)
            const profile = {
                // 서버에 보낼 payload는 반드시 user_id 등 서버 필드명으로 맞춰야 함
                user_id: userId,
                name: document.getElementById('name').value,
                nationality: document.getElementById('nationality').value,
                passport_number: document.getElementById('passport').value,
                birth_date: document.getElementById('birth').value,
                entry_date: document.getElementById('entry').value,
                phone_number: document.getElementById('phone').value,
                current_company: document.getElementById('current_company').value,
                email: document.getElementById('email').value
            };

            // 유효성 검사 (예시: 이름 필드 확인)
            if (profile.name.trim() === '') {
                 document.getElementById('formMsg').textContent = '⚠️ 이름을 입력해야 합니다.';
                 return;
            }

            // 서버로 전송할 페이로드: 화면 레이블의 괄호 안 영문명을 키로 사용
            const payload = {
                user_id: userId,
                name: profile.name,
                nationality: profile.nationality,
                passport_number: profile.passport_number,
                birth_date: profile.birth_date,
                entry_date: profile.entry_date,
                phone_number: profile.phone_number,
                current_company: profile.current_company,
                email: profile.email
            };

            // 서버에 POST 시도
            try {
                const res = await fetch(FOREIGN_WORKER_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });
                const body = await res.json().catch(()=>null);
                const msgEl = document.getElementById('formMsg');
                
                if (res.ok && body) {
                    // 서버가 반환한 메시지를 화면에 표시
                    // clear
                    msgEl.innerHTML = '';
                    msgEl.style.color = body.ok ? '#064e3b' : '#9b1c1c';

                    // create message container
                    const container = document.createElement('span');
                    container.className = 'form-msg';

                    // add icon before message
                    const icon = document.createElement('span');
                    icon.className = 'msg-icon';
                    // simple inline SVG check/edit icon
                    icon.innerHTML = body.action === 'update' ?
                        '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 13l4 4L19 7" stroke="#064e3b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' :
                        '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="#064e3b" stroke-width="2"/><path d="M9 12l2 2 4-4" stroke="#064e3b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';

                    const text = document.createElement('span');
                    text.textContent = body.message || (body.ok ? '✅ 저장 완료' : '서버 응답');

                    container.appendChild(icon);
                    container.appendChild(text);

                    // localStorage 제거됨 - bang counter 기능 제거됨
                    // if action is update, add bang counter per user_id (기능 비활성화)

                    msgEl.appendChild(container);

                    // 서버가 반환한 데이터가 있으면 폼에 반영 (필드 이름이 영어 키로 온다고 가정)
                    if (body.data && typeof body.data === 'object') {
                        Object.keys(body.data).forEach(k => {
                            try {
                                // 맵핑: 서버 필드명 -> 폼 요소 id
                                const idMap = {
                                    user_id: 'userId',
                                    passport_number: 'passport',
                                    name: 'name',
                                    nationality: 'nationality',
                                    birth_date: 'birth',
                                    entry_date: 'entry',
                                    phone_number: 'phone',
                                    current_company: 'current_company'
                                };
                                const targetId = idMap[k];
                                if (!targetId) return;
                                const el = document.getElementById(targetId);
                                if (!el) return;
                                let val = body.data[k];
                                if (targetId === 'userId') {
                                    el.value = val;
                                    // display ID도 업데이트
                                    const displayInput = document.getElementById('displayUserIdInput');
                                    if (displayInput) displayInput.value = val;
                                } else {
                                    el.value = val;
                                }
                            } catch (e) { /* ignore per-field errors */ }
                        });
                    }
                    return;
                }
                
                // 서버가 오류를 반환한 경우 - 에러 메시지를 화면에 표시
                if (!res.ok && body) {
                    msgEl.innerHTML = '';
                    msgEl.style.color = '#9b1c1c';
                    
                    // 에러 메시지 추출
                    let errorMessage = body.error || body.message || '서버 오류가 발생했습니다.';
                    
                    // 여권번호 중복 오류 처리
                    if (errorMessage.includes('foreign_worker_master_passport_number_key') || 
                        errorMessage.includes('passport_number') && errorMessage.includes('중복')) {
                        errorMessage = '⚠️ 이미 등록된 여권번호입니다. 다른 여권번호를 입력하세요.';
                        // 여권번호 필드에 포커스
                        const passportEl = document.getElementById('passport');
                        if (passportEl) {
                            passportEl.focus();
                            passportEl.select();
                        }
                    }
                    // 사용자 ID 중복 오류 처리
                    else if (errorMessage.includes('user_id') && errorMessage.includes('중복')) {
                        errorMessage = '⚠️ 이미 등록된 사용자 ID입니다.';
                    }
                    
                    msgEl.textContent = errorMessage;
                    console.warn('Server returned error:', res.status, body);
                    return;
                }
                
                // 서버가 OK가 아니거나 JSON 파싱 실패
                console.warn('Server save failed', res.status, body);
                msgEl.innerHTML = '';
                msgEl.style.color = '#9b1c1c';
                msgEl.textContent = '⚠️ 서버 저장 실패 — 고객센터로 연락주십시오.';
            } catch (err) {
                console.error('Server save failed:', err);
                const msgEl = document.getElementById('formMsg');
                msgEl.innerHTML = '';
                msgEl.style.color = '#9b1c1c';
                msgEl.textContent = '⚠️ 서버 연결 실패 — 네트워크를 확인하고 다시 시도해주세요.';
            }
        });

        // 비밀번호 변경 버튼 클릭 이벤트
        document.getElementById('changePasswordBtn').addEventListener('click', async () => {
            const msgEl = document.getElementById('passwordChangeMsg');
            msgEl.textContent = '';
            msgEl.style.color = '';
            
            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            
            // 입력 검증
            if (!currentPassword) {
                msgEl.textContent = '⚠️ 기존 비밀번호를 입력하세요.';
                msgEl.style.color = '#9b1c1c';
                document.getElementById('currentPassword').focus();
                return;
            }
            
            if (!newPassword) {
                msgEl.textContent = '⚠️ 새 비밀번호를 입력하세요.';
                msgEl.style.color = '#9b1c1c';
                document.getElementById('newPassword').focus();
                return;
            }
            
            // 비밀번호 정책 검증
            const passwordRegex = /^(?=.*[0-9])(?=.*[^A-Za-z0-9]).{8,}$/;
            if (!passwordRegex.test(newPassword)) {
                msgEl.textContent = '⚠️ 새 비밀번호는 8자 이상, 숫자와 특수문자를 포함해야 합니다.';
                msgEl.style.color = '#9b1c1c';
                document.getElementById('newPassword').focus();
                return;
            }
            
            if (newPassword !== confirmPassword) {
                msgEl.textContent = '⚠️ 새 비밀번호와 확인이 일치하지 않습니다.';
                msgEl.style.color = '#9b1c1c';
                document.getElementById('confirmPassword').focus();
                return;
            }
            
            if (currentPassword === newPassword) {
                msgEl.textContent = '⚠️ 새 비밀번호는 기존 비밀번호와 달라야 합니다.';
                msgEl.style.color = '#9b1c1c';
                document.getElementById('newPassword').focus();
                return;
            }
            
            // 서버에 비밀번호 변경 요청
            try {
                const response = await fetch(CHANGE_PASSWORD_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.ok) {
                    msgEl.textContent = '✅ 비밀번호가 성공적으로 변경되었습니다.';
                    msgEl.style.color = '#064e3b';
                    
                    // 입력 필드 초기화
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    const errorMsg = result.error || result.message || '비밀번호 변경에 실패했습니다.';
                    msgEl.textContent = '⚠️ ' + errorMsg;
                    msgEl.style.color = '#9b1c1c';
                }
            } catch (error) {
                console.error('비밀번호 변경 오류:', error);
                msgEl.textContent = '⚠️ 서버 연결 실패. 다시 시도해주세요.';
                msgEl.style.color = '#9b1c1c';
            }
        });

        // resetBtn은 type="reset"으로 동작하지만, 클릭 시 화면에 보이는
        // 알림 메시지(formMsg)를 즉시 지우도록 핸들러를 추가합니다.
        (function(){
            const form = document.getElementById('profileForm');
            const msgEl = document.getElementById('formMsg');
            // form의 reset 이벤트를 이용하면 브라우저가 필드를 초기화한 직후에 처리할 수 있습니다.
            if (form) {
                form.addEventListener('reset', () => {
                    try {
                        if (msgEl) {
                            msgEl.innerHTML = '';
                            msgEl.textContent = '';
                            // 스타일도 원래대로 되돌립니다.
                            msgEl.style.color = '';
                        }
                    } catch (e) {
                        console.error('reset handler error', e);
                    }
                });
            }
            
            // 네비게이션 로그아웃 버튼
            const navLogout = document.getElementById('nav-logout');
            if(navLogout){
                navLogout.addEventListener('click', async function(e){
                    e.preventDefault();
                    try {
                        const response = await fetch(LOGOUT_URL, {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 'login-id': null })
                        });
                        const result = await response.json();
                        if (result.ok) {
                            // localStorage에서 login-id 제거
                            localStorage.removeItem('login-id');
                            alert('로그아웃이 정상적으로 되었습니다');
                            window.location.href = 'login.html';
                        }
                    } catch (err) {
                        console.error('Logout error', err);
                    }
                });
            }
        })();
    </script>

    <!-- 약관 상세 모달 -->
    <div id="termsModal" class="terms-modal">
        <div class="terms-modal-content">
            <div class="terms-modal-header">
                <h2 id="termsModalTitle">약관 제목</h2>
                <button class="terms-modal-close" onclick="closeTermsModal()">&times;</button>
            </div>
            <div class="terms-modal-body">
                <div id="termsModalContent" style="white-space: pre-wrap; line-height: 1.6; color: #333;">
                    로딩 중...
                </div>
            </div>
            <div class="terms-modal-footer">
                <div class="terms-agree-checkbox">
                    <input type="checkbox" id="termsAgreeCheckbox">
                    <label for="termsAgreeCheckbox">상기 전체의 내용에 대하여 충분히 이해하였으며, 이에 동의합니다</label>
                </div>
                <div class="terms-modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeTermsModal()">닫기</button>
                    <button type="button" class="btn-confirm" id="termsConfirmBtn" disabled>확인</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LOANDOC - 로그인</title>
    <style>
        body{font-family:Arial,Helvetica,sans-serif;background:#f6f6f6;margin:0}
    header{background:#2d6cdf;color:#fff;padding:28px 20px;text-align:center}
    /* main top margin reduced by 50% to shorten space between hr and login controls */
    /* also reduce top padding so content inside main sits closer to the hr */
    main{max-width:420px;margin:30px auto;background:#f6f6f6;padding:14px 28px 28px;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.08)}
        label{display:block;margin-bottom:6px;font-weight:600}
        input{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-bottom:12px}
        button{background:#2d6cdf;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer}
        .button-group{display:flex;gap:12px;align-items:center;justify-content:center}
        .signup-btn{background:#28a745;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;text-decoration:none;display:inline-block;text-align:center}
        .worker-info-btn{background:#28a745;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;text-decoration:none;display:inline-block;text-align:center}
        .muted{color:#666;font-size:0.9em;margin-top:10px}

    /* visual divider under header */
    /* margin reduced by 50% to bring the content below closer */
    .header-divider{border:0;height:1px;background:#e6e6e6;margin:9px 0}

    /* center the inner login form area and constrain its width so it appears centered under the divider */
    .login-form{max-width:360px;margin:0 auto}

    /* reduce h2 default margins so the heading doesn't add extra vertical gap */
    main h2{margin:6px 0 8px;text-align:center}

    /* Nav: column-based groups (4 columns). Each column stacks buttons vertically. */
    nav.nav-columns{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;padding:10px;background:#f6f6f6;border-radius:10px;align-items:start}
    nav.nav-columns .nav-column{display:flex;flex-direction:column;gap:12px}
    nav.nav-columns .nav-button{background:#FFD400;color:#000;border:none;padding:10px 12px;height:auto;display:block;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;font-size:14px;width:100%;box-sizing:border-box;text-align:center}

    /* Column separators and paddings to emphasize grouping */
    nav.nav-columns .nav-column:nth-child(1){padding-right:12px}
    nav.nav-columns .nav-column:nth-child(2){padding:0 12px}
    nav.nav-columns .nav-column:nth-child(3){padding-left:12px}
    nav.nav-columns .nav-column:nth-child(4){padding-left:12px}

    /* Responsive: collapse to 2 columns on small screens */
    @media (max-width:600px){
        nav.nav-columns{grid-template-columns:repeat(2,1fr);gap:10px;padding:8px}
        nav.nav-columns .nav-button{font-size:13px;padding:8px}
    }

    /* 비밀번호 찾기 링크 스타일 */
    .forgot-password-link{display:block;text-align:center;margin-top:12px;color:#2d6cdf;text-decoration:none;font-size:0.9em}
    .forgot-password-link:hover{text-decoration:underline}

    /* 비밀번호 찾기 모달 */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.4)}
    .modal-content{background-color:#fefefe;margin:10% auto;padding:20px;border:1px solid #888;border-radius:8px;width:90%;max-width:400px}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-header h3{margin:0;color:#2d6cdf}
    .close{color:#aaa;font-size:28px;font-weight:bold;cursor:pointer}
    .close:hover,.close:focus{color:#000}
    .modal-body{margin-bottom:20px}
    .modal-body input[type="text"], .modal-body input[type="email"]{width:70%;margin:0 auto;display:block}
    .modal-body label{display:block;text-align:left;margin-top:10px;margin-left:15%;margin-bottom:5px}
    .modal-footer{display:flex;gap:10px;justify-content:flex-start;margin-left:200px}

    </style>
</head>
<body>
    <header>
        <h1>외국인 근로자 신용 대출</h1>
        <p>LOANDOC</p>
    </header>
    <nav class="nav-columns" aria-label="주요 네비게이션">
        <div class="nav-column">
            <a class="nav-button" href="home.html">LOANDOC</a>
            <a class="nav-button" href="introCo.html">회사소개</a>
                <a class="nav-button" href="intro.html">상품소개</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="login.html">로그인</a>
            <a class="nav-button" href="#" id="nav-logout">로그아웃</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="loanAppl.html">대출조회</a>
            <a class="nav-button" href="loanDashboard.html">대출상담요청게시판</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="dashboard.html">게시판</a>
            <a class="nav-button" href="customer.html">고객센터</a>
        </div>
    </nav>
    <hr class="header-divider" aria-hidden="true">
    <main>
        <h2>로그인</h2>
        <div class="login-form">
            <label for="loginId">아이디</label>
            <input id="loginId" type="text" placeholder="아이디 입력" />
            <label for="loginPwd">비밀번호</label>
            <input id="loginPwd" type="password" placeholder="비밀번호 입력" />
            <div class="button-group">
                <button id="loginBtn">로그인</button>
                <a href="/server/signup.html" class="signup-btn">회원가입</a>
                <a href="/server/workerInfo.html" id="workerInfoBtn" class="worker-info-btn">개인정보</a>
            </div>
            <a href="#" id="forgotPasswordLink" class="forgot-password-link">비밀번호를 잊으셨나요?</a>
            <div id="loginMsg" class="muted">아이디가 없으면 회원가입을 통해 계정을 생성하십시오.</div>
        </div>
    </main>

    <!-- 비밀번호 찾기 모달 -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>비밀번호 찾기</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p style="color:#666;font-size:0.9em;margin-bottom:15px;">
                    가입 시 등록한 아이디와 이메일을 입력하시면<br>
                    임시 비밀번호를 이메일로 발송해 드립니다.
                </p>
                <label for="resetUserId">아이디</label>
                <input id="resetUserId" type="text" placeholder="아이디 입력" />
                <label for="resetEmail">이메일</label>
                <input id="resetEmail" type="email" placeholder="이메일 입력" />
                <div id="resetMsg" class="muted" style="margin-top:10px;"></div>
            </div>
            <div class="modal-footer">
                <button id="cancelResetBtn" style="background:#6c757d;">취소</button>
                <button id="sendResetBtn">임시 비밀번호 발송</button>
            </div>
        </div>
    </div>

    <script>
        // 비밀번호 찾기 모달 관련 코드
        const modal = document.getElementById('forgotPasswordModal');
        const forgotLink = document.getElementById('forgotPasswordLink');
        const closeBtn = document.querySelector('.close');
        const cancelBtn = document.getElementById('cancelResetBtn');
        const sendResetBtn = document.getElementById('sendResetBtn');

        // 모달 열기
        forgotLink.addEventListener('click', (e) => {
            e.preventDefault();
            modal.style.display = 'block';
            document.getElementById('resetUserId').value = '';
            document.getElementById('resetEmail').value = '';
            document.getElementById('resetMsg').textContent = '';
        });

        // 모달 닫기
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        cancelBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // 모달 외부 클릭 시 닫기
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // 임시 비밀번호 발송
        sendResetBtn.addEventListener('click', async () => {
            const userId = document.getElementById('resetUserId').value.trim();
            const email = document.getElementById('resetEmail').value.trim();
            const resetMsg = document.getElementById('resetMsg');

            if (!userId || !email) {
                resetMsg.textContent = '아이디와 이메일을 모두 입력해주세요.';
                resetMsg.style.color = 'red';
                return;
            }

            // 이메일 형식 검증
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                resetMsg.textContent = '올바른 이메일 형식을 입력해주세요.';
                resetMsg.style.color = 'red';
                return;
            }

            try {
                resetMsg.textContent = '처리 중...';
                resetMsg.style.color = '#666';

                const response = await fetch('/server/api/auth/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, email })
                });

                try {
                    const result = await safeParseJson(response);
                    if (result && result.ok) {
                        resetMsg.textContent = '임시 비밀번호가 이메일로 발송되었습니다.';
                        resetMsg.style.color = 'green';
                        
                        // 3초 후 모달 닫기
                        setTimeout(() => {
                            modal.style.display = 'none';
                            alert('임시 비밀번호가 ' + email + '로 발송되었습니다.\n이메일을 확인해주세요.');
                        }, 2000);
                    } else {
                        resetMsg.textContent = (result && result.error) ? result.error : '비밀번호 재설정에 실패했습니다.';
                        resetMsg.style.color = 'red';
                    }
                } catch (e) {
                    resetMsg.textContent = '서버 오류: ' + e.message;
                    resetMsg.style.color = 'red';
                }
            } catch (error) {
                resetMsg.textContent = '서버 오류: ' + error.message;
                resetMsg.style.color = 'red';
            }
        });

        // 네비게이션 로그아웃 버튼 이벤트
        document.getElementById('nav-logout')?.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch('/server/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 'login-id': null })
                });
                const result = await safeParseJson(response);
                if (result && result.ok) {
                    currentUserId = null;
                    // localStorage에서 login-id와 접근 시간 제거
                    localStorage.removeItem('login-id');
                    localStorage.removeItem('login-access-time');
                    alert('로그아웃이 정상적으로 되었습니다');
                    // 로그아웃 성공 시 login.html로 이동
                    window.location.href = 'login.html';
                } else {
                    alert('로그아웃 처리 중 오류가 발생했습니다');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('로그아웃 처리 중 오류가 발생했습니다: ' + error.message);
            }
        });

        // 전역 로그인 상태 추적 변수
        let currentUserId = null;

        // 앱 컨텍스트 자동 감지 (강건한 방식)
        const APP_BASE = (function(){
            try{
                const p = window.location.pathname || '';
                const m = p.match(/^\/(?<ctx>[^\/]+)\//);
                return (m && m.groups && m.groups.ctx) ? ('/' + m.groups.ctx) : '';
            }catch(e){ return ''; }
        })();
        const EFFECTIVE_BASE = APP_BASE || '';

        // 페이지 로드 시 localStorage에서 로그인 아이디를 입력창에 표시
        function populateLoginIdFromStorage(){
            try{
                const loginId = localStorage.getItem('login-id');
                if(loginId && loginId.trim() !== ''){
                    const input = document.getElementById('loginId');
                    if(input) input.value = loginId;
                    // reflect login state in client variable
                    currentUserId = loginId;
                }
            }catch(err){
                // 실패해도 동작에 영향없음
                console.debug('populateLoginIdFromStorage error', err);
            }
        }

        // 실행: DOM 준비 후 호출
        if(document.readyState === 'complete' || document.readyState === 'interactive'){
            populateLoginIdFromStorage();
        } else {
            window.addEventListener('DOMContentLoaded', populateLoginIdFromStorage);
        }

        // 서버 세션 기반 로그인 구현
        document.getElementById('loginBtn').addEventListener('click', async ()=>{
            // 이미 로그인 상태면 경고 메시지 출력
            if(currentUserId){
                const loginMsg = document.getElementById('loginMsg');
                loginMsg.textContent = '이미 로그인 상태입니다.';
                loginMsg.style.color = 'green';
                return;
            }
            // 이전 메시지 삭제
            const loginMsg = document.getElementById('loginMsg');
            loginMsg.textContent = '아이디가 없으면 회원가입을 통해 계정을 생성하십시오.';
            loginMsg.style.color = '#666';
            
            const id = (document.getElementById('loginId')?.value||'').trim();
            const pw = (document.getElementById('loginPwd')?.value||'').trim();
            
            if(!id || !pw){
                loginMsg.textContent = '아이디와 비밀번호를 입력하세요.';
                loginMsg.style.color = 'red';
                return;
            }
            
            try {
                const response = await fetch('/server/api/auth/login', { credentials: 'include',
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, password: pw })
                });

                try {
                    const result = await safeParseJson(response);
                    if (result && result.ok) {
                        loginMsg.textContent = '로그인 성공!';
                        loginMsg.style.color = 'green';
                        // reflect login state
                        currentUserId = id;
                        // localStorage에 login-id와 접근 시간 저장
                        localStorage.setItem('login-id', id);
                        localStorage.setItem('login-access-time', new Date().toISOString());
                    } else {
                        loginMsg.textContent = (result && result.error) ? result.error : '로그인 실패';
                        loginMsg.style.color = 'red';
                    }
                } catch (e) {
                    loginMsg.textContent = '서버 오류: ' + e.message;
                    loginMsg.style.color = 'red';
                }
            } catch (error) {
                loginMsg.textContent = '서버 오류: ' + error.message;
                loginMsg.style.color = 'red';
            }
        });

        // 개인정보 버튼 클릭 이벤트
        document.getElementById('workerInfoBtn').addEventListener('click', async () => {
            const loginMsg = document.getElementById('loginMsg');

            // 이전 메시지 삭제
            loginMsg.textContent = '아이디가 없으면 회원가입을 통해 계정을 생성하십시오.';
            loginMsg.style.color = '#666';
            
            const id = (document.getElementById('loginId')?.value||'').trim();
            const pw = (document.getElementById('loginPwd')?.value||'').trim();
            
            if(!id || !pw){
                loginMsg.textContent = '아이디와 비밀번호를 입력하세요.';
                loginMsg.style.color = 'red';
                return;
            }
            
            try {
                const response = await fetch('/server/api/auth/login', { credentials: 'include',
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, password: pw })
                });

                try {
                    const result = await safeParseJson(response);
                    if (result && result.ok) {
                        // 로그인 성공 상태 반영
                        currentUserId = id;
                        // localStorage에 login-id와 접근 시간 저장
                        localStorage.setItem('login-id', id);
                        localStorage.setItem('login-access-time', new Date().toISOString());
                        // 개인정보 페이지로 이동
                        window.location.href = 'workerInfo.html';
                    } else {
                        loginMsg.textContent = (result && result.error) ? result.error : '로그인 실패';
                        loginMsg.style.color = 'red';
                    }
                } catch (e) {
                    loginMsg.textContent = '서버 오류: ' + e.message;
                    loginMsg.style.color = 'red';
                }
            } catch (error) {
                loginMsg.textContent = '서버 오류: ' + error.message;
                loginMsg.style.color = 'red';
            }
        });

        // Helper: safely parse JSON responses; if server returned non-JSON, return the text as an Error
        async function safeParseJson(response){
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')){
                return await response.json();
            }
            // if response is empty, throw a concise error
            const txt = await response.text();
            if(!txt) throw new Error('서버가 응답을 반환하지 않았습니다 (empty body)');
            // Try to trim common HTML server error wrappers for brevity
            const stripped = txt.replace(/\s+/g,' ').trim();
            throw new Error('서버가 JSON이 아닌 응답을 반환했습니다: ' + (stripped.length>200? stripped.slice(0,200)+'...': stripped));
        }
    </script>
    <script>
    // 페이지 로드 시 loadUserProfile 실행 (login.html에는 정의되어 있지 않으므로 주석 처리)
    // window.addEventListener('DOMContentLoaded', loadUserProfile);
    </script>
</body>
</html>


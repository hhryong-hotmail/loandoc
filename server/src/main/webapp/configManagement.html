<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LOANDOC - 형상관리시스템</title>
    <style>
        body{font-family:Arial,Helvetica,sans-serif;background:#f6f6f6;margin:0}
        header{background:#2d6cdf;color:#fff;padding:28px 20px;text-align:center}
        main{max-width:none;width:100%;margin:24px 0;background:#f6f6f6;padding:18px 24px;border-radius:8px;box-sizing:border-box}
        nav{display:flex;justify-content:center;gap:10px;padding:12px 8px;background:#f6f6f6;align-items:center;flex-wrap:nowrap;overflow-x:auto;white-space:nowrap}
        .nav-button{background:#FFD400;color:#000;border:none;padding:8px 12px;min-width:100px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;font-size:14px;flex:0 0 auto;box-sizing:border-box}
        .hero{background:#fff;padding:28px;border-radius:8px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.06)}
        table{width:100%;border-collapse:collapse;background:#fff}
        th{background:#2d6cdf;color:#fff;padding:12px;text-align:left;font-weight:700}
        td{padding:10px;border-bottom:1px solid #eee}
        tr:hover{background:#f9f9f9}
        .status-badge{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:700;display:inline-block}
        .status-waiting{background:#ffc107;color:#000}
        .status-submitted{background:#17a2b8;color:#fff}
        .status-approved{background:#28a745;color:#fff}
        .status-rejected{background:#dc3545;color:#fff}
        .btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:700;font-size:14px;margin:2px}
        .btn-primary{background:#2d6cdf;color:#fff}
        .btn-success{background:#28a745;color:#fff}
        .btn-danger{background:#dc3545;color:#fff}
        .btn-warning{background:#ffc107;color:#000}
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5)}
        .modal-content{background:#fff;margin:5% auto;padding:20px;border-radius:8px;width:80%;max-width:600px;max-height:80vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #eee;padding-bottom:10px}
        .modal-close{cursor:pointer;font-size:24px;font-weight:700;color:#999}
        .modal-close:hover{color:#000}
        .form-group{margin-bottom:15px}
        .form-group label{display:block;margin-bottom:5px;font-weight:700}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box}
        .form-group textarea{min-height:100px;resize:vertical}
    </style>
    <style>
        nav.nav-columns{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;padding:10px;background:#f6f6f6;border-radius:10px;align-items:start}
        nav.nav-columns .nav-column{display:flex;flex-direction:column;gap:12px}
        nav.nav-columns .nav-button{background:#FFD400;color:#000;border:none;padding:10px 12px;height:auto;display:block;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;font-size:14px;width:100%;box-sizing:border-box;text-align:center}
        nav.nav-columns .nav-column:nth-child(1){padding-right:12px}
        nav.nav-columns .nav-column:nth-child(2){padding:0 12px}
        nav.nav-columns .nav-column:nth-child(3){padding-left:12px}
        nav.nav-columns .nav-column:nth-child(4){padding-left:12px}
        @media (max-width:600px){nav.nav-columns{grid-template-columns:repeat(2,1fr);gap:10px;padding:8px}nav.nav-columns .nav-button{font-size:13px;padding:8px}}
    </style>
</head>
<body>
    <header>
        <h1>외국인 근로자 신용 대출</h1>
        <p>LOANDOC - 형상관리시스템</p>
    </header>
    <nav class="nav-columns" aria-label="주요 네비게이션">
        <div class="nav-column">
            <a class="nav-button" href="home.html">LOANDOC</a>
            <a class="nav-button" href="introCo.html">회사소개</a>
            <a class="nav-button" href="intro.html">상품소개</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="login.html">로그인</a>
            <a class="nav-button" href="#" id="nav-logout">로그아웃</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="loanAppl.html">대출조회</a>
            <a class="nav-button" href="loanDashboard.html">대출상담요청게시판</a>
        </div>
        <div class="nav-column">
            <a class="nav-button" href="dashboard.html">게시판</a>
            <a class="nav-button" href="customer.html">고객센터</a>
            <a class="nav-button" href="configManagement.html">형상관리시스템</a>
        </div>
    </nav>
    <hr />
    <main>
        <div class="hero">
            <h2>형상관리시스템</h2>
            <p class="note">GitHub 변경이력 조회 및 결재 관리</p>
            <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                <input id="searchInput" placeholder="검색어 (프로그램명/변경사유/개발자)" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd" />
                <select id="filterStatus" style="padding:8px;border-radius:6px;border:1px solid #ddd">
                    <option value="전체">전체</option>
                    <option value="대기중">대기중</option>
                    <option value="제출됨">제출됨</option>
                    <option value="승인됨">승인됨</option>
                    <option value="반려됨">반려됨</option>
                </select>
                <select id="filterEnvType" style="padding:8px;border-radius:6px;border:1px solid #ddd">
                    <option value="전체">전체</option>
                    <option value="테스트">테스트</option>
                    <option value="운영">운영</option>
                </select>
                <select id="filterStageType" style="padding:8px;border-radius:6px;border:1px solid #ddd">
                    <option value="전체">전체</option>
                    <option value="개발">개발</option>
                    <option value="테스트">테스트</option>
                    <option value="배포">배포</option>
                </select>
                <button class="nav-button" id="searchBtn">검색</button>
                <button class="nav-button" id="refreshBtn">새로고침</button>
            </div>
        </div>

        <section style="margin-top:18px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.04)">
            <div style="overflow-x:auto">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th style="width:60px">ID</th>
                            <th style="width:150px">변경일시</th>
                            <th style="width:120px">개발자</th>
                            <th style="width:200px">프로그램명</th>
                            <th style="width:250px">변경사유</th>
                            <th style="width:100px">상태</th>
                            <th style="width:100px">환경</th>
                            <th style="width:100px">단계</th>
                            <th style="width:150px">결재번호</th>
                            <th style="width:100px">승인자</th>
                            <th style="width:200px">작업내용</th>
                            <th style="width:200px">승인/반려 내용</th>
                            <th style="width:200px">검토 및 결과</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </section>

        <!-- 제출 모달 -->
        <div id="submitModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>결재 제출</h3>
                    <span class="modal-close" id="submitModalClose">&times;</span>
                </div>
                <form id="submitForm">
                    <input type="hidden" id="submitId" />
                    <div class="form-group">
                        <label>결재번호 (자동 생성)</label>
                        <input type="text" id="submitApprovalNumber" readonly style="background:#f5f5f5;color:#666" />
                        <small style="color:#666;font-size:12px">YYYYMMDD-001 형식으로 자동 생성됩니다</small>
                    </div>
                    <div class="form-group">
                        <label>적용서버</label>
                        <input type="text" id="submitTargetServer" />
                    </div>
                    <div class="form-group">
                        <label>환경구분</label>
                        <select id="submitEnvType">
                            <option value="">선택</option>
                            <option value="테스트">테스트</option>
                            <option value="운영">운영</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>단계구분</label>
                        <select id="submitStageType">
                            <option value="">선택</option>
                            <option value="개발">개발</option>
                            <option value="테스트">테스트</option>
                            <option value="배포">배포</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>운영서버 적용일자(예정)</label>
                        <input type="datetime-local" id="submitProdScheduledDate" />
                    </div>
                    <div class="form-group">
                        <label>작업내용</label>
                        <textarea id="submitWorkContent" placeholder="작업내용을 입력하세요 (미입력 시 변경사유가 사용됩니다)"></textarea>
                    </div>
                    <div style="text-align:right;margin-top:20px">
                        <button type="button" class="btn btn-primary" id="submitBtn">제출</button>
                        <button type="button" class="btn" id="submitCancelBtn">취소</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 승인 모달 -->
        <div id="approveModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>승인</h3>
                    <span class="modal-close" id="approveModalClose">&times;</span>
                </div>
                <form id="approveForm">
                    <input type="hidden" id="approveId" />
                    <div class="form-group">
                        <label>테스트 적용일자</label>
                        <input type="datetime-local" id="approveTestApplyDate" />
                    </div>
                    <div class="form-group">
                        <label>운영 적용일자</label>
                        <input type="datetime-local" id="approveProdApplyDate" />
                    </div>
                    <div style="text-align:right;margin-top:20px">
                        <button type="button" class="btn btn-success" id="approveBtn">승인</button>
                        <button type="button" class="btn" id="approveCancelBtn">취소</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 반려 모달 -->
        <div id="rejectModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>반려</h3>
                    <span class="modal-close" id="rejectModalClose">&times;</span>
                </div>
                <form id="rejectForm">
                    <input type="hidden" id="rejectId" />
                    <div class="form-group">
                        <label>반려이유</label>
                        <textarea id="rejectReason" required></textarea>
                    </div>
                    <div style="text-align:right;margin-top:20px">
                        <button type="button" class="btn btn-danger" id="rejectBtn">반려</button>
                        <button type="button" class="btn" id="rejectCancelBtn">취소</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 상세보기 모달 -->
        <div id="detailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>작업 상세 내용</h3>
                    <span class="modal-close" id="detailModalClose">&times;</span>
                </div>
                <div id="detailContent"></div>
                <hr style="border:0;border-top:1px solid #eee;margin:20px 0" />
                <div id="detailFooter" style="display:flex;gap:10px;justify-content:flex-end;padding-top:10px">
                    <button type="button" class="btn btn-success" id="detailApproveBtn">승인</button>
                    <button type="button" class="btn btn-danger" id="detailRejectBtn">반려</button>
                    <button type="button" class="btn" id="detailCancelBtn">취소</button>
                </div>
                <input type="hidden" id="detailId" />
            </div>
        </div>
    </main>

    <script>
        const EFFECTIVE_BASE = window.location.origin + '/server';

        // 로그아웃
        document.getElementById('nav-logout').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('login-id');
            alert('로그아웃되었습니다.');
            window.location.href = 'login.html';
        });

        const searchInput = document.getElementById('searchInput');
        const filterStatus = document.getElementById('filterStatus');
        const filterEnvType = document.getElementById('filterEnvType');
        const filterStageType = document.getElementById('filterStageType');
        const searchBtn = document.getElementById('searchBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const historyBody = document.getElementById('historyBody');

        // 검색
        searchBtn.addEventListener('click', loadHistory);
        refreshBtn.addEventListener('click', () => {
            searchInput.value = '';
            filterStatus.value = '전체';
            filterEnvType.value = '전체';
            filterStageType.value = '전체';
            loadHistory();
        });

        // 모달 닫기
        document.getElementById('submitModalClose').addEventListener('click', () => {
            document.getElementById('submitModal').style.display = 'none';
        });
        document.getElementById('approveModalClose').addEventListener('click', () => {
            document.getElementById('approveModal').style.display = 'none';
        });
        document.getElementById('rejectModalClose').addEventListener('click', () => {
            document.getElementById('rejectModal').style.display = 'none';
        });
        document.getElementById('detailModalClose').addEventListener('click', () => {
            document.getElementById('detailModal').style.display = 'none';
        });

        // 취소 버튼
        document.getElementById('submitCancelBtn').addEventListener('click', () => {
            document.getElementById('submitModal').style.display = 'none';
        });
        document.getElementById('approveCancelBtn').addEventListener('click', () => {
            document.getElementById('approveModal').style.display = 'none';
        });
        document.getElementById('rejectCancelBtn').addEventListener('click', () => {
            document.getElementById('rejectModal').style.display = 'none';
        });
        document.getElementById('detailCancelBtn').addEventListener('click', () => {
            document.getElementById('detailModal').style.display = 'none';
        });

        // 모달 외부 클릭 시 닫기
        window.addEventListener('click', (e) => {
            const modals = ['submitModal', 'approveModal', 'rejectModal', 'detailModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        function formatDateTime(val) {
            if (!val) return '';
            try {
                const d = new Date(val);
                if (isNaN(d)) return String(val);
                const pad = (n) => String(n).padStart(2, '0');
                return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
            } catch (e) {
                return String(val);
            }
        }

        function formatDateForInput(val) {
            if (!val) return '';
            try {
                const d = new Date(val);
                if (isNaN(d)) return '';
                const pad = (n) => String(n).padStart(2, '0');
                return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            } catch (e) {
                return '';
            }
        }

        function getStatusBadge(status) {
            const badges = {
                '대기중': '<span class="status-badge status-waiting">대기중</span>',
                '제출됨': '<span class="status-badge status-submitted">제출됨</span>',
                '승인됨': '<span class="status-badge status-approved">승인됨</span>',
                '반려됨': '<span class="status-badge status-rejected">반려됨</span>'
            };
            return badges[status] || status;
        }

        function getReviewResult(row) {
            // approved_date가 있으면 승인
            if (row.approved_date) {
                return '<span class="status-badge status-approved">승인</span>';
            }
            // rejected_date가 있으면 반려
            if (row.rejected_date) {
                return '<span class="status-badge status-rejected">반려</span>';
            }
            // 둘 다 없으면 대기 (클릭 가능한 버튼)
            return '<button class="btn btn-warning" onclick="viewDetail(' + row.id + ')" style="font-size:12px;padding:4px 8px;cursor:pointer">대기</button>';
        }

        function generateGitHubUrls(repoName, programName) {
            if (!repoName || !programName) {
                return '<span style="color:#999">URL 없음</span>';
            }
            
            // repo_name 형식: 'hhryong-hotmail/loandoc'
            const baseUrl = `https://github.com/${repoName}/blob/main`;
            const files = programName.split(',').map(f => f.trim()).filter(f => f && f !== 'N/A');
            
            if (files.length === 0) {
                return '<span style="color:#999">URL 없음</span>';
            }
            
            // 첫 번째 파일의 URL 생성
            let firstFile = files[0];
            
            // 절대 경로로 시작하는 경우 앞의 '/' 제거
            if (firstFile.startsWith('/')) {
                firstFile = firstFile.substring(1);
            }
            
            // 파일 경로를 URL 인코딩 (각 세그먼트를 개별적으로 인코딩하여 경로 구조 유지)
            const pathSegments = firstFile.split('/').map(segment => encodeURIComponent(segment));
            const encodedPath = pathSegments.join('/');
            const fileUrl = `${baseUrl}/${encodedPath}`;
            
            let urlHtml = `<a href="${fileUrl}" target="_blank" style="color:#2d6cdf;text-decoration:underline">${escapeHtml(firstFile)}</a>`;
            
            // 여러 파일이 있는 경우 추가 표시
            if (files.length > 1) {
                urlHtml += ` <span style="color:#666;font-size:0.9em">외 ${files.length - 1}개 파일</span>`;
            }
            
            return urlHtml;
        }

        function escapeHtml(s) {
            return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
        }

        async function loadHistory() {
            const q = encodeURIComponent(searchInput.value || '');
            const status = filterStatus.value || '전체';
            const envType = filterEnvType.value || '전체';
            const stageType = filterStageType.value || '전체';
            let url = `${EFFECTIVE_BASE}/api/config_management?q=${q}`;
            if (status !== '전체') url += `&status=${encodeURIComponent(status)}`;
            if (envType !== '전체') url += `&env_type=${encodeURIComponent(envType)}`;
            if (stageType !== '전체') url += `&stage_type=${encodeURIComponent(stageType)}`;

            try {
                const r = await fetch(url);
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'load failed');
                renderHistory(j.rows || []);
            } catch (e) {
                alert('목록 불러오기 실패: ' + e.message);
            }
        }

        function renderHistory(rows) {
            historyBody.innerHTML = '';
            if (!rows || rows.length === 0) {
                historyBody.innerHTML = `<tr><td colspan="13" style="padding:12px;text-align:center;color:#666">등록된 변경이력이 없습니다.</td></tr>`;
                return;
            }
            for (const r of rows) {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.addEventListener('click', (e) => {
                    // 버튼 클릭이 아닌 경우에만 팝업 열기
                    if (e.target.tagName !== 'BUTTON' && !e.target.closest('button')) {
                        viewDetail(r.id);
                    }
                });
                // 승인/반려 내용 결정
                let approvalRejectContent = '';
                if (r.approved_date && r.approved_date.trim() !== '') {
                    // 승인된 경우
                    approvalRejectContent = r.approval_reason || '';
                } else if (r.rejected_date && r.rejected_date.trim() !== '') {
                    // 반려된 경우
                    approvalRejectContent = r.rejection_reason || '';
                }
                
                tr.innerHTML = `
                    <td>${r.id}</td>
                    <td>${formatDateTime(r.change_datetime)}</td>
                    <td>${escapeHtml(r.developer_name || '')}</td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escapeHtml(r.program_name || '')}">${escapeHtml(r.program_name || '')}</td>
                    <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escapeHtml(r.change_reason || '')}">${escapeHtml(r.change_reason || '')}</td>
                    <td>${getStatusBadge(r.status)}</td>
                    <td>${escapeHtml(r.env_type || '')}</td>
                    <td>${escapeHtml(r.stage_type || '')}</td>
                    <td>${escapeHtml(r.approval_number || '')}</td>
                    <td>${escapeHtml(r.approver || '')}</td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escapeHtml(r.work_content || '')}">${escapeHtml(r.work_content || '')}</td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escapeHtml(approvalRejectContent)}">${escapeHtml(approvalRejectContent)}</td>
                    <td>${getReviewResult(r)}</td>
                `;
                historyBody.appendChild(tr);
            }
        }

        async function viewDetail(id) {
            try {
                const r = await fetch(`${EFFECTIVE_BASE}/api/config_management/${id}`);
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'failed');
                const row = j.row;

                const detailHtml = `
                    <div style="line-height:1.8">
                        <p style="font-size:1.2em;font-weight:bold;color:#2d6cdf;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #eee">
                            <strong>담당자:</strong> ${escapeHtml(row.approver || '미지정')}
                        </p>
                        <p><strong>ID:</strong> ${row.id}</p>
                        <p><strong>데이터베이스:</strong> ${escapeHtml(row.database_name || '')}</p>
                        <p><strong>저장소:</strong> ${escapeHtml(row.repo_name || '')}</p>
                        <p><strong>변경일시:</strong> ${formatDateTime(row.change_datetime)}</p>
                        <p><strong>개발자:</strong> ${escapeHtml(row.developer_name || '')}</p>
                        <p><strong>프로그램명:</strong> ${escapeHtml(row.program_name || '')}</p>
                        <p><strong>변경사유:</strong> ${escapeHtml(row.change_reason || '')}</p>
                        <p><strong>중요 코드 내용:</strong> ${escapeHtml(row.important_code_content || '')}</p>
                        <p><strong>관련 URL:</strong> ${generateGitHubUrls(row.repo_name, row.program_name)}</p>
                        <p><strong>상태:</strong> ${getStatusBadge(row.status)}</p>
                        <p><strong>결재번호:</strong> ${escapeHtml(row.approval_number || '')}</p>
                        <p><strong>작업내용:</strong> ${escapeHtml(row.work_content || '')}</p>
                        <p><strong>적용서버:</strong> ${escapeHtml(row.target_server || '')}</p>
                        <p><strong>환경구분:</strong> ${escapeHtml(row.env_type || '')}</p>
                        <p><strong>단계구분:</strong> ${escapeHtml(row.stage_type || '')}</p>
                        <p><strong>테스트 적용일자:</strong> ${formatDateTime(row.test_apply_date)}</p>
                        <p><strong>운영 적용일자:</strong> ${formatDateTime(row.prod_apply_date)}</p>
                        <p><strong>제출일자:</strong> ${formatDateTime(row.submitted_date)}</p>
                        <p><strong>승인일자:</strong> ${formatDateTime(row.approved_date)}</p>
                        <p><strong>승인사유 및 조건:</strong> ${escapeHtml(row.approval_reason || '')}</p>
                        <p><strong>반려일자:</strong> ${formatDateTime(row.rejected_date)}</p>
                        <p><strong>반려이유:</strong> ${escapeHtml(row.rejection_reason || '')}</p>
                        <p><strong>운영서버 적용일자(예정):</strong> ${formatDateTime(row.prod_scheduled_date)}</p>
                    </div>
                `;
                document.getElementById('detailContent').innerHTML = detailHtml;
                document.getElementById('detailId').value = id;
                
                // 승인 또는 반려된 경우 버튼 숨기기
                const approveBtn = document.getElementById('detailApproveBtn');
                const rejectBtn = document.getElementById('detailRejectBtn');
                const isApproved = row.approved_date && row.approved_date.trim() !== '';
                const isRejected = row.rejected_date && row.rejected_date.trim() !== '';
                
                if (isApproved || isRejected) {
                    // 이미 승인되거나 반려된 경우 버튼 숨기기
                    approveBtn.style.display = 'none';
                    rejectBtn.style.display = 'none';
                } else {
                    // 대기 상태인 경우 버튼 표시
                    approveBtn.style.display = 'inline-block';
                    rejectBtn.style.display = 'inline-block';
                }
                
                document.getElementById('detailModal').style.display = 'block';
            } catch (e) {
                alert('상세 정보 불러오기 실패: ' + e.message);
            }
        }

        function openSubmitModal(id) {
            document.getElementById('submitId').value = id;
            // 결재번호는 서버에서 자동 생성되므로 미리보기만 표시
            const today = new Date();
            const dateStr = today.getFullYear() + 
                String(today.getMonth() + 1).padStart(2, '0') + 
                String(today.getDate()).padStart(2, '0');
            document.getElementById('submitApprovalNumber').value = dateStr + '-001 (자동 생성)';
            document.getElementById('submitTargetServer').value = '';
            document.getElementById('submitEnvType').value = '';
            document.getElementById('submitStageType').value = '';
            document.getElementById('submitProdScheduledDate').value = '';
            document.getElementById('submitWorkContent').value = '';
            document.getElementById('submitModal').style.display = 'block';
        }

        document.getElementById('submitBtn').addEventListener('click', async () => {
            const id = document.getElementById('submitId').value;
            const targetServer = document.getElementById('submitTargetServer').value;
            const envType = document.getElementById('submitEnvType').value;
            const stageType = document.getElementById('submitStageType').value;
            const prodScheduledDate = document.getElementById('submitProdScheduledDate').value;
            const workContent = document.getElementById('submitWorkContent').value;

            try {
                const data = {
                    action: 'submit',
                    id: parseInt(id),
                    target_server: targetServer,
                    env_type: envType,
                    stage_type: stageType,
                    prod_scheduled_date: prodScheduledDate ? new Date(prodScheduledDate).toISOString() : null,
                    work_content: workContent
                };
                const r = await fetch(`${EFFECTIVE_BASE}/api/config_management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'submit failed');
                const approvalNumber = j.approval_number || '';
                alert((j.message || '제출되었습니다.') + (approvalNumber ? '\n결재번호: ' + approvalNumber : ''));
                document.getElementById('submitModal').style.display = 'none';
                loadHistory();
            } catch (e) {
                alert('제출 실패: ' + e.message);
            }
        });

        function openApproveModal(id) {
            document.getElementById('approveId').value = id;
            document.getElementById('approveTestApplyDate').value = '';
            document.getElementById('approveProdApplyDate').value = '';
            document.getElementById('approveModal').style.display = 'block';
        }

        document.getElementById('approveBtn').addEventListener('click', async () => {
            const id = document.getElementById('approveId').value;
            const testApplyDate = document.getElementById('approveTestApplyDate').value;
            const prodApplyDate = document.getElementById('approveProdApplyDate').value;

            // 현재 날짜와 시간을 YYYY-MM-DD HH:MM 형식으로 생성
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const approvedDateTime = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;

            try {
                const data = {
                    action: 'approve',
                    id: parseInt(id),
                    approved_date: approvedDateTime,
                    test_apply_date: testApplyDate ? new Date(testApplyDate).toISOString() : null,
                    prod_apply_date: prodApplyDate ? new Date(prodApplyDate).toISOString() : null
                };
                const r = await fetch(`${EFFECTIVE_BASE}/api/config_management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'approve failed');
                alert(j.message || '승인되었습니다.');
                document.getElementById('approveModal').style.display = 'none';
                loadHistory();
            } catch (e) {
                alert('승인 실패: ' + e.message);
            }
        });

        function openRejectModal(id) {
            document.getElementById('rejectId').value = id;
            document.getElementById('rejectReason').value = '';
            document.getElementById('rejectModal').style.display = 'block';
        }

        document.getElementById('rejectBtn').addEventListener('click', async () => {
            const id = document.getElementById('rejectId').value;
            const rejectionReason = document.getElementById('rejectReason').value;

            if (!rejectionReason) {
                alert('반려이유를 입력하세요.');
                return;
            }

            // 현재 날짜와 시간을 YYYY-MM-DD HH:MM 형식으로 생성
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const rejectedDateTime = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;

            try {
                const data = {
                    action: 'reject',
                    id: parseInt(id),
                    rejected_date: rejectedDateTime,
                    rejection_reason: rejectionReason
                };
                const r = await fetch(`${EFFECTIVE_BASE}/api/config_management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'reject failed');
                alert(j.message || '반려되었습니다.');
                document.getElementById('rejectModal').style.display = 'none';
                loadHistory();
            } catch (e) {
                alert('반려 실패: ' + e.message);
            }
        });

        // 상세보기 모달의 승인 버튼
        document.getElementById('detailApproveBtn').addEventListener('click', async () => {
            const id = document.getElementById('detailId').value;
            if (!confirm('승인하시겠습니까?')) {
                return;
            }

            // 승인사유 및 조건 입력받기
            const approvalReason = prompt('승인사유 및 조건을 입력하세요:');
            if (approvalReason === null) {
                // 취소 버튼을 누른 경우
                return;
            }

            // 현재 날짜와 시간을 YYYY-MM-DD HH:MM 형식으로 생성
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const approvedDateTime = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;

            try {
                const data = {
                    action: 'approve',
                    id: parseInt(id),
                    approved_date: approvedDateTime,
                    approval_reason: approvalReason || '',
                    test_apply_date: null,
                    prod_apply_date: null
                };
                const r = await fetch(`${EFFECTIVE_BASE}/api/config_management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'approve failed');
                alert(j.message || '승인되었습니다.');
                document.getElementById('detailModal').style.display = 'none';
                loadHistory();
            } catch (e) {
                alert('승인 실패: ' + e.message);
            }
        });

        // 상세보기 모달의 반려 버튼
        document.getElementById('detailRejectBtn').addEventListener('click', async () => {
            const id = document.getElementById('detailId').value;
            const rejectionReason = prompt('반려사항을 입력하세요:');
            
            if (!rejectionReason || rejectionReason.trim() === '') {
                alert('반려사항을 입력해야 합니다.');
                return;
            }

            if (!confirm('반려사항: ' + rejectionReason + '\n\n반려하시겠습니까?')) {
                return;
            }

            // 현재 날짜와 시간을 YYYY-MM-DD HH:MM 형식으로 생성
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const rejectedDateTime = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;

            try {
                const data = {
                    action: 'reject',
                    id: parseInt(id),
                    rejected_date: rejectedDateTime,
                    rejection_reason: rejectionReason
                };
                const r = await fetch(`${EFFECTIVE_BASE}/api/config_management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const j = await r.json();
                if (!j.ok) throw new Error(j.error || 'reject failed');
                alert(j.message || '반려되었습니다.');
                document.getElementById('detailModal').style.display = 'none';
                loadHistory();
            } catch (e) {
                alert('반려 실패: ' + e.message);
            }
        });

        // 페이지 로드 시 목록 불러오기
        loadHistory();
    </script>
</body>
</html>


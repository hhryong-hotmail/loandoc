<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LOANDOC - 로그인</title>
    <style>
        body{font-family:Arial,Helvetica,sans-serif;background:#f6f6f6;margin:0}
        header{background:#2d6cdf;color:#fff;padding:20px;text-align:center}
        main{max-width:420px;margin:60px auto;background:#fff;padding:28px;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.08)}
        label{display:block;margin-bottom:6px;font-weight:600}
        input{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-bottom:12px}
        button{background:#2d6cdf;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer}
        .button-group{display:flex;gap:12px;align-items:center}
        .signup-btn{background:#28a745;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;text-decoration:none;display:inline-block;text-align:center}
        .muted{color:#666;font-size:0.9em;margin-top:10px}
    /* Top navigation: center items */
    nav{display:flex;justify-content:center;gap:20px;padding:12px 0;background:#fff;align-items:center}
    nav a{color:#2d6cdf;text-decoration:none;font-weight:600;padding:6px 8px}
    /* Action buttons (yellow background, black text) */
    .nav-button{background:#FFD400;color:#000;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;text-decoration:none;font-weight:700}
    </style>
</head>
<body>
    <header>
        <h1>외국인 근로자 대출 연계 포털</h1>
        <p>로그인 (Login)</p>
    </header>
    <nav>
        <a class="nav-button" href="index.html">로그인</a>
        <a class="nav-button" href="signup.html">회원가입</a>
        <a class="nav-button" href="workerInfo.html">정보조회</a>
        <a class="nav-button" href="loanAppl.html">대출신청</a>
    </nav>
    <main>
        <h2>로그인</h2>
        <div>
            <label for="loginId">아이디</label>
            <input id="loginId" type="text" placeholder="아이디 입력" />
            <label for="loginPwd">비밀번호</label>
            <input id="loginPwd" type="password" placeholder="비밀번호 입력" />
            <div class="button-group">
                <button id="loginBtn">로그인</button>
                <a href="signup.html" class="signup-btn">회원가입</a>
            </div>
            <div id="loginMsg" class="muted">테스트: 회원가입을 통해 로컬에 생성된 계정으로 로그인합니다.</div>
        </div>
    </main>
    <script>
        function loadUsers(){ return JSON.parse(localStorage.getItem('users')||'[]'); }
        document.getElementById('loginBtn').addEventListener('click', async ()=>{
            const id = (document.getElementById('loginId').value||'').trim();
            const pwd = (document.getElementById('loginPwd').value||'').trim();
            const msg = document.getElementById('loginMsg');
            msg.style.color = 'black';
            msg.textContent = '로그인 중...';
            try {
                const res = await fetch('/api/login', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, password: pwd })
                });
                if (res.ok) {
                    // 로그인 성공 시 사용자 ID 저장
                    try {                         
                        localStorage.setItem('loggedInUser', id);  // 로그인한 사용자 ID 저장
                        localStorage.setItem('lastRegisteredId', id);                                
                    } catch(e) {
                        console.error('로컬 스토리지 저장 오류:', e);
                    }
                    
                    msg.textContent = '로그인 성공 — 개인정보 화면으로 이동합니다.'; 
                    msg.style.color = 'green';
                    
                    // 로그인 성공 시 알림 표시
                    alert('로그인 성공!\n아이디: ' + id);
                    // 짧은 지연 후 workerInfo.html로 이동
                    setTimeout(() => { 
                        window.location.href = 'workerInfo.html'; 
                    }, 800);
                    return;
                }
                const status = res.status;
                let j = {};
                try { j = await res.json(); } catch(e){}
                if (status === 404 || (j && j.error === 'no_user')) {
                    msg.textContent = '아이디가 없습니다. 회원가입을 하세요.'; msg.style.color='red';
                } else if (status === 401 || (j && j.error === 'invalid_credentials')) {
                    msg.textContent = '아이디/비밀번호 오류'; msg.style.color='red';
                } else {
                    msg.textContent = j.error || ('서버 오류: ' + status); msg.style.color='red';
                }
            } catch (err) {
                console.error('login fetch failed', err);
                msg.textContent = '서버 연결 실패'; msg.style.color='red';
            }
        });

        // If user just registered, prefill loginId
        (function prefill(){
            const last = localStorage.getItem('lastRegisteredId');
            if(last){ document.getElementById('loginId').value = last; document.getElementById('loginMsg').textContent = '회원가입 완료 — 아이디가 자동 입력되었습니다.'; document.getElementById('loginMsg').style.color='green'; localStorage.removeItem('lastRegisteredId'); }
        })();
    </script>
